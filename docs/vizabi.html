<!DOCTYPE html>

<html>
<head>
  <title>vizabi.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>vizabi.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="string">"use strict"</span>;

<span class="keyword">var</span> gapminder = {
    windowResize: {},
    data: {
        entities: [],
        indicators: {},
        indicatorsDataInfo: {}
    },
    dataCube: {},
    vizabiApp: {},
    bubbleChartModel: {},
    bubbleChartView: {},
    timeSliderController: {},
    guiUtils: {},
    viz: {}
};

gapminder.guiUtils = {
    divIds: {
        labelForYear: <span class="literal">undefined</span>,
        slider: <span class="literal">undefined</span>,
        trails: <span class="literal">undefined</span>,
        playImage: <span class="literal">undefined</span>
    },
    initializeLayers: <span class="function"><span class="keyword">function</span><span class="params">(renderDiv, changeCallback, model)</span> {</span>
        $(<span class="string">"&lt;div&gt;"</span>, {
            id: <span class="string">"container-"</span> + renderDiv,
            style: <span class="string">"margin:30px;"</span>,
            height: $(window).height() * <span class="number">.8</span>,
            width: $(window).width() * <span class="number">.95</span>
        }).appendTo(<span class="string">"body"</span>);
        $(<span class="string">"&lt;div&gt;"</span>, {
            id: renderDiv,
            style: <span class="string">"position:relative;"</span>
        }).appendTo(<span class="string">"#container-"</span> + renderDiv);
        <span class="keyword">var</span> settingsButton = <span class="keyword">new</span> gapminder.guiUtils.settingsButton(changeCallback, model);
        settingsButton.initialize(renderDiv);
        gapminder.guiUtils.set(<span class="string">"labelForYear"</span>, <span class="string">"label-year-"</span> + renderDiv);
        $(<span class="string">"&lt;div&gt;"</span>, {
            id: gapminder.guiUtils.get(<span class="string">"labelForYear"</span>),
            text: <span class="string">"Year"</span>,
            <span class="string">"class"</span>: <span class="string">"label-year"</span>,
            style: <span class="string">"display: inline-block;"</span>
        }).appendTo(<span class="string">"#"</span> + renderDiv);
        $(<span class="string">"&lt;div&gt;"</span>, {
            id: <span class="string">"alignButtons"</span>,
            style: <span class="string">"display: inline-block;width100px;height:20px"</span>
        }).appendTo(<span class="string">"#"</span> + renderDiv);
        $(<span class="string">"&lt;input&gt;"</span>, {
            id: <span class="string">"leftAlign"</span>,
            name: <span class="string">"setting"</span>,
            value: <span class="string">"leftAlign"</span>,
            type: <span class="string">"radio"</span>
        }).appendTo(<span class="string">"#alignButtons"</span>);
        <span class="keyword">var</span> leftLabel = $(<span class="string">"&lt;label&gt;"</span>, {
            <span class="string">"for"</span>: <span class="string">"leftAlign"</span>,
            style: <span class="string">"font-size:6px;"</span>
        }).appendTo(<span class="string">"#alignButtons"</span>);
        leftLabel.html(<span class="string">"LEFT"</span>);
        $(<span class="string">"&lt;input&gt;"</span>, {
            id: <span class="string">"midAlign"</span>,
            name: <span class="string">"setting"</span>,
            value: <span class="string">"midAlign"</span>,
            type: <span class="string">"radio"</span>
        }).appendTo(<span class="string">"#alignButtons"</span>);
        <span class="keyword">var</span> midLabel = $(<span class="string">"&lt;label&gt;"</span>, {
            <span class="string">"for"</span>: <span class="string">"midAlign"</span>,
            style: <span class="string">"font-size:6px;"</span>
        }).appendTo(<span class="string">"#alignButtons"</span>);
        midLabel.html(<span class="string">"CENTER"</span>);
        $(<span class="string">"&lt;input&gt;"</span>, {
            id: <span class="string">"rightAlign"</span>,
            name: <span class="string">"setting"</span>,
            value: <span class="string">"rightAlign"</span>,
            type: <span class="string">"radio"</span>
        }).appendTo(<span class="string">"#alignButtons"</span>);
        <span class="keyword">var</span> rightLabel = $(<span class="string">"&lt;label&gt;"</span>, {
            <span class="string">"for"</span>: <span class="string">"rightAlign"</span>,
            style: <span class="string">"font-size:6px;"</span>
        }).appendTo(<span class="string">"#alignButtons"</span>);
        rightLabel.html(<span class="string">"RIGHT"</span>);
        $(<span class="string">"#alignButtons"</span>).buttonset();
        $(<span class="string">"#alignButtons"</span>).hide();
    },
    createTrails: <span class="function"><span class="keyword">function</span><span class="params">(renderDiv)</span> {</span>
        gapminder.guiUtils.set(<span class="string">"trails"</span>, <span class="string">"trails-"</span> + renderDiv);
        $(<span class="string">"&lt;div&gt;"</span>, {
            id: gapminder.guiUtils.get(<span class="string">"trails"</span>)
        }).appendTo(<span class="string">"#"</span> + renderDiv);
        $(<span class="string">"&lt;input&gt;"</span>, {
            type: <span class="string">"checkbox"</span>,
            <span class="string">"class"</span>: <span class="string">"ui-trails"</span>
        }).appendTo(<span class="string">"#"</span> + gapminder.guiUtils.get(<span class="string">"trails"</span>));
        $(<span class="string">"&lt;label&gt;"</span>, {
            <span class="string">"class"</span>: <span class="string">"ui-trails"</span>,
            text: <span class="string">"Trails"</span>
        }).appendTo(<span class="string">"#"</span> + gapminder.guiUtils.get(<span class="string">"trails"</span>));
    },
    createTimeSlider: <span class="function"><span class="keyword">function</span><span class="params">(renderDiv)</span> {</span>
        gapminder.guiUtils.set(<span class="string">"slider"</span>, <span class="string">"slider-"</span> + renderDiv);
        $(<span class="string">"&lt;div&gt;"</span>, {
            id: gapminder.guiUtils.get(<span class="string">"slider"</span>)
        }).appendTo(<span class="string">"#"</span> + renderDiv);
        $(<span class="string">"&lt;div&gt;"</span>, {
            <span class="string">"class"</span>: <span class="string">"G_widget_slider_play"</span>,
            style: <span class="string">"width:40px;float:left"</span>
        }).appendTo(<span class="string">"#"</span> + gapminder.guiUtils.get(<span class="string">"slider"</span>));
        gapminder.guiUtils.set(<span class="string">"playImage"</span>, <span class="string">"image-"</span> + renderDiv);
        $(<span class="string">"&lt;img&gt;"</span>, {
            <span class="string">"class"</span>: <span class="string">"play-button"</span>,
            src: <span class="string">"../../assets/img/bubble/play.png"</span>,
            position: <span class="string">"relative;top:-10px;"</span>
        }).appendTo(<span class="string">"#"</span> + gapminder.guiUtils.get(<span class="string">"slider"</span>) + <span class="string">" .G_widget_slider_play "</span>);
        $(<span class="string">"&lt;div&gt;"</span>, {
            <span class="string">"class"</span>: <span class="string">"G_widget_slider"</span>,
            style: <span class="string">"margin-left:50px"</span>
        }).appendTo(<span class="string">"#"</span> + gapminder.guiUtils.get(<span class="string">"slider"</span>));
        $(<span class="string">"&lt;div&gt;"</span>, {
            <span class="string">"class"</span>: <span class="string">"G_widget_slider_scale"</span>,
            style: <span class="string">"margin-left:50px;margin-top:10px;position:relative"</span>
        }).appendTo(<span class="string">"#"</span> + gapminder.guiUtils.get(<span class="string">"slider"</span>));
    },
    get: <span class="function"><span class="keyword">function</span><span class="params">(divName)</span> {</span>
        <span class="keyword">return</span> gapminder.guiUtils.divIds[divName];
    },
    set: <span class="function"><span class="keyword">function</span><span class="params">(divName, divId)</span> {</span>
        gapminder.guiUtils.divIds[divName] = divId;
    }
};

gapminder.guiUtils.settingsButton = <span class="function"><span class="keyword">function</span><span class="params">(changeCallback, model)</span> {</span>
    <span class="keyword">var</span> modelChangeCallback = changeCallback;
    <span class="keyword">var</span> isInteractive = model.get(<span class="string">"isInteractive"</span>);
    <span class="keyword">var</span> initialize = <span class="function"><span class="keyword">function</span><span class="params">(renderDiv)</span> {</span>
        $(<span class="string">"&lt;input&gt;"</span>, {
            id: <span class="string">"settingsButton"</span>,
            type: <span class="string">"button"</span>,
            style: <span class="string">"display:inline-block;width:20px"</span>
        }).appendTo(<span class="string">"#"</span> + renderDiv);
        $(<span class="string">"&lt;div&gt;"</span>, {
            id: <span class="string">"dialog-form"</span>
        }).appendTo(<span class="string">"#"</span> + renderDiv);
        $(<span class="string">"#dialog-form"</span>).dialog({
            title: <span class="string">"Vizabi Settings"</span>,
            autoOpen: <span class="literal">false</span>,
            height: <span class="number">300</span>,
            width: <span class="number">350</span>,
            position: {
                at: <span class="string">"right center"</span>
            }
        });
        <span class="keyword">var</span> LabelForFontRange = $(<span class="string">"&lt;label&gt;"</span>, {
            <span class="string">"for"</span>: <span class="string">"fontRangeValue"</span>
        }).appendTo(<span class="string">"#dialog-form"</span>);
        $(LabelForFontRange).text(<span class="string">"Bubble Label Font Size Range:"</span>);
        $(<span class="string">"&lt;input&gt;"</span>, {
            id: <span class="string">"fontRangeValue"</span>,
            type: <span class="string">"text"</span>
        }).appendTo(<span class="string">"#dialog-form"</span>);
        <span class="keyword">var</span> fontSlider = $(<span class="string">"&lt;div&gt;"</span>, {
            id: <span class="string">"font-slider"</span>,
            style: <span class="string">"margin-bottom: 12px; margin-top: 20px"</span>
        }).appendTo(<span class="string">"#dialog-form"</span>);
        <span class="keyword">var</span> fontValues = {};
        fontValues.min = model.get(<span class="string">"minFontSize"</span>) || <span class="number">7</span>;
        fontValues.max = model.get(<span class="string">"maxFontSize"</span>) || <span class="number">25</span>;
        $(fontSlider).slider({
            range: <span class="literal">true</span>,
            min: <span class="number">1</span>,
            max: <span class="number">50</span>,
            values: [ fontValues.min, fontValues.max ],
            slide: <span class="function"><span class="keyword">function</span><span class="params">(event, ui)</span> {</span>
                $(<span class="string">"#fontRangeValue"</span>).val(ui.values[<span class="number">0</span>] + <span class="string">"px"</span> + <span class="string">"-"</span> + ui.values[<span class="number">1</span>] + <span class="string">"px"</span>);
                modelChangeCallback({
                    minFontSize: ui.values[<span class="number">0</span>],
                    maxFontSize: ui.values[<span class="number">1</span>]
                });
            }
        });
        <span class="keyword">if</span> (isInteractive) {
            $(fontSlider).slider(<span class="string">"option"</span>, <span class="string">"disabled"</span>, <span class="literal">true</span>);
        }
        $(<span class="string">"#fontRangeValue"</span>).val($(<span class="string">"#font-slider"</span>).slider(<span class="string">"values"</span>, <span class="number">0</span>) + <span class="string">" px"</span> + <span class="string">" - "</span> + $(<span class="string">"#font-slider"</span>).slider(<span class="string">"values"</span>, <span class="number">1</span>) + <span class="string">" px"</span>);
        <span class="keyword">var</span> labelForSizeRange = $(<span class="string">"&lt;label&gt;"</span>, {
            <span class="string">"for"</span>: <span class="string">"rangeValue"</span>
        }).appendTo(<span class="string">"#dialog-form"</span>);
        $(labelForSizeRange).text(<span class="string">"Bubble Size Range:"</span>);
        $(<span class="string">"&lt;input&gt;"</span>, {
            id: <span class="string">"sizeRangeValue"</span>,
            type: <span class="string">"text"</span>
        }).appendTo(<span class="string">"#dialog-form"</span>);
        <span class="keyword">var</span> sizeSlider = $(<span class="string">"&lt;div&gt;"</span>, {
            id: <span class="string">"size-slider"</span>,
            style: <span class="string">"margin-bottom: 12px; margin-top: 20px"</span>
        }).appendTo(<span class="string">"#dialog-form"</span>);
        <span class="keyword">var</span> sizeValues = {};
        sizeValues.min = model.get(<span class="string">"minBubbleSize"</span>) || <span class="number">1</span>;
        sizeValues.max = model.get(<span class="string">"maxBubbleSize"</span>) || <span class="number">30</span>;
        $(sizeSlider).slider({
            range: <span class="literal">true</span>,
            min: <span class="number">0</span>,
            max: <span class="number">100</span>,
            values: [ sizeValues.min, sizeValues.max ],
            slide: <span class="function"><span class="keyword">function</span><span class="params">(event, ui)</span> {</span>
                $(<span class="string">"#sizeRangeValue"</span>).val(ui.values[<span class="number">0</span>] + <span class="string">" px - "</span> + ui.values[<span class="number">1</span>] + <span class="string">" - px"</span>);
                modelChangeCallback({
                    minBubbleSize: ui.values[<span class="number">0</span>],
                    maxBubbleSize: ui.values[<span class="number">1</span>]
                });
            }
        });
        $(<span class="string">"#sizeRangeValue"</span>).val($(<span class="string">"#size-slider"</span>).slider(<span class="string">"values"</span>, <span class="number">0</span>) + <span class="string">"px"</span> + <span class="string">" -"</span> + $(<span class="string">"#size-slider"</span>).slider(<span class="string">"values"</span>, <span class="number">1</span>) + <span class="string">"px"</span>);
        <span class="keyword">var</span> editModeSetting = $(<span class="string">"&lt;div&gt;"</span>, {
            id: <span class="string">"editModeSetting"</span>
        }).appendTo(<span class="string">"#dialog-form"</span>);
        $(<span class="string">"&lt;input&gt;"</span>, {
            id: <span class="string">"editMode"</span>,
            type: <span class="string">"radio"</span>,
            name: <span class="string">"edit"</span>,
            value: <span class="string">"editOn"</span>
        }).appendTo(editModeSetting);
        <span class="keyword">var</span> editLabel = $(<span class="string">"&lt;label&gt;"</span>, {
            <span class="string">"for"</span>: <span class="string">"editMode"</span>
        }).appendTo(editModeSetting);
        editLabel.html(<span class="string">"Edit Mode"</span>);
        $(<span class="string">"&lt;input&gt;"</span>, {
            id: <span class="string">"nonEditMode"</span>,
            type: <span class="string">"radio"</span>,
            name: <span class="string">"edit"</span>,
            value: <span class="string">"editOff"</span>
        }).appendTo(editModeSetting);
        <span class="keyword">var</span> nonEditLabel = $(<span class="string">"&lt;label&gt;"</span>, {
            <span class="string">"for"</span>: <span class="string">"nonEditMode"</span>
        }).appendTo(editModeSetting);
        nonEditLabel.html(<span class="string">"Locked Mode"</span>);
        <span class="keyword">var</span> isEditMode = model.get(<span class="string">"editMode"</span>);
        <span class="keyword">if</span> (isEditMode) {
            $(<span class="string">"#editMode"</span>).attr(<span class="string">"checked"</span>, <span class="string">"checked"</span>);
        } <span class="keyword">else</span> {
            $(<span class="string">"#nonEditMode"</span>).attr(<span class="string">"checked"</span>, <span class="string">"checked"</span>);
        }
        $(editModeSetting).buttonset();
        $(<span class="string">"#editModeSetting input[name='edit']"</span>).click(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
            <span class="keyword">if</span> ($(<span class="string">"input:radio[name=edit]:checked"</span>).val() === <span class="string">"editOn"</span>) {
                modelChangeCallback({
                    editMode: <span class="literal">true</span>
                });
            } <span class="keyword">else</span> {
                modelChangeCallback({
                    editMode: <span class="literal">false</span>
                });
            }
        });
        <span class="keyword">if</span> (isInteractive) {
            $(<span class="string">"#editModeSetting &gt; input:radio"</span>).button({
                disabled: <span class="literal">true</span>
            });
        }
        $(<span class="string">"#settingsButton"</span>).button().click(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
            $(<span class="string">"#dialog-form"</span>).dialog(<span class="string">"open"</span>);
        });
    };
    <span class="keyword">return</span> {
        initialize: initialize
    };
};

gapminder.timeSlider = <span class="function"><span class="keyword">function</span><span class="params">(callback)</span> {</span>
    <span class="keyword">var</span> sliderAttributes = {
        year: <span class="literal">undefined</span>,
        slider: <span class="string">""</span>,
        timeSliderDiv: <span class="string">""</span>,
        sliderScale: <span class="literal">undefined</span>
    };
    <span class="keyword">var</span> timeSliderState;
    <span class="keyword">var</span> playButton;
    <span class="keyword">var</span> timer;
    <span class="keyword">var</span> playing;
    <span class="keyword">var</span> sliderStateChangeCallback = callback;
    <span class="keyword">var</span> initialize = <span class="function"><span class="keyword">function</span><span class="params">(state)</span> {</span>
        timeSliderState = state;
        sliderAttributes.timeSliderDiv = $(<span class="string">".G_widget_slider"</span>, <span class="string">"#"</span> + gapminder.guiUtils.get(<span class="string">"slider"</span>));
        sliderAttributes.sliderScale = $(<span class="string">".G_widget_slider_scale "</span>, <span class="string">"#"</span> + gapminder.guiUtils.get(<span class="string">"slider"</span>));
        playButton = $(<span class="string">".play-button"</span>, <span class="string">"#"</span> + gapminder.guiUtils.get(<span class="string">"slider"</span>));
        <span class="keyword">var</span> scaleWidth = sliderAttributes.sliderScale.width();
        <span class="keyword">var</span> scale = d3.scale.linear().domain([ timeSliderState.getDataHelper().getMinYear(), timeSliderState.getDataHelper().getMaxYear() ]).range([ <span class="number">0</span>, scaleWidth ]);
        <span class="keyword">var</span> labels = d3.select(sliderAttributes.sliderScale[<span class="number">0</span>]).selectAll(<span class="string">"div"</span>).data(scale.ticks(<span class="number">8</span>));
        labels.enter().append(<span class="string">"div"</span>).style(<span class="string">"font-family"</span>, <span class="string">"sans-serif"</span>).style(<span class="string">"font-size"</span>, <span class="string">"12px"</span>);
        labels.style(<span class="string">"left"</span>, <span class="function"><span class="keyword">function</span><span class="params">(d, i)</span> {</span>
            <span class="keyword">return</span> scale(d) - <span class="number">12</span> + <span class="string">"px"</span>;
        }).style(<span class="string">"position"</span>, <span class="string">"absolute"</span>).text(String);
        labels.exit().remove();
        sliderAttributes.slider = $(sliderAttributes.timeSliderDiv).slider({
            min: timeSliderState.getDataHelper().getMinYear(),
            max: timeSliderState.getDataHelper().getMaxYear(),
            step: <span class="number">.1</span>
        });
    };
    <span class="keyword">var</span> playHandler = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">if</span> (playing) {
            clearInterval(timer);
            playing = <span class="literal">false</span>;
            sliderStateChangeCallback({
                enableHistory: <span class="literal">true</span>
            });
            playButton.attr(<span class="string">"src"</span>, <span class="string">"../../assets/img/bubble/play.png"</span>);
        } <span class="keyword">else</span> {
            playButton.attr(<span class="string">"src"</span>, <span class="string">"../../assets/img/bubble/pause.png"</span>);
            timer = setInterval(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
                playingOnInterval();
            }, <span class="number">40</span>);
            playing = <span class="literal">true</span>;
        }
    };
    <span class="keyword">var</span> playingOnInterval = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> year = parseFloat(timeSliderState.get(<span class="string">"year"</span>));
        <span class="keyword">var</span> newYear = (year + parseFloat(timeSliderState.get(<span class="string">"speed"</span>))).toFixed(<span class="number">2</span>);
        <span class="keyword">var</span> hasNotReachEndOfSlider = newYear &lt;= timeSliderState.getDataHelper().getMaxYear();
        <span class="keyword">if</span> (hasNotReachEndOfSlider) {
            sliderStateChangeCallback({
                year: newYear,
                enableHistory: <span class="literal">false</span>,
                action: <span class="string">"year"</span>
            });
        } <span class="keyword">else</span> {
            stopHandler();
            sliderStateChangeCallback({
                year: Math.floor(newYear),
                enableHistory: <span class="literal">false</span>,
                action: <span class="string">"year"</span>
            });
        }
        sliderAttributes.slider = $(sliderAttributes.timeSliderDiv).slider({
            value: year
        });
    };
    <span class="keyword">var</span> stopHandler = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        clearInterval(timer);
        playing = <span class="literal">false</span>;
        timer = <span class="literal">undefined</span>;
        playButton.attr(<span class="string">"src"</span>, <span class="string">"../../assets/img/bubble/play.png"</span>);
    };
    <span class="keyword">var</span> setUpListenersForPlayAndSlideChangesEvents = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        setPlayButtonClickEvent();
        setSliderEvents();
    };
    <span class="keyword">var</span> setPlayButtonClickEvent = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        playButton.click(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
            playHandler();
        });
    };
    <span class="keyword">var</span> setSliderEvents = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        sliderAttributes.slider = $(sliderAttributes.timeSliderDiv).slider({
            slide: <span class="function"><span class="keyword">function</span><span class="params">(e, ui)</span> {</span>
                sliderStateChangeCallback({
                    year: ui.value,
                    enableHistory: <span class="literal">false</span>,
                    action: <span class="string">"year"</span>
                });
            },
            change: <span class="function"><span class="keyword">function</span><span class="params">(e, ui)</span> {</span>
                sliderChangeEventListener(e, ui);
            }
        });
    };
    <span class="keyword">var</span> sliderChangeEventListener = <span class="function"><span class="keyword">function</span><span class="params">(e, ui)</span> {</span>
        <span class="keyword">if</span> (<span class="string">"originalEvent"</span> <span class="keyword">in</span> e) {
            <span class="keyword">var</span> year = ui.value;
            <span class="keyword">var</span> prevYear = Math.floor(year);
            <span class="keyword">var</span> nextYear = Math.ceil(year);
            <span class="keyword">var</span> yearFraction = year - Math.floor(year);
            <span class="keyword">if</span> (yearFraction &lt; <span class="number">.5</span>) {
                sliderStateChangeCallback({
                    year: prevYear,
                    enableHistory: <span class="literal">true</span>,
                    action: <span class="string">"year"</span>
                });
            } <span class="keyword">else</span> {
                sliderStateChangeCallback({
                    year: nextYear,
                    enableHistory: <span class="literal">true</span>,
                    action: <span class="string">"year"</span>
                });
            }
        }
    };
    <span class="keyword">var</span> update = <span class="function"><span class="keyword">function</span><span class="params">(state)</span> {</span>
        timeSliderState = state;
        $(sliderAttributes.timeSliderDiv).slider({
            value: state.get(<span class="string">"year"</span>)
        });
    };
    <span class="keyword">return</span> {
        initialize: initialize,
        setupListeners: setUpListenersForPlayAndSlideChangesEvents,
        update: update
    };
};

gapminder.dataCube = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
    <span class="keyword">var</span> timeUnit;
    <span class="keyword">var</span> indicators = {};
    <span class="keyword">var</span> entityMeta = {};
    <span class="keyword">var</span> skeleton = {};
    <span class="keyword">var</span> dataHelperModel;
    <span class="keyword">var</span> loader;
    <span class="keyword">var</span> i18nHelper;
    <span class="keyword">var</span> regionsList = [];
    <span class="keyword">var</span> dataIsReadyCallback;
    <span class="keyword">var</span> initialize = <span class="function"><span class="keyword">function</span><span class="params">(options, callback)</span> {</span>
        loader = gapminder.dataCube.loaderFacotry(options.dataFormat);
        i18nHelper = <span class="keyword">new</span> gapminder.data.i18nHelper();
        loadSkeleton(options.dataPath, <span class="function"><span class="keyword">function</span><span class="params">(skeletonObj)</span> {</span>
            skeleton = skeletonObj;
            callback(skeleton);
        }, options.fileName, options.entity);
    };
    <span class="keyword">var</span> dataIsReady = <span class="function"><span class="keyword">function</span><span class="params">(skeletonObj, indicatorsObj, entitiesObj, chartInfo, regions, timeUnitVal)</span> {</span>
        skeleton = $.extend(<span class="literal">true</span>, skeleton, skeletonObj);
        indicators = $.extend(<span class="literal">true</span>, indicators, indicatorsObj);
        entityMeta = $.extend(<span class="literal">true</span>, entityMeta, entitiesObj);
        timeUnit = timeUnitVal;
        <span class="keyword">if</span> (regions) {
            regionsList = regions;
        }
        interpolateDataValues();
        dataIsReadyCallback(entityMeta, indicators, chartInfo, regions, timeUnit);
    };
    <span class="keyword">var</span> loadSkeleton = <span class="function"><span class="keyword">function</span><span class="params">(dataPath, loadCallback, fileName, entity)</span> {</span>
        skeleton = loader.loadSkeleton(dataPath, <span class="function"><span class="keyword">function</span><span class="params">(skeletonObj)</span> {</span>
            skeleton = skeletonObj;
            loadCallback(skeleton);
        }, fileName, entity);
    };
    <span class="keyword">var</span> loadNestedData = <span class="function"><span class="keyword">function</span><span class="params">(model, changedState, callback, indicatorsToLoad)</span> {</span>
        <span class="keyword">var</span> dataPath = changedState.dataPath || model.get(<span class="string">"dataPath"</span>);
        <span class="keyword">var</span> entity = changedState.entity || model.get(<span class="string">"entity"</span>);
        <span class="keyword">var</span> fileName = model.get(<span class="string">"fileName"</span>);
        <span class="keyword">var</span> language = changedState.language;
        <span class="keyword">var</span> category = model.get(<span class="string">"category"</span>);
        dataHelperModel = model;
        dataIsReadyCallback = callback;
        createNestedObjectTemplate(indicatorsToLoad);
        <span class="keyword">if</span> (!$.isEmptyObject(indicatorsToLoad)) {
            loader.initialize(indicators, model, dataPath, indicatorsToLoad, dataIsReady, changedState, language, fileName);
            loader.loadCategory(indicatorsToLoad);
            loader.loadIndicators(indicatorsToLoad);
        } <span class="keyword">else</span> {
            dataIsReadyCallback();
        }
    };
    <span class="keyword">var</span> createNestedObjectTemplate = <span class="function"><span class="keyword">function</span><span class="params">(indicatorsToLoad)</span> {</span>
        <span class="keyword">var</span> defaultTimeUnit = <span class="string">"yearly"</span>;
        <span class="keyword">for</span> (<span class="keyword">var</span> entity <span class="keyword">in</span> indicatorsToLoad) {
            <span class="keyword">if</span> (indicatorsToLoad.hasOwnProperty(entity)) {
                <span class="keyword">if</span> (!indicators.hasOwnProperty(defaultTimeUnit)) {
                    indicators[defaultTimeUnit] = {};
                }
                <span class="keyword">if</span> (!indicators[defaultTimeUnit].hasOwnProperty(defaultTimeUnit)) {
                    indicators[defaultTimeUnit][entity] = {};
                }
                <span class="keyword">for</span> (<span class="keyword">var</span> indicator <span class="keyword">in</span> indicatorsToLoad[entity]) {
                    <span class="keyword">if</span> (indicatorsToLoad[entity].hasOwnProperty(indicator)) {
                        <span class="keyword">var</span> indicatorName = indicatorsToLoad[entity][indicator];
                        indicators[defaultTimeUnit][entity][indicatorName] = {};
                        indicators[defaultTimeUnit][entity][indicatorName][<span class="string">"info"</span>] = {};
                        indicators[defaultTimeUnit][entity][indicatorName][<span class="string">"years"</span>] = {};
                        indicators[defaultTimeUnit][entity][indicatorName][<span class="string">"scope"</span>] = {};
                        indicators[defaultTimeUnit][entity][indicatorName][<span class="string">"scope"</span>][<span class="string">"time"</span>] = {};
                        indicators[defaultTimeUnit][entity][indicatorName][<span class="string">"scope"</span>][<span class="string">"value"</span>] = {};
                    }
                }
            }
        }
    };
    <span class="keyword">var</span> languageUpdated = <span class="function"><span class="keyword">function</span><span class="params">(entitiesMetaObj, language)</span> {</span>
        entityMeta = $.extend(<span class="literal">true</span>, entityMeta, entitiesMetaObj);
        console.log(<span class="string">"%cUpdating Bubble Labels with Language Code "</span> + language + <span class="string">"..."</span>, <span class="string">"color: #bada55"</span>);
        dataIsReadyCallback(entityMeta, indicators);
    };
    <span class="keyword">var</span> interpolateDataValues = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">for</span> (<span class="keyword">var</span> category <span class="keyword">in</span> indicators[timeUnit]) {
            <span class="keyword">if</span> (indicators[timeUnit].hasOwnProperty(category)) {
                <span class="keyword">for</span> (<span class="keyword">var</span> indicatorName <span class="keyword">in</span> indicators[timeUnit][category]) {
                    <span class="keyword">if</span> (indicators[timeUnit][category].hasOwnProperty(indicatorName)) {
                        <span class="keyword">for</span> (<span class="keyword">var</span> countryName <span class="keyword">in</span> indicators[timeUnit][category][indicatorName][<span class="string">"years"</span>]) {
                            <span class="keyword">if</span> (indicators[timeUnit][category][indicatorName][<span class="string">"years"</span>].hasOwnProperty(countryName)) {
                                <span class="keyword">var</span> curEntityIndiValue = indicators[timeUnit][category][indicatorName][<span class="string">"years"</span>][countryName][<span class="string">"trends"</span>];
                                <span class="keyword">var</span> yearData = [];
                                <span class="keyword">var</span> yearValue = [];
                                <span class="keyword">for</span> (<span class="keyword">var</span> year <span class="keyword">in</span> curEntityIndiValue) {
                                    <span class="keyword">if</span> (curEntityIndiValue.hasOwnProperty(year)) {
                                        yearData.push(parseInt(year));
                                        yearValue.push(curEntityIndiValue[year].v);
                                    }
                                }
                                <span class="keyword">for</span> (<span class="keyword">var</span> s = <span class="number">0</span>; s &lt; yearData.length; s++) {
                                    <span class="keyword">for</span> (<span class="keyword">var</span> bb = yearData[s] + <span class="number">1</span>; bb &lt;= yearData[s + <span class="number">1</span>] - <span class="number">1</span>; bb++) {
                                        curEntityIndiValue[bb] = {};
                                        curEntityIndiValue[bb].n = [];
                                        curEntityIndiValue[bb].v = curEntityIndiValue[yearData[s]].v + (curEntityIndiValue[yearData[s + <span class="number">1</span>]].v - curEntityIndiValue[yearData[s]].v) * (bb - yearData[s]) / (yearData[s + <span class="number">1</span>] - yearData[s]);
                                    }
                                }
                                indicators[timeUnit][category][indicatorName][<span class="string">"years"</span>][countryName][<span class="string">"trends"</span>] = curEntityIndiValue;
                            }
                        }
                    }
                }
            }
        }
    };
    <span class="keyword">var</span> getNestedData = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">return</span> indicators;
    };
    <span class="keyword">var</span> getSkeleton = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">return</span> skeleton;
    };
    <span class="keyword">return</span> {
        initialize: initialize,
        loadNestedData: loadNestedData,
        getNestedData: getNestedData,
        loadSkeleton: loadSkeleton,
        getSkeleton: getSkeleton
    };
};

gapminder.data.i18nHelper = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
    <span class="keyword">var</span> updatedEntitiesReadyCallback;
    <span class="keyword">var</span> entityMeta;
    <span class="keyword">var</span> languageCode;
    <span class="keyword">var</span> updateLanguage = <span class="function"><span class="keyword">function</span><span class="params">(language, callback, model, indicatorsToLoad, entity)</span> {</span>
        languageCode = language;
        updatedEntitiesReadyCallback = callback;
        <span class="keyword">var</span> fakei18n = <span class="keyword">new</span> gapminder.fakeI18n();
        fakei18n.getCountryNames(language, setEntitiesFromi18n, callback, model, indicatorsToLoad, entity);
    };
    <span class="keyword">var</span> setEntitiesFromi18n = <span class="function"><span class="keyword">function</span><span class="params">(entitiesMetaObj, callback, model, indicatorsToLoad, entity)</span> {</span>
        entityMeta = entitiesMetaObj;
        updatedEntitiesReadyCallback(entitiesMetaObj, languageCode);
    };
    <span class="keyword">return</span> {
        updateLanguage: updateLanguage
    };
};

gapminder.data.readerMultiCSV = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
    <span class="keyword">var</span> datasetInfo;
    <span class="keyword">var</span> chartFooter = <span class="string">""</span>;
    <span class="keyword">var</span> indicators = {};
    <span class="keyword">var</span> readIsCompleteCallback;
    <span class="keyword">var</span> csvDataPath;
    <span class="keyword">var</span> entityMeta;
    <span class="keyword">var</span> dataIsReadyCallback;
    <span class="keyword">var</span> indicatorsToLoad;
    <span class="keyword">var</span> regions = [];
    <span class="keyword">var</span> timeUnit;
    <span class="keyword">var</span> entitiesData = [];
    <span class="keyword">var</span> skeleton = {
        indicators: [],
        categories: []
    };
    <span class="keyword">var</span> initialize = <span class="function"><span class="keyword">function</span><span class="params">(indicatorsTemplate, model, dataPath, indicatorsToLoadObj, dataReadyCallback, changedState, language)</span> {</span>
        readIsCompleteCallback = dataReadyCallback;
        csvDataPath = dataPath;
        indicatorsToLoad = indicatorsToLoadObj;
        dataIsReadyCallback = dataReadyCallback;
        indicators = indicatorsTemplate;
        <span class="keyword">if</span> (changedState.dataPath) {
            <span class="keyword">var</span> q = <span class="keyword">new</span> queue();
            q.defer(<span class="function"><span class="keyword">function</span><span class="params">(callback)</span> {</span>
                loadDataSetInfo(callback);
            }).defer(<span class="function"><span class="keyword">function</span><span class="params">(callback)</span> {</span>
                loadChartNotes(callback);
            }).await(dataSetInfoLoaded);
        }
    };
    <span class="keyword">var</span> loadDataSetInfo = <span class="function"><span class="keyword">function</span><span class="params">(callback)</span> {</span>
        d3.csv(csvDataPath + <span class="string">"dataset.csv"</span>, <span class="function"><span class="keyword">function</span><span class="params">(dataError, dataRows)</span> {</span>
            datasetInfo = dataRows[<span class="number">0</span>].info;
            callback();
        });
    };
    <span class="keyword">var</span> loadChartNotes = <span class="function"><span class="keyword">function</span><span class="params">(callback)</span> {</span>
        d3.csv(csvDataPath + <span class="string">"notes.csv"</span>, <span class="function"><span class="keyword">function</span><span class="params">(notesError, notesRows)</span> {</span>
            notesRows.map(<span class="function"><span class="keyword">function</span><span class="params">(noteRow)</span> {</span>
                chartFooter += noteRow.text + <span class="string">","</span> + noteRow.link + <span class="string">"\n"</span>;
            });
            callback();
        });
    };
    <span class="keyword">var</span> dataSetInfoLoaded = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>};
    <span class="keyword">var</span> loadIndicatorData = <span class="function"><span class="keyword">function</span><span class="params">(indicatorsToLoad)</span> {</span>
        <span class="keyword">var</span> q = <span class="keyword">new</span> queue();
        <span class="keyword">for</span> (<span class="keyword">var</span> category <span class="keyword">in</span> indicatorsToLoad) {
            <span class="keyword">if</span> (indicatorsToLoad.hasOwnProperty(category)) {
                indicatorsToLoad[category].forEach(<span class="function"><span class="keyword">function</span><span class="params">(indicator)</span> {</span>
                    (<span class="function"><span class="keyword">function</span><span class="params">(entity, indicator)</span> {</span>
                        q.defer(<span class="function"><span class="keyword">function</span><span class="params">(callback)</span> {</span>
                            loadIndicatorsFromFile(indicator, entity, callback);
                        });
                    })(category, indicator);
                });
            }
        }
        q.await(indicatorsLoaded);
    };
    <span class="keyword">var</span> indicatorsLoaded = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">if</span> (<span class="keyword">typeof</span> readIsCompleteCallback === <span class="string">"function"</span>) {
            readIsCompleteCallback(skeleton, indicators, entityMeta, [ datasetInfo, chartFooter ], regions, timeUnit);
        }
    };
    <span class="keyword">var</span> loadIndicatorsFromFile = <span class="function"><span class="keyword">function</span><span class="params">(indicator, category, callback)</span> {</span>
        d3.csv(csvDataPath + indicator + <span class="string">"__"</span> + category + <span class="string">".csv"</span>, <span class="function"><span class="keyword">function</span><span class="params">(error, rows)</span> {</span>
            d3.csv(csvDataPath + <span class="string">"indicators.csv"</span>, <span class="function"><span class="keyword">function</span><span class="params">(indError, indRows)</span> {</span>
                <span class="keyword">var</span> indicatorValues, years;
                setIndicatorInfo(category, indicator, indRows);
                <span class="keyword">var</span> isTimeDownFormat = rows[<span class="number">0</span>].time;
                <span class="keyword">if</span> (isTimeDownFormat) {
                    indicatorValues = loadIndicatorInTimeDownFormat(rows, category, indicator).indValue;
                    years = loadIndicatorInTimeDownFormat(rows, category, indicator).yearValues;
                } <span class="keyword">else</span> {
                    indicatorValues = loadIndicatorInTimeRightFormat(rows, category, indicator).indValue;
                    years = loadIndicatorInTimeRightFormat(rows, category, indicator).yearValues;
                }
                updateEntityRanges(category, indicator);
                setSkeletonInfo(category, indicator);
                updateDataRange(indicator, category, indicatorValues, years);
                indicatorsToLoad[category].splice(indicatorsToLoad[category].indexOf(indicator), <span class="number">1</span>);
                callback();
            });
        });
    };
    <span class="keyword">var</span> loadIndicatorInTimeDownFormat = <span class="function"><span class="keyword">function</span><span class="params">(rows, category, indicator)</span> {</span>
        <span class="keyword">var</span> indicatorValues = [];
        <span class="keyword">var</span> years = [];
        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; rows.length; i++) {
            <span class="keyword">if</span> (rows[i].id) {
                indicators[timeUnit][category][indicator][<span class="string">"years"</span>][rows[i].id] = {};
                indicators[timeUnit][category][indicator][<span class="string">"years"</span>][rows[i].id][<span class="string">"trends"</span>] = {};
            }
        }
        <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; rows.length; j++) {
            <span class="keyword">var</span> indValue = parseFloat(rows[j].value);
            <span class="keyword">var</span> note = rows[j].note;
            <span class="keyword">if</span> (!isNaN(indValue)) {
                indicators[timeUnit][category][indicator][<span class="string">"years"</span>][rows[j].id][<span class="string">"trends"</span>][rows[j].time] = {};
                indicators[timeUnit][category][indicator][<span class="string">"years"</span>][rows[j].id][<span class="string">"trends"</span>][rows[j].time][<span class="string">"n"</span>] = note;
                indicators[timeUnit][category][indicator][<span class="string">"years"</span>][rows[j].id][<span class="string">"trends"</span>][rows[j].time][<span class="string">"v"</span>] = indValue;
                indicatorValues.push(indValue);
                years.push(rows[j].time);
            }
        }
        <span class="keyword">return</span> {
            indValue: indicatorValues,
            yearValues: years
        };
    };
    <span class="keyword">var</span> loadIndicatorInTimeRightFormat = <span class="function"><span class="keyword">function</span><span class="params">(rows, category, indicator)</span> {</span>
        <span class="keyword">var</span> indicatorValues = [];
        <span class="keyword">var</span> years = [];
        <span class="keyword">for</span> (<span class="keyword">var</span> k = <span class="number">0</span>; k &lt; rows.length; k++) {
            indicators[timeUnit][category][indicator][<span class="string">"years"</span>][rows[k].id] = {};
            indicators[timeUnit][category][indicator][<span class="string">"years"</span>][rows[k].id][<span class="string">"trends"</span>] = {};
            <span class="keyword">for</span> (<span class="keyword">var</span> column <span class="keyword">in</span> rows[k]) {
                <span class="keyword">if</span> (rows[k].hasOwnProperty(column)) {
                    <span class="keyword">if</span> (column &amp;&amp; rows[k][column] &amp;&amp; column !== <span class="string">"name"</span> &amp;&amp; column !== <span class="string">"id"</span> &amp;&amp; column.indexOf(<span class="string">"note"</span>) === -<span class="number">1</span>) {
                        <span class="keyword">var</span> value = parseFloat(rows[k][column]);
                        <span class="keyword">if</span> (!isNaN(value)) {
                            indicators[timeUnit][category][indicator][<span class="string">"years"</span>][rows[k].id][<span class="string">"trends"</span>][column] = {};
                            indicators[timeUnit][category][indicator][<span class="string">"years"</span>][rows[k].id][<span class="string">"trends"</span>][column][<span class="string">"n"</span>] = [];
                            indicators[timeUnit][category][indicator][<span class="string">"years"</span>][rows[k].id][<span class="string">"trends"</span>][column][<span class="string">"v"</span>] = value;
                            indicatorValues.push(parseFloat(rows[k][column]));
                            years.push(column);
                        }
                    } <span class="keyword">else</span> <span class="keyword">if</span> (column.indexOf(<span class="string">"note"</span>) &gt;= <span class="number">0</span>) {
                        <span class="keyword">var</span> yearValue = column.substring(<span class="number">0</span>, column.indexOf(<span class="string">"_note"</span>));
                        indicators[timeUnit][category][indicator][<span class="string">"years"</span>][rows[k].id][<span class="string">"trends"</span>][column][yearValue] = column;
                    }
                }
            }
        }
        <span class="keyword">return</span> {
            indValue: indicatorValues,
            yearValues: years
        };
    };
    <span class="keyword">var</span> updateEntityRanges = <span class="function"><span class="keyword">function</span><span class="params">(category, indicator)</span> {</span>
        <span class="keyword">var</span> entitiesForIndicators = indicators[timeUnit][category][indicator][<span class="string">"years"</span>];
        <span class="keyword">for</span> (<span class="keyword">var</span> entity <span class="keyword">in</span> entitiesForIndicators) {
            <span class="keyword">if</span> (entitiesForIndicators.hasOwnProperty(entity) &amp;&amp; !$.isEmptyObject(entitiesForIndicators[entity][<span class="string">"trends"</span>])) {
                <span class="keyword">var</span> yearKeys = Object.keys(entitiesForIndicators[entity][<span class="string">"trends"</span>]);
                <span class="keyword">var</span> yearsForEntity = yearKeys.map(<span class="function"><span class="keyword">function</span><span class="params">(year)</span> {</span>
                    <span class="keyword">return</span> parseInt(year, <span class="number">10</span>);
                });
                <span class="keyword">var</span> minYear = Math.min.apply(Math, yearsForEntity);
                <span class="keyword">var</span> maxYear = Math.max.apply(Math, yearsForEntity);
                indicators[timeUnit][category][indicator][<span class="string">"years"</span>][entity][<span class="string">"scope"</span>] = {};
                indicators[timeUnit][category][indicator][<span class="string">"years"</span>][entity][<span class="string">"scope"</span>][<span class="string">"time"</span>] = {};
                indicators[timeUnit][category][indicator][<span class="string">"years"</span>][entity][<span class="string">"scope"</span>][<span class="string">"value"</span>] = {};
                indicators[timeUnit][category][indicator][<span class="string">"years"</span>][entity][<span class="string">"scope"</span>][<span class="string">"time"</span>][<span class="string">"0"</span>] = minYear;
                indicators[timeUnit][category][indicator][<span class="string">"years"</span>][entity][<span class="string">"scope"</span>][<span class="string">"time"</span>][<span class="string">"1"</span>] = maxYear;
                indicators[timeUnit][category][indicator][<span class="string">"years"</span>][entity][<span class="string">"scope"</span>][<span class="string">"value"</span>][<span class="string">"0"</span>] = indicators[timeUnit][category][indicator][<span class="string">"years"</span>][entity][<span class="string">"trends"</span>][minYear].v;
                indicators[timeUnit][category][indicator][<span class="string">"years"</span>][entity][<span class="string">"scope"</span>][<span class="string">"value"</span>][<span class="string">"1"</span>] = indicators[timeUnit][category][indicator][<span class="string">"years"</span>][entity][<span class="string">"trends"</span>][maxYear].v;
            }
        }
    };
    <span class="keyword">var</span> setSkeletonInfo = <span class="function"><span class="keyword">function</span><span class="params">(categoryId, indicator)</span> {</span>
        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; skeleton.categories.length; i++) {
            <span class="keyword">if</span> (skeleton.categories[i].id === categoryId) {
                skeleton.categories[i].things.push(indicator);
            }
        }
    };
    <span class="keyword">var</span> loadCategoryFromFile = <span class="function"><span class="keyword">function</span><span class="params">(category, callback)</span> {</span>
        d3.csv(csvDataPath + <span class="string">"categories.csv"</span>, <span class="function"><span class="keyword">function</span><span class="params">(catError, catRows)</span> {</span>
            <span class="keyword">var</span> parentHeader;
            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; catRows.length; i++) {
                <span class="keyword">if</span> (catRows[i].id === category) {
                    parentHeader = catRows[i].parent;
                }
            }
            d3.csv(csvDataPath + category + <span class="string">".csv"</span>, <span class="function"><span class="keyword">function</span><span class="params">(error, rows)</span> {</span>
                loadCategory(category, rows, parentHeader, callback);
            });
        });
    };
    <span class="keyword">var</span> loadCategories = <span class="function"><span class="keyword">function</span><span class="params">(indicatorsToLoad)</span> {</span>
        <span class="keyword">var</span> q = <span class="keyword">new</span> queue();
        <span class="keyword">for</span> (<span class="keyword">var</span> category <span class="keyword">in</span> indicatorsToLoad) {
            <span class="keyword">if</span> (indicatorsToLoad.hasOwnProperty(category)) {
                (<span class="function"><span class="keyword">function</span><span class="params">(category)</span> {</span>
                    q.defer(<span class="function"><span class="keyword">function</span><span class="params">(callback)</span> {</span>
                        loadCategoryFromFile(category, callback);
                    });
                })(category);
            }
        }
        q.await(categoriesLoaded);
    };
    <span class="keyword">var</span> categoriesLoaded = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>};
    <span class="keyword">var</span> loadCategory = <span class="function"><span class="keyword">function</span><span class="params">(category, rows, parentHeader, callback)</span> {</span>
        console.log(<span class="string">"Loading Category "</span>, category, <span class="string">" ..."</span>);
        <span class="keyword">var</span> regionsList = [];
        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; skeleton.categories.length; i++) {
            <span class="keyword">if</span> (skeleton.categories[i].id === category) {
                skeleton.categories[i].count = rows.length;
            }
        }
        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; rows.length; i++) {
            entitiesData.push({
                id: rows[i][<span class="string">"id"</span>],
                name: rows[i][<span class="string">"name"</span>],
                region: rows[i][parentHeader],
                parent: category
            });
            regionsList.push(rows[i][parentHeader]);
        }
        entityMeta = d3.nest().key(<span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> d.id;
        }).map(entitiesData);
        $.each(regionsList, <span class="function"><span class="keyword">function</span><span class="params">(i, region)</span> {</span>
            <span class="keyword">if</span> ($.inArray(region, regions) === -<span class="number">1</span>) {
                regions.push(region);
            }
        });
        callback();
    };
    <span class="keyword">var</span> setIndicatorInfo = <span class="function"><span class="keyword">function</span><span class="params">(category, indicator, indicatorRows)</span> {</span>
        timeUnit = indicatorRows[<span class="number">1</span>].time || <span class="string">"yearly"</span>;
        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; indicatorRows.length; i++) {
            <span class="keyword">if</span> (indicatorRows[i].id === indicator) {
                indicators[timeUnit][category][indicator][<span class="string">"info"</span>][<span class="string">"id"</span>] = indicatorRows[i].id;
                indicators[timeUnit][category][indicator][<span class="string">"info"</span>][<span class="string">"name"</span>] = indicatorRows[i].name;
                indicators[timeUnit][category][indicator][<span class="string">"info"</span>][<span class="string">"info"</span>] = indicatorRows[i].info;
                indicators[timeUnit][category][indicator][<span class="string">"info"</span>][<span class="string">"data"</span>] = indicatorRows[i].data;
                indicators[timeUnit][category][indicator][<span class="string">"info"</span>][<span class="string">"unit"</span>] = indicatorRows[i].unit;
                indicators[timeUnit][category][indicator][<span class="string">"info"</span>][<span class="string">"note"</span>] = indicatorRows[i].note;
            }
        }
    };
    <span class="keyword">var</span> updateDataRange = <span class="function"><span class="keyword">function</span><span class="params">(indicator, category, indicatorValues, years)</span> {</span>
        <span class="keyword">if</span> (indicators[timeUnit][category][indicator][<span class="string">"scope"</span>][<span class="string">"time"</span>]) {
            indicators[timeUnit][category][indicator][<span class="string">"scope"</span>].value = [ Math.min.apply(Math, indicatorValues), Math.max.apply(Math, indicatorValues) ];
            indicators[timeUnit][category][indicator][<span class="string">"scope"</span>].time = [ Math.min.apply(Math, years), Math.max.apply(Math, years) ];
        }
    };
    <span class="keyword">var</span> loadSkeleton = <span class="function"><span class="keyword">function</span><span class="params">(path, setSkeletonCallback)</span> {</span>
        <span class="keyword">var</span> q = <span class="keyword">new</span> queue();
        q.defer(<span class="function"><span class="keyword">function</span><span class="params">(callback)</span> {</span>
            loadSkeletonIndicator(path, callback);
        }).defer(<span class="function"><span class="keyword">function</span><span class="params">(callback)</span> {</span>
            loadSkeletonCategory(path, callback);
        }).await(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
            setSkeletonCallback(skeleton);
        });
    };
    <span class="keyword">var</span> loadSkeletonIndicator = <span class="function"><span class="keyword">function</span><span class="params">(path, callback)</span> {</span>
        csvDataPath = path;
        d3.csv(csvDataPath + <span class="string">"indicators.csv"</span>, <span class="function"><span class="keyword">function</span><span class="params">(error, rows)</span> {</span>
            <span class="keyword">if</span> (rows[<span class="number">0</span>].availability) {
                rows.forEach(<span class="function"><span class="keyword">function</span><span class="params">(rowObject)</span> {</span>
                    <span class="keyword">var</span> indicator = {};
                    indicator[<span class="string">"id"</span>] = rowObject.id;
                    indicator[<span class="string">"info"</span>] = {};
                    indicator[<span class="string">"info"</span>][<span class="string">"name"</span>] = rowObject.name;
                    indicator[<span class="string">"categories"</span>] = [];
                    indicator[<span class="string">"categories"</span>] = rowObject[<span class="string">"availability"</span>].split(<span class="string">" "</span>);
                    skeleton.indicators.push(indicator);
                });
            }
            callback();
        });
    };
    <span class="keyword">var</span> loadSkeletonCategory = <span class="function"><span class="keyword">function</span><span class="params">(path, callback)</span> {</span>
        d3.csv(csvDataPath + <span class="string">"categories.csv"</span>, <span class="function"><span class="keyword">function</span><span class="params">(error, rows)</span> {</span>
            rows.forEach(<span class="function"><span class="keyword">function</span><span class="params">(rowObject)</span> {</span>
                <span class="keyword">var</span> category = {};
                category[<span class="string">"id"</span>] = rowObject.id;
                category[<span class="string">"name"</span>] = rowObject.name;
                category[<span class="string">"about"</span>] = rowObject.info;
                category[<span class="string">"count"</span>] = <span class="number">0</span>;
                category[<span class="string">"things"</span>] = [];
                skeleton.categories.push(category);
            });
            callback();
        });
    };
    <span class="keyword">return</span> {
        initialize: initialize,
        loadSkeleton: loadSkeleton,
        loadCategory: loadCategories,
        loadIndicators: loadIndicatorData
    };
};

gapminder.data.readerMultipleCSV = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
    <span class="keyword">var</span> indicators = {};
    <span class="keyword">var</span> entityMeta = {};
    <span class="keyword">var</span> loadedIndicators = [];
    <span class="keyword">var</span> readIsCompletedCallback;
    <span class="keyword">var</span> csvDataPath;
    <span class="keyword">var</span> timeUnit = <span class="string">"yearly"</span>;
    <span class="keyword">var</span> entitiesData = [];
    <span class="keyword">var</span> skeleton = {
        indicators: [],
        categories: []
    };
    <span class="keyword">var</span> initialize = <span class="function"><span class="keyword">function</span><span class="params">(indicatorsTemplate, model, dataPath, indicatorsToLoad, callback)</span> {</span>
        readIsCompletedCallback = callback;
        csvDataPath = dataPath;
        indicators = indicatorsTemplate;
    };
    <span class="keyword">var</span> loadEntities = <span class="function"><span class="keyword">function</span><span class="params">(indicatorsToLoad)</span> {</span>
        <span class="keyword">var</span> q = <span class="keyword">new</span> queue();
        <span class="keyword">for</span> (<span class="keyword">var</span> entity <span class="keyword">in</span> indicatorsToLoad) {
            <span class="keyword">if</span> (indicatorsToLoad.hasOwnProperty(entity)) {
                (<span class="function"><span class="keyword">function</span><span class="params">(entity)</span> {</span>
                    q.defer(<span class="function"><span class="keyword">function</span><span class="params">(callback)</span> {</span>
                        loadEntity(entity, callback);
                    });
                })(entity);
            }
        }
        q.await(entitiesLoaded);
    };
    <span class="keyword">var</span> entitiesLoaded = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>};
    <span class="keyword">var</span> loadEntity = <span class="function"><span class="keyword">function</span><span class="params">(entity, callback)</span> {</span>
        d3.csv(csvDataPath + <span class="string">"entities/"</span> + entity + <span class="string">".csv"</span>, <span class="function"><span class="keyword">function</span><span class="params">(error, rows)</span> {</span>
            console.log(<span class="string">"Loading Category "</span>, entity, <span class="string">" ..."</span>);
            loadedIndicators[entity] = [];
            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; rows.length; i++) {
                entitiesData.push({
                    id: rows[i][<span class="string">"name"</span>],
                    name: rows[i][<span class="string">"name"</span>],
                    region: rows[i][<span class="string">"region"</span>],
                    parent: entity
                });
            }
            entityMeta = d3.nest().key(<span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
                <span class="keyword">return</span> d.id;
            }).map(entitiesData);
            callback();
        });
    };
    <span class="keyword">var</span> loadIndicatorData = <span class="function"><span class="keyword">function</span><span class="params">(indicatorsToLoad)</span> {</span>
        <span class="keyword">var</span> q = <span class="keyword">new</span> queue();
        <span class="keyword">for</span> (<span class="keyword">var</span> entity <span class="keyword">in</span> indicatorsToLoad) {
            <span class="keyword">if</span> (indicatorsToLoad.hasOwnProperty(entity)) {
                indicatorsToLoad[entity].forEach(<span class="function"><span class="keyword">function</span><span class="params">(indicator)</span> {</span>
                    (<span class="function"><span class="keyword">function</span><span class="params">(entity, indicator)</span> {</span>
                        q.defer(<span class="function"><span class="keyword">function</span><span class="params">(callback)</span> {</span>
                            loadCSVFile(indicator, entity, callback);
                        });
                    })(entity, indicator);
                });
                q.await(indicatorsLoaded);
            }
        }
    };
    <span class="keyword">var</span> loadCSVFile = <span class="function"><span class="keyword">function</span><span class="params">(indicator, entity, callback)</span> {</span>
        d3.csv(csvDataPath + <span class="string">"indicators/"</span> + indicator + <span class="string">"_"</span> + entity + <span class="string">".csv"</span>, <span class="function"><span class="keyword">function</span><span class="params">(error, rows)</span> {</span>
            <span class="keyword">var</span> indicatorValues = loadIndicators(rows, entity, indicator).indValues;
            <span class="keyword">var</span> years = loadIndicators(rows, entity, indicator).yearValues;
            setSkeletonInfo(entity, indicator);
            updateDataRange(indicator, entity, indicatorValues, years);
            updateEntityRanges(entity, indicator);
            callback(<span class="literal">null</span>, indicators);
        });
    };
    <span class="keyword">var</span> loadIndicators = <span class="function"><span class="keyword">function</span><span class="params">(rows, entity, indicator)</span> {</span>
        indicators[timeUnit][entity][indicator][<span class="string">"info"</span>][<span class="string">"name"</span>] = indicator;
        indicators[timeUnit][entity][indicator][<span class="string">"info"</span>][<span class="string">"id"</span>] = indicator;
        <span class="keyword">var</span> indicatorValues = [];
        <span class="keyword">var</span> years = [];
        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; rows.length; i++) {
            <span class="keyword">var</span> rowEntity = rows[i][entity];
            indicators[timeUnit][entity][indicator][<span class="string">"years"</span>][rowEntity] = {};
            indicators[timeUnit][entity][indicator][<span class="string">"years"</span>][rowEntity][<span class="string">"trends"</span>] = {};
            <span class="keyword">for</span> (<span class="keyword">var</span> field <span class="keyword">in</span> rows[i]) {
                <span class="keyword">if</span> (rows[i].hasOwnProperty(field)) {
                    <span class="keyword">if</span> (rows[i][field] &amp;&amp; field !== entity) {
                        indicators[timeUnit][entity][indicator][<span class="string">"years"</span>][rowEntity][<span class="string">"trends"</span>][field] = {};
                        indicators[timeUnit][entity][indicator][<span class="string">"years"</span>][rowEntity][<span class="string">"trends"</span>][field][<span class="string">"n"</span>] = [];
                        indicators[timeUnit][entity][indicator][<span class="string">"years"</span>][rowEntity][<span class="string">"trends"</span>][field][<span class="string">"v"</span>] = parseFloat(rows[i][field]);
                        indicatorValues.push(parseFloat(rows[i][field]));
                        years.push(field);
                    }
                }
            }
        }
        <span class="keyword">return</span> {
            indValues: indicatorValues,
            yearValues: years
        };
    };
    <span class="keyword">var</span> setSkeletonInfo = <span class="function"><span class="keyword">function</span><span class="params">(categoryId, indicator)</span> {</span>
        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; skeleton.categories.length; i++) {
            <span class="keyword">if</span> (skeleton.categories[i].id === categoryId) {
                skeleton.categories[i].things.push(indicator);
            }
        }
    };
    <span class="keyword">var</span> indicatorsLoaded = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">if</span> (<span class="keyword">typeof</span> readIsCompletedCallback === <span class="string">"function"</span>) {
            readIsCompletedCallback(loadedIndicators, indicators, entityMeta, {}, [], timeUnit);
        }
    };
    <span class="keyword">var</span> updateDataRange = <span class="function"><span class="keyword">function</span><span class="params">(indicator, entity, indicatorValues, years)</span> {</span>
        <span class="keyword">if</span> (indicators[timeUnit][entity][indicator][<span class="string">"scope"</span>][<span class="string">"time"</span>]) {
            indicators[timeUnit][entity][indicator][<span class="string">"scope"</span>].value = [ Math.min.apply(Math, indicatorValues), Math.max.apply(Math, indicatorValues) ];
            indicators[timeUnit][entity][indicator][<span class="string">"scope"</span>].time = [ Math.min.apply(Math, years), Math.max.apply(Math, years) ];
        }
    };
    <span class="keyword">var</span> updateEntityRanges = <span class="function"><span class="keyword">function</span><span class="params">(category, indicator)</span> {</span>
        <span class="keyword">var</span> entitiesForIndicators = indicators[timeUnit][category][indicator][<span class="string">"years"</span>];
        <span class="keyword">for</span> (<span class="keyword">var</span> entity <span class="keyword">in</span> entitiesForIndicators) {
            <span class="keyword">if</span> (entitiesForIndicators.hasOwnProperty(entity) &amp;&amp; !$.isEmptyObject(entitiesForIndicators[entity][<span class="string">"trends"</span>])) {
                <span class="keyword">var</span> yearKeys = Object.keys(entitiesForIndicators[entity][<span class="string">"trends"</span>]);
                <span class="keyword">var</span> yearsForEntity = yearKeys.map(<span class="function"><span class="keyword">function</span><span class="params">(year)</span> {</span>
                    <span class="keyword">return</span> parseInt(year, <span class="number">10</span>);
                });
                <span class="keyword">var</span> minYear = Math.min.apply(Math, yearsForEntity);
                <span class="keyword">var</span> maxYear = Math.max.apply(Math, yearsForEntity);
                indicators[timeUnit][category][indicator][<span class="string">"years"</span>][entity][<span class="string">"scope"</span>] = {};
                indicators[timeUnit][category][indicator][<span class="string">"years"</span>][entity][<span class="string">"scope"</span>][<span class="string">"time"</span>] = {};
                indicators[timeUnit][category][indicator][<span class="string">"years"</span>][entity][<span class="string">"scope"</span>][<span class="string">"value"</span>] = {};
                indicators[timeUnit][category][indicator][<span class="string">"years"</span>][entity][<span class="string">"scope"</span>][<span class="string">"time"</span>][<span class="string">"0"</span>] = minYear;
                indicators[timeUnit][category][indicator][<span class="string">"years"</span>][entity][<span class="string">"scope"</span>][<span class="string">"time"</span>][<span class="string">"1"</span>] = maxYear;
                indicators[timeUnit][category][indicator][<span class="string">"years"</span>][entity][<span class="string">"scope"</span>][<span class="string">"value"</span>][<span class="string">"0"</span>] = indicators[timeUnit][category][indicator][<span class="string">"years"</span>][entity][<span class="string">"trends"</span>][minYear].v;
                indicators[timeUnit][category][indicator][<span class="string">"years"</span>][entity][<span class="string">"scope"</span>][<span class="string">"value"</span>][<span class="string">"1"</span>] = indicators[timeUnit][category][indicator][<span class="string">"years"</span>][entity][<span class="string">"trends"</span>][maxYear].v;
            }
        }
    };
    <span class="keyword">return</span> {
        initialize: initialize,
        loadCategory: loadEntities,
        loadIndicators: loadIndicatorData
    };
};

gapminder.data.readerMultipleJSON = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
    <span class="keyword">var</span> indicators = {};
    <span class="keyword">var</span> entityMeta = {};
    <span class="keyword">var</span> loadedIndicators = [];
    <span class="keyword">var</span> readIsCompletedCallback;
    <span class="keyword">var</span> timeUnit = <span class="string">"yearly"</span>;
    <span class="keyword">var</span> entitiesData = [];
    <span class="keyword">var</span> skeleton = {
        indicators: [],
        categories: []
    };
    <span class="keyword">var</span> jsonPath;
    <span class="keyword">var</span> initialize = <span class="function"><span class="keyword">function</span><span class="params">(indicatorsTemplate, model, dataPath, indicatorsToLoad, callback, changedState, language, fileName, timeUnitToken)</span> {</span>
        readIsCompletedCallback = callback;
        indicators = indicatorsTemplate;
        jsonPath = dataPath;
    };
    <span class="keyword">var</span> loadEntities = <span class="function"><span class="keyword">function</span><span class="params">(indicatorsToLoad)</span> {</span>
        <span class="keyword">var</span> q = <span class="keyword">new</span> queue();
        <span class="keyword">for</span> (<span class="keyword">var</span> entity <span class="keyword">in</span> indicatorsToLoad) {
            <span class="keyword">if</span> (indicatorsToLoad.hasOwnProperty(entity)) {
                (<span class="function"><span class="keyword">function</span><span class="params">(entity)</span> {</span>
                    q.defer(<span class="function"><span class="keyword">function</span><span class="params">(callback)</span> {</span>
                        loadEntity(entity, callback);
                    });
                })(entity);
            }
        }
        q.await(categoriesLoaded);
    };
    <span class="keyword">var</span> categoriesLoaded = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        console.log(entityMeta);
    };
    <span class="keyword">var</span> loadEntity = <span class="function"><span class="keyword">function</span><span class="params">(entity, callback)</span> {</span>
        d3.json(jsonPath + <span class="string">"entities/"</span> + entity + <span class="string">".json"</span>, <span class="function"><span class="keyword">function</span><span class="params">(errorEntity, entityJson)</span> {</span>
            <span class="keyword">var</span> countries = entityJson.countries;
            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; countries.length; i++) {
                entitiesData.push({
                    id: countries[i].name,
                    region: countries[i].region,
                    name: countries[i].name,
                    parent: entity
                });
            }
            entityMeta = d3.nest().key(<span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
                <span class="keyword">return</span> d.id;
            }).map(entitiesData);
            callback();
        });
    };
    <span class="keyword">var</span> loadIndicatorData = <span class="function"><span class="keyword">function</span><span class="params">(indicatorsToLoad)</span> {</span>
        <span class="keyword">var</span> q = <span class="keyword">new</span> queue();
        <span class="keyword">for</span> (<span class="keyword">var</span> entity <span class="keyword">in</span> indicatorsToLoad) {
            <span class="keyword">if</span> (indicatorsToLoad.hasOwnProperty(entity)) {
                indicatorsToLoad[entity].forEach(<span class="function"><span class="keyword">function</span><span class="params">(indicator)</span> {</span>
                    (<span class="function"><span class="keyword">function</span><span class="params">(entity)</span> {</span>
                        q.defer(<span class="function"><span class="keyword">function</span><span class="params">(callback)</span> {</span>
                            loadJSONFile(indicator, entity, callback);
                        });
                    })(entity);
                });
                q.await(indicatorsLoaded);
            }
        }
    };
    <span class="keyword">var</span> loadJSONFile = <span class="function"><span class="keyword">function</span><span class="params">(indicator, entityName, callback)</span> {</span>
        d3.json(jsonPath + <span class="string">"indicators/"</span> + indicator + <span class="string">"_"</span> + entityName + <span class="string">".json"</span>, <span class="function"><span class="keyword">function</span><span class="params">(errorIndicator, json)</span> {</span>
            <span class="keyword">if</span> (errorIndicator) {
                console.log(<span class="string">"There was a problem rendering"</span>, indicator, <span class="string">".json file"</span>);
            }
            <span class="keyword">var</span> data = json.trends;
            <span class="keyword">for</span> (<span class="keyword">var</span> entity <span class="keyword">in</span> data) {
                <span class="keyword">if</span> (data.hasOwnProperty(entity)) {
                    indicators[timeUnit][entityName][json.info.measure_id][<span class="string">"info"</span>][<span class="string">"name"</span>] = json.info.measure_name;
                    indicators[timeUnit][entityName][json.info.measure_id][<span class="string">"info"</span>][<span class="string">"id"</span>] = json.info.measure_id;
                    <span class="keyword">for</span> (<span class="keyword">var</span> entityObj <span class="keyword">in</span> data) {
                        <span class="keyword">if</span> (data.hasOwnProperty(entityObj)) {
                            loadIndicator(entityName, json, entityObj);
                            updateEntityScope(entityName, json, entityObj);
                        }
                    }
                }
            }
            setSkeletonInfo(entity, indicator);
            updateDataRange(indicator, entityName);
            callback(<span class="literal">null</span>, indicators);
        });
    };
    <span class="keyword">var</span> loadIndicator = <span class="function"><span class="keyword">function</span><span class="params">(entityName, json, entityObj)</span> {</span>
        <span class="keyword">var</span> data = json.trends;
        indicators[timeUnit][entityName][json.info.measure_id][<span class="string">"years"</span>][entityObj] = {};
        indicators[timeUnit][entityName][json.info.measure_id][<span class="string">"years"</span>][entityObj][<span class="string">"trends"</span>] = {};
        <span class="keyword">for</span> (<span class="keyword">var</span> year <span class="keyword">in</span> data[entityObj]) {
            <span class="keyword">if</span> (data[entityObj].hasOwnProperty(year)) {
                indicators[timeUnit][entityName][json.info.measure_id][<span class="string">"years"</span>][entityObj][<span class="string">"trends"</span>][year] = {};
                indicators[timeUnit][entityName][json.info.measure_id][<span class="string">"years"</span>][entityObj][<span class="string">"trends"</span>][year].v = data[entityObj][year];
                indicators[timeUnit][entityName][json.info.measure_id][<span class="string">"years"</span>][entityObj][<span class="string">"trends"</span>][year].n = [];
            }
        }
    };
    <span class="keyword">var</span> updateEntityScope = <span class="function"><span class="keyword">function</span><span class="params">(entityName, json, entityObj)</span> {</span>
        <span class="keyword">var</span> yearKeys = Object.keys(indicators[timeUnit][entityName][json.info.measure_id][<span class="string">"years"</span>][entityObj][<span class="string">"trends"</span>]);
        <span class="keyword">var</span> years = yearKeys.map(<span class="function"><span class="keyword">function</span><span class="params">(year)</span> {</span>
            <span class="keyword">return</span> parseInt(year, <span class="number">10</span>);
        });
        <span class="keyword">var</span> minYear = Math.min.apply(Math, years);
        <span class="keyword">var</span> maxYear = Math.max.apply(Math, years);
        indicators[timeUnit][entityName][json.info.measure_id][<span class="string">"years"</span>][entityObj][<span class="string">"scope"</span>] = {};
        indicators[timeUnit][entityName][json.info.measure_id][<span class="string">"years"</span>][entityObj][<span class="string">"scope"</span>][<span class="string">"time"</span>] = {};
        indicators[timeUnit][entityName][json.info.measure_id][<span class="string">"years"</span>][entityObj][<span class="string">"scope"</span>][<span class="string">"value"</span>] = {};
        indicators[timeUnit][entityName][json.info.measure_id][<span class="string">"years"</span>][entityObj][<span class="string">"scope"</span>][<span class="string">"time"</span>][<span class="string">"0"</span>] = minYear;
        indicators[timeUnit][entityName][json.info.measure_id][<span class="string">"years"</span>][entityObj][<span class="string">"scope"</span>][<span class="string">"time"</span>][<span class="string">"1"</span>] = maxYear;
        indicators[timeUnit][entityName][json.info.measure_id][<span class="string">"years"</span>][entityObj][<span class="string">"scope"</span>][<span class="string">"value"</span>][<span class="string">"0"</span>] = indicators[timeUnit][entityName][json.info.measure_id][<span class="string">"years"</span>][entityObj][<span class="string">"trends"</span>][minYear].v;
        indicators[timeUnit][entityName][json.info.measure_id][<span class="string">"years"</span>][entityObj][<span class="string">"scope"</span>][<span class="string">"value"</span>][<span class="string">"1"</span>] = indicators[timeUnit][entityName][json.info.measure_id][<span class="string">"years"</span>][entityObj][<span class="string">"trends"</span>][maxYear].v;
    };
    <span class="keyword">var</span> updateDataRange = <span class="function"><span class="keyword">function</span><span class="params">(indicator, entity)</span> {</span>
        <span class="keyword">if</span> (indicators[timeUnit][entity][indicator][<span class="string">"scope"</span>][<span class="string">"time"</span>]) {
            <span class="keyword">var</span> indicatorValuesAndYears = getIndicatorValuesAndCorrespondingYears(indicators[timeUnit][entity][indicator][<span class="string">"years"</span>]);
            <span class="keyword">var</span> indicatorValues = indicatorValuesAndYears[<span class="number">0</span>];
            <span class="keyword">var</span> indicatorValueMin = Math.min.apply(Math, indicatorValues);
            <span class="keyword">var</span> indicatorValueMax = Math.max.apply(Math, indicatorValues);
            indicators[timeUnit][entity][indicator][<span class="string">"scope"</span>].value = [ indicatorValueMin, indicatorValueMax ];
            <span class="keyword">var</span> indicatorYears = indicatorValuesAndYears[<span class="number">1</span>];
            <span class="keyword">var</span> minYear = Math.min.apply(Math, indicatorYears);
            <span class="keyword">var</span> maxYear = Math.max.apply(Math, indicatorYears);
            indicators[timeUnit][entity][indicator][<span class="string">"scope"</span>].time = [ minYear, maxYear ];
        }
    };
    <span class="keyword">var</span> getIndicatorValuesAndCorrespondingYears = <span class="function"><span class="keyword">function</span><span class="params">(indicatorObject)</span> {</span>
        <span class="keyword">var</span> indicatorValues = [];
        <span class="keyword">var</span> yearsValues = [];
        <span class="keyword">for</span> (<span class="keyword">var</span> entity <span class="keyword">in</span> indicatorObject) {
            <span class="keyword">if</span> (indicatorObject.hasOwnProperty(entity)) {
                <span class="keyword">for</span> (<span class="keyword">var</span> yearValue <span class="keyword">in</span> indicatorObject[entity][<span class="string">"trends"</span>]) {
                    <span class="keyword">if</span> (indicatorObject[entity][<span class="string">"trends"</span>].hasOwnProperty(yearValue)) {
                        <span class="keyword">var</span> indicatorForEntity = indicatorObject[entity][<span class="string">"trends"</span>];
                        indicatorValues.push(indicatorForEntity[yearValue].v);
                        yearsValues.push(yearValue);
                    }
                }
            }
        }
        <span class="keyword">return</span> [ indicatorValues, yearsValues ];
    };
    <span class="keyword">var</span> indicatorsLoaded = <span class="function"><span class="keyword">function</span><span class="params">(err, results)</span> {</span>
        <span class="keyword">if</span> (<span class="keyword">typeof</span> readIsCompletedCallback === <span class="string">"function"</span>) {
            readIsCompletedCallback(loadedIndicators, indicators, entityMeta, {}, [], timeUnit);
        }
    };
    <span class="keyword">var</span> loadSkeleton = <span class="function"><span class="keyword">function</span><span class="params">(path, setSkeletonCallback)</span> {</span>
        <span class="keyword">var</span> q = <span class="keyword">new</span> queue();
        q.defer(<span class="function"><span class="keyword">function</span><span class="params">(callback)</span> {</span>
            loadSkeletonIndicator(path, callback);
        }).defer(<span class="function"><span class="keyword">function</span><span class="params">(callback)</span> {</span>
            loadSkeletonCategory(path, callback);
        }).await(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
            setSkeletonCallback(skeleton);
        });
    };
    <span class="keyword">var</span> loadSkeletonIndicator = <span class="function"><span class="keyword">function</span><span class="params">(path, callback)</span> {</span>
        d3.json(path + <span class="string">"skeleton.json"</span>, <span class="function"><span class="keyword">function</span><span class="params">(error, data)</span> {</span>
            skeleton.indicators = data.indicators;
            callback();
        });
    };
    <span class="keyword">var</span> loadSkeletonCategory = <span class="function"><span class="keyword">function</span><span class="params">(path, callback)</span> {</span>
        d3.json(path + <span class="string">"skeleton.json"</span>, <span class="function"><span class="keyword">function</span><span class="params">(error, data)</span> {</span>
            skeleton.indicators = data.indicators;
            callback();
        });
    };
    <span class="keyword">var</span> setSkeletonInfo = <span class="function"><span class="keyword">function</span><span class="params">(categoryId, indicator)</span> {</span>
        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; skeleton.categories.length; i++) {
            <span class="keyword">if</span> (skeleton.categories[i].id === categoryId) {
                skeleton.categories[i].things.push(indicator);
            }
        }
    };
    <span class="keyword">return</span> {
        initialize: initialize,
        loadSkeleton: loadSkeleton,
        loadCategory: loadEntities,
        loadIndicators: loadIndicatorData
    };
};

gapminder.data.readerSingleCSV = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
    <span class="keyword">var</span> indicators = {};
    <span class="keyword">var</span> entityMeta = {};
    <span class="keyword">var</span> loadedIndicators = [];
    <span class="keyword">var</span> readIsCompletedCallback;
    <span class="keyword">var</span> csvDataPath;
    <span class="keyword">var</span> csvFileName;
    <span class="keyword">var</span> entitiesData = [];
    <span class="keyword">var</span> timeUnit = <span class="string">"yearly"</span>;
    <span class="keyword">var</span> skeleton = {
        indicators: [],
        categories: []
    };
    <span class="keyword">var</span> initialize = <span class="function"><span class="keyword">function</span><span class="params">(indicatorsTemplate, model, dataPath, indicatorsToLoad, callback, changedState, language, fileName)</span> {</span>
        indicators = indicatorsTemplate;
        readIsCompletedCallback = callback;
        csvDataPath = dataPath;
        csvFileName = fileName;
    };
    <span class="keyword">var</span> loadEntities = <span class="function"><span class="keyword">function</span><span class="params">(indicatorsToLoad)</span> {</span>
        <span class="keyword">var</span> q = <span class="keyword">new</span> queue();
        <span class="keyword">for</span> (<span class="keyword">var</span> entity <span class="keyword">in</span> indicatorsToLoad) {
            <span class="keyword">if</span> (indicatorsToLoad.hasOwnProperty(entity)) {
                (<span class="function"><span class="keyword">function</span><span class="params">(entity)</span> {</span>
                    q.defer(<span class="function"><span class="keyword">function</span><span class="params">(callback)</span> {</span>
                        loadEntity(entity, callback);
                    });
                })(entity);
            }
        }
        q.await(entitiesLoaded);
    };
    <span class="keyword">var</span> entitiesLoaded = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>};
    <span class="keyword">var</span> loadEntity = <span class="function"><span class="keyword">function</span><span class="params">(entity, callback)</span> {</span>
        d3.csv(csvDataPath + csvFileName + <span class="string">".csv"</span>, <span class="function"><span class="keyword">function</span><span class="params">(error, rows)</span> {</span>
            console.log(<span class="string">"Loading entity "</span>, entity, <span class="string">" ..."</span>);
            console.log(entity, entity);
            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; rows.length; i++) {
                entitiesData.push({
                    id: rows[i][entity],
                    name: rows[i][entity],
                    region: rows[i][<span class="string">"region"</span>],
                    parent: entity
                });
            }
            entityMeta = d3.nest().key(<span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
                <span class="keyword">return</span> d.id;
            }).map(entitiesData);
            callback();
        });
    };
    <span class="keyword">var</span> loadIndicatorData = <span class="function"><span class="keyword">function</span><span class="params">(indicatorsToLoad)</span> {</span>
        <span class="keyword">var</span> q = <span class="keyword">new</span> queue();
        <span class="keyword">for</span> (<span class="keyword">var</span> entity <span class="keyword">in</span> indicatorsToLoad) {
            <span class="keyword">if</span> (indicatorsToLoad.hasOwnProperty(entity)) {
                indicatorsToLoad[entity].forEach(<span class="function"><span class="keyword">function</span><span class="params">(indicator)</span> {</span>
                    (<span class="function"><span class="keyword">function</span><span class="params">(entity, indicator)</span> {</span>
                        q.defer(<span class="function"><span class="keyword">function</span><span class="params">(callback)</span> {</span>
                            loadCSVFile(indicator, entity, callback);
                        });
                    })(entity, indicator);
                });
                q.await(indicatorsLoaded);
            }
        }
    };
    <span class="keyword">var</span> loadCSVFile = <span class="function"><span class="keyword">function</span><span class="params">(indicator, entity, callback)</span> {</span>
        d3.csv(csvDataPath + csvFileName + <span class="string">".csv"</span>, <span class="function"><span class="keyword">function</span><span class="params">(error, rows)</span> {</span>
            <span class="keyword">var</span> indicatorValues = loadIndicator(entity, indicator, rows).indValues;
            <span class="keyword">var</span> years = loadIndicator(entity, indicator, rows).years;
            setSkeletonInfo(entity, indicator);
            updateEntityRanges(entity, indicator);
            updateDataRange(indicator, entity, indicatorValues, years);
            callback(<span class="literal">null</span>, indicators);
        });
    };
    <span class="keyword">var</span> loadIndicator = <span class="function"><span class="keyword">function</span><span class="params">(entity, indicator, rows)</span> {</span>
        <span class="keyword">var</span> indicatorValues = [];
        <span class="keyword">var</span> years = [];
        indicators[timeUnit][entity][indicator][<span class="string">"info"</span>][<span class="string">"name"</span>] = indicator;
        indicators[timeUnit][entity][indicator][<span class="string">"info"</span>][<span class="string">"id"</span>] = indicator;
        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; rows.length; i++) {
            <span class="keyword">if</span> (rows[i].hasOwnProperty(entity)) {
                indicators[timeUnit][entity][indicator][<span class="string">"years"</span>][rows[i][entity]] = {};
                indicators[timeUnit][entity][indicator][<span class="string">"years"</span>][rows[i][entity]][<span class="string">"trends"</span>] = {};
                indicators[timeUnit][entity][indicator][<span class="string">"years"</span>][rows[i][entity]][<span class="string">"trends"</span>][rows[i][<span class="string">"year"</span>]] = {};
                indicators[timeUnit][entity][indicator][<span class="string">"years"</span>][rows[i][entity]][<span class="string">"trends"</span>][rows[i][<span class="string">"year"</span>]][<span class="string">"n"</span>] = [];
                indicators[timeUnit][entity][indicator][<span class="string">"years"</span>][rows[i][entity]][<span class="string">"trends"</span>][rows[i][<span class="string">"year"</span>]][<span class="string">"v"</span>] = parseFloat(rows[i][indicator]);
                indicatorValues.push(parseFloat(rows[i][indicator]));
                years.push(rows[i][<span class="string">"year"</span>]);
            }
        }
        <span class="keyword">return</span> {
            indValues: indicatorValues,
            yearValues: years
        };
    };
    <span class="keyword">var</span> setSkeletonInfo = <span class="function"><span class="keyword">function</span><span class="params">(categoryId, indicator)</span> {</span>
        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; skeleton.categories.length; i++) {
            <span class="keyword">if</span> (skeleton.categories[i].id === categoryId) {
                skeleton.categories[i].things.push(indicator);
            }
        }
    };
    <span class="keyword">var</span> loadSkeleton = <span class="function"><span class="keyword">function</span><span class="params">(path, setSkeletonCallback, fileName, entity)</span> {</span>
        d3.csv(path + fileName, <span class="function"><span class="keyword">function</span><span class="params">(error, rows)</span> {</span>
            <span class="keyword">var</span> row = rows[<span class="number">0</span>];
            <span class="keyword">for</span> (<span class="keyword">var</span> column <span class="keyword">in</span> row) {
                <span class="keyword">if</span> (row.hasOwnProperty(column)) {
                    <span class="keyword">var</span> isNotRegionOrYearColumn = column !== <span class="string">"year"</span> &amp;&amp; column !== <span class="string">"region"</span>;
                    <span class="keyword">if</span> (isNotRegionOrYearColumn &amp;&amp; column !== entity) {
                        <span class="keyword">var</span> indicator = {};
                        indicator[<span class="string">"id"</span>] = column;
                        indicator[<span class="string">"info"</span>] = {};
                        indicator[<span class="string">"info"</span>][<span class="string">"name"</span>] = column;
                        indicator[<span class="string">"categories"</span>] = [];
                        indicator[<span class="string">"categories"</span>] = entity;
                        skeleton.indicators.push(indicator);
                    } <span class="keyword">else</span> <span class="keyword">if</span> (isNotRegionOrYearColumn &amp;&amp; column === entity) {
                        <span class="keyword">var</span> category = {};
                        category[<span class="string">"id"</span>] = column;
                        category[<span class="string">"name"</span>] = column;
                        category[<span class="string">"about"</span>] = <span class="string">""</span>;
                        category[<span class="string">"count"</span>] = rows.length - <span class="number">1</span>;
                        category[<span class="string">"things"</span>] = [];
                        skeleton.categories.push(category);
                    }
                }
            }
            setSkeletonCallback(skeleton);
        });
    };
    <span class="keyword">var</span> updateDataRange = <span class="function"><span class="keyword">function</span><span class="params">(indicator, entity, indicatorValues, years)</span> {</span>
        <span class="keyword">if</span> (indicators[timeUnit][entity][indicator][<span class="string">"scope"</span>][<span class="string">"time"</span>]) {
            indicators[timeUnit][entity][indicator][<span class="string">"scope"</span>].value = [ Math.min.apply(Math, indicatorValues), Math.max.apply(Math, indicatorValues) ];
            indicators[timeUnit][entity][indicator][<span class="string">"scope"</span>].time = [ Math.min.apply(Math, years), Math.max.apply(Math, years) ];
        }
    };
    <span class="keyword">var</span> indicatorsLoaded = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">if</span> (<span class="keyword">typeof</span> readIsCompletedCallback === <span class="string">"function"</span>) {
            readIsCompletedCallback(loadedIndicators, indicators, entityMeta, {}, [], timeUnit);
        }
    };
    <span class="keyword">var</span> updateEntityRanges = <span class="function"><span class="keyword">function</span><span class="params">(category, indicator)</span> {</span>
        <span class="keyword">var</span> entitiesForIndicators = indicators[timeUnit][category][indicator][<span class="string">"years"</span>];
        <span class="keyword">for</span> (<span class="keyword">var</span> entity <span class="keyword">in</span> entitiesForIndicators) {
            <span class="keyword">if</span> (entitiesForIndicators.hasOwnProperty(entity) &amp;&amp; !$.isEmptyObject(entitiesForIndicators[entity][<span class="string">"trends"</span>])) {
                <span class="keyword">var</span> yearKeys = Object.keys(entitiesForIndicators[entity][<span class="string">"trends"</span>]);
                <span class="keyword">var</span> yearsForEntity = yearKeys.map(<span class="function"><span class="keyword">function</span><span class="params">(year)</span> {</span>
                    <span class="keyword">return</span> parseInt(year, <span class="number">10</span>);
                });
                <span class="keyword">var</span> minYear = Math.min.apply(Math, yearsForEntity);
                <span class="keyword">var</span> maxYear = Math.max.apply(Math, yearsForEntity);
                indicators[timeUnit][category][indicator][<span class="string">"years"</span>][entity][<span class="string">"scope"</span>] = {};
                indicators[timeUnit][category][indicator][<span class="string">"years"</span>][entity][<span class="string">"scope"</span>][<span class="string">"time"</span>] = {};
                indicators[timeUnit][category][indicator][<span class="string">"years"</span>][entity][<span class="string">"scope"</span>][<span class="string">"value"</span>] = {};
                indicators[timeUnit][category][indicator][<span class="string">"years"</span>][entity][<span class="string">"scope"</span>][<span class="string">"time"</span>][<span class="string">"0"</span>] = minYear;
                indicators[timeUnit][category][indicator][<span class="string">"years"</span>][entity][<span class="string">"scope"</span>][<span class="string">"time"</span>][<span class="string">"1"</span>] = maxYear;
                indicators[timeUnit][category][indicator][<span class="string">"years"</span>][entity][<span class="string">"scope"</span>][<span class="string">"value"</span>][<span class="string">"0"</span>] = indicators[timeUnit][category][indicator][<span class="string">"years"</span>][entity][<span class="string">"trends"</span>][minYear].v;
                indicators[timeUnit][category][indicator][<span class="string">"years"</span>][entity][<span class="string">"scope"</span>][<span class="string">"value"</span>][<span class="string">"1"</span>] = indicators[timeUnit][category][indicator][<span class="string">"years"</span>][entity][<span class="string">"trends"</span>][maxYear].v;
            }
        }
    };
    <span class="keyword">return</span> {
        initialize: initialize,
        loadSkeleton: loadSkeleton,
        loadCategory: loadEntities,
        loadIndicators: loadIndicatorData
    };
};

gapminder.dataCube.loaderFacotry = <span class="function"><span class="keyword">function</span><span class="params">(dataFormat)</span> {</span>
    <span class="keyword">var</span> reader;
    <span class="keyword">var</span> getReaderObject = <span class="function"><span class="keyword">function</span><span class="params">(dataFormat)</span> {</span>
        <span class="keyword">switch</span> (dataFormat) {
          <span class="keyword">case</span> <span class="string">"multipleJSON"</span>:
            reader = <span class="keyword">new</span> gapminder.data.readerMultipleJSON();
            <span class="keyword">break</span>;

          <span class="keyword">case</span> <span class="string">"singleCSV"</span>:
            reader = <span class="keyword">new</span> gapminder.data.readerSingleCSV();
            <span class="keyword">break</span>;

          <span class="keyword">case</span> <span class="string">"multipleCSV"</span>:
            reader = <span class="keyword">new</span> gapminder.data.readerMultipleCSV();
            <span class="keyword">break</span>;

          <span class="keyword">case</span> <span class="string">"multiCSV"</span>:
            reader = <span class="keyword">new</span> gapminder.data.readerMultiCSV();
            <span class="keyword">break</span>;

          <span class="keyword">default</span>:        }
        <span class="keyword">return</span> reader;
    };
    <span class="keyword">var</span> initialize = <span class="function"><span class="keyword">function</span><span class="params">(indicators, model, dataPath, indicatorsToLoad, dataIsReady, changedState, language, fileName, timeUnit)</span> {</span>
        reader.initialize(indicators, model, dataPath, indicatorsToLoad, dataIsReady, changedState, language, fileName, timeUnit);
    };
    <span class="keyword">var</span> loadSkeleton = <span class="function"><span class="keyword">function</span><span class="params">(path, loadCallback, fileName, entity)</span> {</span>
        reader.loadSkeleton(path, loadCallback, fileName, entity);
    };
    <span class="keyword">var</span> loadCategory = <span class="function"><span class="keyword">function</span><span class="params">(indicatorsToLoad)</span> {</span>
        reader.loadCategory(indicatorsToLoad);
    };
    <span class="keyword">var</span> loadIndicators = <span class="function"><span class="keyword">function</span><span class="params">(indicatorsToLoad, callback)</span> {</span>
        reader.loadIndicators(indicatorsToLoad, callback);
    };
    getReaderObject(dataFormat);
    <span class="keyword">return</span> {
        getReader: getReaderObject,
        initialize: initialize,
        loadSkeleton: loadSkeleton,
        loadCategory: loadCategory,
        loadIndicators: loadIndicators
    };
};

gapminder.bubbleChart = <span class="function"><span class="keyword">function</span><span class="params">(renderDiv, state)</span> {</span>
    <span class="keyword">var</span> isInteractive;
    <span class="keyword">var</span> chartLabelDiv;
    <span class="keyword">var</span> scatterChart;
    <span class="keyword">var</span> model;
    <span class="keyword">var</span> appSVG;
    <span class="keyword">var</span> timeSlider;
    <span class="keyword">var</span> modelBindCallback;
    <span class="keyword">var</span> setInitialState = <span class="function"><span class="keyword">function</span><span class="params">(state)</span> {</span>
        model = <span class="keyword">new</span> gapminder.bubbleChartModel();
        model.setInit(state, <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
            isInteractive = model.get(<span class="string">"isInteractive"</span>);
            setUpSubviews();
            setUpModelAndUpdate();
            <span class="keyword">if</span> (modelBindCallback) {
                modelBindCallback(model.getAttributes());
            }
        });
    };
    <span class="keyword">var</span> setState = <span class="function"><span class="keyword">function</span><span class="params">(state)</span> {</span>
        model.set(state, <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
            isInteractive = model.get(<span class="string">"isInteractive"</span>);
            setUpModelAndUpdate();
            <span class="keyword">if</span> (modelBindCallback) {
                modelBindCallback(model.getAttributes());
            }
        });
    };
    <span class="keyword">var</span> setUpModelAndUpdate = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> year = model.get(<span class="string">"year"</span>);
        <span class="keyword">var</span> trails = model.get(<span class="string">"trails"</span>);
        $(<span class="string">"#"</span> + chartLabelDiv).html(Math.round(year));
        <span class="keyword">if</span> (isInteractive) {
            timeSlider.update(model);
        }
        scatterChart.update(model);
    };
    <span class="keyword">var</span> setUpSubviews = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        $(document).ready(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
            initializeGuiElements(renderDiv);
            initializeTimeSlider(isInteractive, renderDiv);
            initializeScatterChart(appSVG, renderDiv);
            setTrailsCheckBoxBinding();
        });
    };
    <span class="keyword">var</span> initializeGuiElements = <span class="function"><span class="keyword">function</span><span class="params">(renderDiv)</span> {</span>
        gapminder.guiUtils.initializeLayers(renderDiv, scatterChartModelUpdate, model);
        <span class="keyword">if</span> (isInteractive) {
            gapminder.guiUtils.createTrails(renderDiv);
        }
        chartLabelDiv = gapminder.guiUtils.get(<span class="string">"labelForYear"</span>);
        <span class="keyword">var</span> appDIV = <span class="string">"#"</span> + renderDiv;
        appSVG = d3.select(appDIV).append(<span class="string">"svg"</span>).style({
            display: <span class="string">"block"</span>
        });
    };
    <span class="keyword">var</span> initializeScatterChart = <span class="function"><span class="keyword">function</span><span class="params">(svg, renderDiv)</span> {</span>
        scatterChart = <span class="keyword">new</span> gapminder.vizBubble(scatterChartModelUpdate);
        scatterChart.initialize(svg, renderDiv, model);
    };
    <span class="keyword">var</span> initializeTimeSlider = <span class="function"><span class="keyword">function</span><span class="params">(isInteractive, renderDiv)</span> {</span>
        <span class="keyword">if</span> (isInteractive) {
            gapminder.guiUtils.createTimeSlider(renderDiv);
            timeSlider = <span class="keyword">new</span> gapminder.timeSlider(timeSliderModelUpdate);
            timeSlider.initialize(model);
            timeSlider.setupListeners();
        }
    };
    <span class="keyword">var</span> scatterChartModelUpdate = <span class="function"><span class="keyword">function</span><span class="params">(state)</span> {</span>
        model.set(state, <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
            scatterChart.update(model);
            <span class="keyword">if</span> (modelBindCallback) {
                modelBindCallback(model.getAttributes());
            }
        });
    };
    <span class="keyword">var</span> timeSliderModelUpdate = <span class="function"><span class="keyword">function</span><span class="params">(state)</span> {</span>
        model.set(state, <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
            $(<span class="string">"#"</span> + chartLabelDiv).html(Math.round(model.get(<span class="string">"year"</span>)));
            timeSlider.update(model);
            scatterChart.update(model);
            <span class="keyword">if</span> (modelBindCallback) {
                modelBindCallback(model.getAttributes());
            }
        });
    };
    <span class="keyword">var</span> setTrailsCheckBoxBinding = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        $(document).on(<span class="string">"change"</span>, <span class="string">".ui-trails"</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
            <span class="keyword">if</span> ($(<span class="keyword">this</span>).is(<span class="string">":checked"</span>)) {
                model.set({
                    trails: <span class="string">"standard"</span>
                }, setUpModelAndUpdate);
                <span class="keyword">if</span> (modelBindCallback) {
                    modelBindCallback(model.getAttributes());
                }
            } <span class="keyword">else</span> {
                model.set({
                    trails: <span class="string">"none"</span>
                }, setUpModelAndUpdate);
                <span class="keyword">if</span> (modelBindCallback) {
                    modelBindCallback(model.getAttributes());
                }
            }
        });
    };
    <span class="keyword">var</span> registerModelBindCallback = <span class="function"><span class="keyword">function</span><span class="params">(callback)</span> {</span>
        modelBindCallback = callback;
    };
    setInitialState(state);
    <span class="keyword">return</span> {
        setVizabiState: setInitialState,
        setState: setState,
        setInitialState: setInitialState,
        registerStateBindCallback: registerModelBindCallback
    };
};

gapminder.bubbleChartModel = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
    <span class="keyword">var</span> dataHelper;
    <span class="keyword">var</span> modelIsNotSet = <span class="literal">true</span>;
    <span class="keyword">var</span> stateAttributes = {
        s: {},
        opacity: <span class="number">.5</span>,
        speed: <span class="number">.1</span>,
        zoom: {},
        trails: <span class="string">"none"</span>,
        tSpeed: <span class="number">300</span>,
        action: <span class="string">"multi"</span>,
        enableHistory: <span class="literal">true</span>,
        year: <span class="literal">undefined</span>,
        xIndicator: <span class="literal">undefined</span>,
        yIndicator: <span class="literal">undefined</span>,
        sizeIndicator: <span class="literal">undefined</span>,
        entity: <span class="literal">undefined</span>,
        fraction: <span class="literal">undefined</span>,
        prevYear: <span class="literal">undefined</span>,
        nextYear: <span class="literal">undefined</span>,
        dataPath: <span class="literal">undefined</span>,
        fileFormat: <span class="literal">undefined</span>,
        fileName: <span class="literal">undefined</span>,
        minXValue: <span class="literal">undefined</span>,
        maxXValue: <span class="literal">undefined</span>,
        minYValue: <span class="literal">undefined</span>,
        maxYValue: <span class="literal">undefined</span>,
        xAxisScale: <span class="string">"linear"</span>,
        yAxisScale: <span class="string">"linear"</span>,
        isInteractive: <span class="literal">false</span>,
        xAxisTickValues: <span class="literal">undefined</span>,
        yAxisTickValues: <span class="literal">undefined</span>,
        language: <span class="literal">undefined</span>,
        minFontSize: <span class="literal">undefined</span>,
        maxFontSize: <span class="literal">undefined</span>,
        minBubbleSize: <span class="literal">undefined</span>,
        maxBubbleSize: <span class="literal">undefined</span>,
        positions: {},
        editMode: <span class="literal">false</span>,
        category: []
    };
    <span class="keyword">var</span> initialize = <span class="function"><span class="keyword">function</span><span class="params">(callback, args)</span> {</span>
        dataHelper = <span class="keyword">new</span> gapminder.data.bubbleChartDataHelper(get(<span class="string">"fileFormat"</span>), get(<span class="string">"entity"</span>), get(<span class="string">"fileName"</span>), get(<span class="string">"dataPath"</span>));
        dataHelper.initialize(callback, args);
    };
    <span class="keyword">var</span> setInit = <span class="function"><span class="keyword">function</span><span class="params">(changedState, modelAndDataReadyCallback)</span> {</span>
        console.log(<span class="string">"BUBBLE MODEL SET STATE: "</span>, changedState);
        <span class="keyword">var</span> changedStateAttr = {};
        <span class="keyword">var</span> dataNeedsToBeLoaded = <span class="literal">false</span>;
        <span class="keyword">for</span> (<span class="keyword">var</span> attr <span class="keyword">in</span> changedState) {
            <span class="keyword">if</span> (changedState.hasOwnProperty(attr) &amp;&amp; stateAttributes[attr] !== changedState[attr]) {
                stateAttributes[attr] = changedState[attr];
                changedStateAttr[attr] = changedState[attr];
                <span class="keyword">if</span> (attr.indexOf(<span class="string">"Indicator"</span>) &gt;= <span class="number">0</span> || attr.indexOf(<span class="string">"language"</span>) || attr.indexOf(<span class="string">"dataPath"</span>) || attr.indexOf(<span class="string">"entity"</span>) || attr.indexOf(<span class="string">"category"</span>)) {
                    dataNeedsToBeLoaded = <span class="literal">true</span>;
                }
                <span class="keyword">if</span> (attr === <span class="string">"year"</span>) {
                    updateFraction();
                }
            }
        }
        console.log(<span class="string">"What changed: "</span>, changedStateAttr);
        initialize(processWithCallback, [ <span class="keyword">this</span>, dataNeedsToBeLoaded, changedStateAttr, modelAndDataReadyCallback ]);
    };
    <span class="keyword">var</span> set = <span class="function"><span class="keyword">function</span><span class="params">(changedState, modelAndDataReadyCallback)</span> {</span>
        console.log(<span class="string">"BUBBLE MODEL SET STATE: "</span>, changedState);
        <span class="keyword">var</span> changedStateAttr = {};
        <span class="keyword">var</span> dataNeedsToBeLoaded = <span class="literal">false</span>;
        <span class="keyword">for</span> (<span class="keyword">var</span> attr <span class="keyword">in</span> changedState) {
            <span class="keyword">if</span> (changedState.hasOwnProperty(attr) &amp;&amp; stateAttributes[attr] !== changedState[attr]) {
                stateAttributes[attr] = changedState[attr];
                changedStateAttr[attr] = changedState[attr];
                <span class="keyword">if</span> (attr.indexOf(<span class="string">"Indicator"</span>) &gt;= <span class="number">0</span> || attr.indexOf(<span class="string">"language"</span>) || attr.indexOf(<span class="string">"dataPath"</span>) || attr.indexOf(<span class="string">"entity"</span>) || attr.indexOf(<span class="string">"category"</span>)) {
                    dataNeedsToBeLoaded = <span class="literal">true</span>;
                }
                <span class="keyword">if</span> (attr === <span class="string">"year"</span>) {
                    updateFraction();
                }
            }
        }
        console.log(<span class="string">"What changed: "</span>, changedStateAttr);
        processWithCallback(<span class="keyword">this</span>, dataNeedsToBeLoaded, changedStateAttr, modelAndDataReadyCallback);
    };
    <span class="keyword">var</span> processWithCallback = <span class="function"><span class="keyword">function</span><span class="params">(model, dataNeedsToBeLoaded, changedStateAttributes, modelAndDataIsReadyCallback)</span> {</span>
        <span class="keyword">var</span> isStateValid = isValidState();
        <span class="keyword">if</span> (dataNeedsToBeLoaded &amp;&amp; <span class="keyword">typeof</span> modelAndDataIsReadyCallback === <span class="string">"function"</span>) {
            dataHelper.validateState(model, changedStateAttributes, modelAndDataIsReadyCallback, isStateValid);
        } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> modelAndDataIsReadyCallback === <span class="string">"function"</span>) {
            modelAndDataIsReadyCallback();
        }
    };
    <span class="keyword">var</span> get = <span class="function"><span class="keyword">function</span><span class="params">(state)</span> {</span>
        <span class="keyword">return</span> stateAttributes[state];
    };
    <span class="keyword">var</span> updateFraction = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> year = stateAttributes.year;
        stateAttributes.fraction = year - Math.floor(year);
        stateAttributes.prevYear = Math.floor(year);
        stateAttributes.nextYear = Math.ceil(year);
    };
    <span class="keyword">var</span> getDataHelper = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">return</span> dataHelper;
    };
    <span class="keyword">var</span> getAttributes = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">return</span> stateAttributes;
    };
    <span class="keyword">var</span> isValidState = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> xIndicator = get(<span class="string">"xIndicator"</span>);
        <span class="keyword">var</span> yIndicator = get(<span class="string">"yIndicator"</span>);
        <span class="keyword">var</span> sizeIndicator = get(<span class="string">"sizeIndicator"</span>);
        <span class="keyword">var</span> dataPath = get(<span class="string">"dataPath"</span>);
        <span class="keyword">if</span> (xIndicator &amp;&amp; yIndicator &amp;&amp; sizeIndicator &amp;&amp; dataPath) {
            <span class="keyword">return</span> <span class="literal">true</span>;
        } <span class="keyword">else</span> {
            <span class="keyword">return</span> <span class="literal">false</span>;
        }
    };
    <span class="keyword">var</span> setIndicatorForInvalidState = <span class="function"><span class="keyword">function</span><span class="params">(changedState, x, y, size)</span> {</span>
        stateAttributes.xIndicator = x;
        stateAttributes.yIndicator = y;
        stateAttributes.sizeIndicator = size;
        <span class="keyword">return</span> {
            xIndicator: x,
            yIndicator: y,
            sizeIndicator: size
        };
    };
    <span class="keyword">return</span> {
        set: set,
        get: get,
        getDataHelper: getDataHelper,
        getAttributes: getAttributes,
        setIndicatorForInvalidState: setIndicatorForInvalidState,
        initialize: initialize,
        setInit: setInit
    };
};

gapminder.data.bubbleChartDataHelper = <span class="function"><span class="keyword">function</span><span class="params">(fileFormat, entityName, fileName, dataPathUri)</span> {</span>
    <span class="keyword">var</span> dataCube;
    <span class="keyword">var</span> indicators;
    <span class="keyword">var</span> entityMeta;
    <span class="keyword">var</span> yAxisName;
    <span class="keyword">var</span> xAxisName;
    <span class="keyword">var</span> yAxisInfo;
    <span class="keyword">var</span> xAxisInfo;
    <span class="keyword">var</span> dataHelperModel;
    <span class="keyword">var</span> dataSetInfo;
    <span class="keyword">var</span> renderCallback;
    <span class="keyword">var</span> chartFooter;
    <span class="keyword">var</span> regionsList;
    <span class="keyword">var</span> timeUnit;
    <span class="keyword">var</span> skeleton;
    <span class="keyword">var</span> colorScale = d3.scale.category20();
    <span class="keyword">var</span> colors = {
        America: {
            fill: <span class="string">"#80EC00"</span>,
            stroke: <span class="string">"#038000"</span>
        },
        Europe: {
            fill: <span class="string">"#FFE800"</span>,
            stroke: <span class="string">"#CF6112"</span>
        },
        Africa: {
            fill: <span class="string">"#00D6EA"</span>,
            stroke: <span class="string">"#07579C"</span>
        },
        Asia: {
            fill: <span class="string">"#FF5973"</span>,
            stroke: <span class="string">"#960570"</span>
        },
        bra: {
            fill: <span class="string">"#80EC00"</span>,
            stroke: <span class="string">"#038000"</span>
        },
        ind: {
            fill: <span class="string">"#FF5973"</span>,
            stroke: <span class="string">"#960570"</span>
        },
        ind_kind: {
            fill: <span class="string">"#D6CBBA"</span>,
            stroke: <span class="string">"#D6CBBA"</span>
        },
        bra_kind: {
            fill: <span class="string">"#FFFF00"</span>,
            stroke: <span class="string">"#000000"</span>
        },
        rest: {
            fill: <span class="string">"#D6CBBA"</span>,
            stroke: <span class="string">"#D6CBBA"</span>
        },
        IND: {
            fill: <span class="string">"#FF5973"</span>,
            stroke: <span class="string">"#960570"</span>
        },
        BRA: {
            fill: <span class="string">"#FFFF00"</span>,
            stroke: <span class="string">"#000000"</span>
        },
        AME: {
            fill: <span class="string">"#80EC00"</span>,
            stroke: <span class="string">"#038000"</span>
        },
        EUR: {
            fill: <span class="string">"#FFE800"</span>,
            stroke: <span class="string">"#CF6112"</span>
        },
        AFR: {
            fill: <span class="string">"#00D6EA"</span>,
            stroke: <span class="string">"#07579C"</span>
        },
        ASI: {
            fill: <span class="string">"#FF5973"</span>,
            stroke: <span class="string">"#960570"</span>
        }
    };
    <span class="keyword">var</span> initialize = <span class="function"><span class="keyword">function</span><span class="params">(callback, args)</span> {</span>
        <span class="keyword">var</span> options = {
            dataFormat: fileFormat,
            entity: entityName,
            fileName: fileName,
            dataPath: dataPathUri
        };
        dataCube = <span class="keyword">new</span> gapminder.dataCube();
        dataCube.initialize(options, <span class="function"><span class="keyword">function</span><span class="params">(skeletonObj)</span> {</span>
            skeleton = skeletonObj;
            callback(args[<span class="number">0</span>], args[<span class="number">1</span>], args[<span class="number">2</span>], args[<span class="number">3</span>]);
        });
    };
    <span class="keyword">var</span> get = <span class="function"><span class="keyword">function</span><span class="params">(indicator, entity, year, appModel, category)</span> {</span>
        <span class="keyword">var</span> prevYear = appModel.get(<span class="string">"prevYear"</span>);
        <span class="keyword">var</span> nextYear = appModel.get(<span class="string">"nextYear"</span>);
        <span class="keyword">var</span> fraction = appModel.get(<span class="string">"fraction"</span>);
        <span class="keyword">var</span> entityIndicator = indicators[timeUnit][category][indicator][<span class="string">"years"</span>][entity];
        <span class="keyword">if</span> (entityIndicator &amp;&amp; entityIndicator[<span class="string">"trends"</span>][prevYear] &amp;&amp; entityIndicator[<span class="string">"trends"</span>][nextYear]) {
            <span class="keyword">return</span> interpolateValueBetweenYears(entityIndicator[<span class="string">"trends"</span>][prevYear].v, entityIndicator[<span class="string">"trends"</span>][nextYear].v, fraction);
        }
    };
    <span class="keyword">var</span> validateState = <span class="function"><span class="keyword">function</span><span class="params">(model, changedState, callback, isValid)</span> {</span>
        dataHelperModel = model;
        renderCallback = callback;
        <span class="keyword">var</span> fileName = model.get(<span class="string">"fileName"</span>);
        <span class="keyword">var</span> entity = model.get(<span class="string">"entity"</span>);
        <span class="keyword">var</span> dataPath = model.get(<span class="string">"dataPath"</span>);
        <span class="keyword">if</span> (!isValid) {
            setValidStateParams(model, changedState, loadNestedData);
        } <span class="keyword">else</span> {
            loadNestedData(model, changedState);
        }
    };
    <span class="keyword">var</span> loadNestedData = <span class="function"><span class="keyword">function</span><span class="params">(model, changedState)</span> {</span>
        <span class="keyword">var</span> dataPath = model.get(<span class="string">"dataPath"</span>);
        <span class="keyword">var</span> indicatorsToLoad = getIndicatorsToLoad(model, dataPath, changedState);
        console.log(<span class="string">"Indicators to Load "</span>, indicatorsToLoad);
        dataCube.loadNestedData(model, changedState, dataIsReady, indicatorsToLoad);
    };
    <span class="keyword">var</span> getEntityLayerObject = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> entities = [];
        $.each(entityMeta, <span class="function"><span class="keyword">function</span><span class="params">(index, geoName)</span> {</span>
            <span class="keyword">var</span> entity = {
                id: index,
                max: get(dataHelperModel.get(<span class="string">"sizeIndicator"</span>), index, getMaxYear(), dataHelperModel, geoName[<span class="number">0</span>].parent)
            };
            entities.push(entity);
        });
        <span class="keyword">return</span> entities;
    };
    <span class="keyword">var</span> dataIsReady = <span class="function"><span class="keyword">function</span><span class="params">(entityObj, indicatorsObj, chartInfo, regions)</span> {</span>
        indicators = $.extend(<span class="literal">true</span>, indicators, indicatorsObj);
        console.log(indicators);
        setTimeUnit();
        entityMeta = $.extend(<span class="literal">true</span>, entityMeta, entityObj);
        <span class="keyword">if</span> (regions) {
            regionsList = regions;
        }
        setDatasetAndChartInfo(chartInfo);
        setAxesNameAndInfo();
        renderCallback();
    };
    <span class="keyword">var</span> setTimeUnit = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">for</span> (<span class="keyword">var</span> unit <span class="keyword">in</span> indicators) {
            <span class="keyword">if</span> (indicators.hasOwnProperty(unit)) {
                timeUnit = unit;
            }
        }
    };
    <span class="keyword">var</span> getIndicatorsToLoad = <span class="function"><span class="keyword">function</span><span class="params">(model)</span> {</span>
        <span class="keyword">var</span> dataPath = model.get(<span class="string">"dataPath"</span>);
        <span class="keyword">var</span> entity = model.get(<span class="string">"entity"</span>);
        <span class="keyword">var</span> indicatorsToLoad = {};
        <span class="keyword">var</span> categories = model.get(<span class="string">"category"</span>);
        <span class="keyword">var</span> indicators = [ model.get(<span class="string">"xIndicator"</span>), model.get(<span class="string">"yIndicator"</span>), model.get(<span class="string">"sizeIndicator"</span>) ];
        <span class="keyword">var</span> skeletonCategories = skeleton.categories;
        <span class="keyword">if</span> (categories.length === <span class="number">0</span>) {
            categories.push(entity);
        }
        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; categories.length; i++) {
            indicatorsToLoad[categories[i]] = [];
            <span class="keyword">if</span> (skeletonCategories &amp;&amp; skeletonCategories.length &gt; <span class="number">0</span>) {
                <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; skeletonCategories.length; j++) {
                    <span class="keyword">if</span> (categories[i] === skeletonCategories[j].id) {
                        <span class="keyword">var</span> loadedIndicators = skeletonCategories[j].things;
                        <span class="keyword">if</span> (loadedIndicators.length &gt; <span class="number">0</span>) {
                            <span class="keyword">for</span> (k = <span class="number">0</span>; k &lt; indicators.length; k++) {
                                <span class="keyword">var</span> indicatorLoaded = <span class="literal">false</span>;
                                <span class="keyword">for</span> (<span class="keyword">var</span> m = <span class="number">0</span>; m &lt; loadedIndicators.length; m++) {
                                    <span class="keyword">if</span> (loadedIndicators[m] === indicators[k]) {
                                        indicatorLoaded = <span class="literal">true</span>;
                                    }
                                }
                                <span class="keyword">if</span> (!indicatorLoaded) {
                                    indicatorsToLoad[categories[i]].push(indicators[k]);
                                }
                            }
                        } <span class="keyword">else</span> {
                            <span class="keyword">for</span> (<span class="keyword">var</span> k = <span class="number">0</span>; k &lt; indicators.length; k++) {
                                indicatorsToLoad[categories[i]].push(indicators[k]);
                            }
                        }
                    }
                }
            } <span class="keyword">else</span> {
                <span class="keyword">for</span> (<span class="keyword">var</span> k = <span class="number">0</span>; k &lt; indicators.length; k++) {
                    indicatorsToLoad[categories[i]].push(indicators[k]);
                }
            }
        }
        <span class="keyword">for</span> (<span class="keyword">var</span> category <span class="keyword">in</span> indicatorsToLoad) {
            <span class="keyword">if</span> (indicatorsToLoad.hasOwnProperty(category)) {
                <span class="keyword">if</span> (indicatorsToLoad[category].length === <span class="number">0</span>) {
                    <span class="keyword">delete</span> indicatorsToLoad[category];
                }
            }
        }
        <span class="keyword">return</span> indicatorsToLoad;
    };
    <span class="keyword">var</span> setValidStateParams = <span class="function"><span class="keyword">function</span><span class="params">(model, changedState, setValidModelCallback)</span> {</span>
        <span class="keyword">var</span> dataPath = model.get(<span class="string">"dataPath"</span>);
        console.warn(<span class="string">"State is invalid. Loading indicators from "</span> + dataPath + <span class="string">"indicators.csv"</span>);
        changedState = $.extend(<span class="literal">true</span>, changedState, model.setIndicatorForInvalidState(changedState, skeleton.indicators[<span class="number">0</span>].id, skeleton.indicators[<span class="number">1</span>].id, skeleton.indicators[<span class="number">2</span>].id));
        loadNestedData(model, changedState);
    };
    <span class="keyword">var</span> getRangeOfIndicators = <span class="function"><span class="keyword">function</span><span class="params">(indicator, isMax)</span> {</span>
        <span class="keyword">var</span> index = <span class="number">0</span>;
        <span class="keyword">var</span> indicatorName = dataHelperModel.get(indicator);
        <span class="keyword">var</span> rangeOfIndicators = [];
        <span class="keyword">if</span> (isMax) {
            index = <span class="number">1</span>;
        }
        <span class="keyword">for</span> (<span class="keyword">var</span> entity <span class="keyword">in</span> indicators[timeUnit]) {
            <span class="keyword">if</span> (indicators[timeUnit].hasOwnProperty(entity)) {
                <span class="keyword">for</span> (<span class="keyword">var</span> ind <span class="keyword">in</span> indicators[timeUnit][entity]) {
                    <span class="keyword">if</span> (ind === indicatorName) {
                        rangeOfIndicators.push(indicators[timeUnit][entity][ind][<span class="string">"scope"</span>][<span class="string">"value"</span>][index]);
                    }
                }
            }
        }
        <span class="keyword">var</span> rangeValue;
        <span class="keyword">if</span> (isMax) {
            rangeValue = Math.max.apply(Math, rangeOfIndicators);
        } <span class="keyword">else</span> {
            rangeValue = Math.min.apply(Math, rangeOfIndicators);
        }
        <span class="keyword">return</span> rangeValue;
    };
    <span class="keyword">var</span> getTimeRange = <span class="function"><span class="keyword">function</span><span class="params">(isMax)</span> {</span>
        <span class="keyword">var</span> index = <span class="number">0</span>;
        <span class="keyword">var</span> rangeOfIndicators = [];
        <span class="keyword">if</span> (isMax) {
            index = <span class="number">1</span>;
        }
        <span class="keyword">for</span> (<span class="keyword">var</span> entity <span class="keyword">in</span> indicators[timeUnit]) {
            <span class="keyword">if</span> (indicators[timeUnit].hasOwnProperty(entity)) {
                <span class="keyword">for</span> (<span class="keyword">var</span> indicatorName <span class="keyword">in</span> indicators[timeUnit][entity]) {
                    <span class="keyword">if</span> (indicators[timeUnit][entity].hasOwnProperty(indicatorName)) {
                        rangeOfIndicators.push(indicators[timeUnit][entity][indicatorName][<span class="string">"scope"</span>][<span class="string">"time"</span>][index]);
                    }
                }
            }
        }
        <span class="keyword">return</span> Math.max.apply(Math, rangeOfIndicators);
    };
    <span class="keyword">var</span> getDataObject = <span class="function"><span class="keyword">function</span><span class="params">(year)</span> {</span>
        <span class="keyword">var</span> currentEntities = [];
        <span class="keyword">var</span> category = dataHelperModel.get(<span class="string">"entity"</span>) || dataHelperModel.get(<span class="string">"category"</span>);
        $.each(entityMeta, <span class="function"><span class="keyword">function</span><span class="params">(index, geoName)</span> {</span>
            currentEntities[index] = [];
            <span class="keyword">var</span> entityCategory = geoName[<span class="number">0</span>].parent;
            <span class="keyword">if</span> (category.indexOf(entityCategory) &gt;= <span class="number">0</span>) {
                <span class="keyword">var</span> o = {};
                o.id = index;
                o.x = get(dataHelperModel.get(<span class="string">"xIndicator"</span>), index, year, dataHelperModel, entityCategory);
                o.y = get(dataHelperModel.get(<span class="string">"yIndicator"</span>), index, year, dataHelperModel, entityCategory);
                o.size = get(dataHelperModel.get(<span class="string">"sizeIndicator"</span>), index, year, dataHelperModel, entityCategory);
                o.color = getColor(index, <span class="string">"fill"</span>, entityCategory);
                o.year = year;
                o.category = entityCategory;
                <span class="keyword">if</span> (o.x &amp;&amp; o.y &amp;&amp; o.size) {
                    currentEntities[index].push(o);
                }
            }
        });
        <span class="keyword">return</span> currentEntities;
    };
    <span class="keyword">var</span> getEntityMeta = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">return</span> entityMeta;
    };
    <span class="keyword">var</span> getNestedData = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">return</span> indicators;
    };
    <span class="keyword">var</span> getMaxOfXIndicator = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">return</span> getRangeOfIndicators(<span class="string">"xIndicator"</span>, <span class="literal">true</span>);
    };
    <span class="keyword">var</span> getMinOfXIndicator = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">return</span> getRangeOfIndicators(<span class="string">"xIndicator"</span>, <span class="literal">false</span>);
    };
    <span class="keyword">var</span> getMaxOfYIndicator = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">return</span> getRangeOfIndicators(<span class="string">"yIndicator"</span>, <span class="literal">true</span>);
    };
    <span class="keyword">var</span> getMinOfYIndicator = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">return</span> getRangeOfIndicators(<span class="string">"yIndicator"</span>, <span class="literal">false</span>);
    };
    <span class="keyword">var</span> getMinOfSizeIndicator = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">return</span> getRangeOfIndicators(<span class="string">"sizeIndicator"</span>, <span class="literal">false</span>);
    };
    <span class="keyword">var</span> getMaxOfSizeIndicator = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">return</span> getRangeOfIndicators(<span class="string">"sizeIndicator"</span>, <span class="literal">true</span>);
    };
    <span class="keyword">var</span> getMinYear = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">return</span> getTimeRange(<span class="literal">false</span>);
    };
    <span class="keyword">var</span> getMaxYear = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">return</span> getTimeRange(<span class="literal">true</span>);
    };
    <span class="keyword">var</span> getChartInfo = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">return</span> dataSetInfo;
    };
    <span class="keyword">var</span> getChartFooter = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">return</span> chartFooter;
    };
    <span class="keyword">var</span> getAxisNames = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">return</span> [ xAxisName, yAxisName ];
    };
    <span class="keyword">var</span> getAxisInfo = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">return</span> [ xAxisInfo, yAxisInfo ];
    };
    <span class="keyword">var</span> getColor = <span class="function"><span class="keyword">function</span><span class="params">(id, type, category)</span> {</span>
        <span class="keyword">var</span> region = entityMeta[id][<span class="number">0</span>].region;
        <span class="keyword">if</span> (colors[region]) {
            <span class="keyword">return</span> colors[region][type];
        } <span class="keyword">else</span> <span class="keyword">if</span> (regionsList.length &gt; <span class="number">0</span>) {
            <span class="keyword">return</span> colorScale(regionsList.indexOf(region));
        } <span class="keyword">else</span> {
            <span class="keyword">return</span> <span class="string">"#FF5973"</span>;
        }
    };
    <span class="keyword">var</span> interpolateValueBetweenYears = <span class="function"><span class="keyword">function</span><span class="params">(prevNumber, nextNumber, fraction)</span> {</span>
        <span class="keyword">return</span> prevNumber + (nextNumber - prevNumber) * fraction;
    };
    <span class="keyword">var</span> getName = <span class="function"><span class="keyword">function</span><span class="params">(id, category)</span> {</span>
        <span class="keyword">return</span> entityMeta[id][<span class="number">0</span>].name;
    };
    <span class="keyword">var</span> setDatasetAndChartInfo = <span class="function"><span class="keyword">function</span><span class="params">(chartInfo)</span> {</span>
        <span class="keyword">if</span> (chartInfo) {
            dataSetInfo = chartInfo[<span class="number">0</span>];
            chartFooter = chartInfo[<span class="number">1</span>];
        }
    };
    <span class="keyword">var</span> setAxesNameAndInfo = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> xIndicator = dataHelperModel.get(<span class="string">"xIndicator"</span>);
        <span class="keyword">var</span> yIndicator = dataHelperModel.get(<span class="string">"yIndicator"</span>);
        <span class="keyword">for</span> (<span class="keyword">var</span> entity <span class="keyword">in</span> indicators[timeUnit]) {
            <span class="keyword">if</span> (indicators[timeUnit].hasOwnProperty(entity)) {
                <span class="keyword">for</span> (<span class="keyword">var</span> indicatorName <span class="keyword">in</span> indicators[timeUnit][entity]) {
                    <span class="keyword">if</span> (indicators[timeUnit][entity].hasOwnProperty(indicatorName) &amp;&amp; indicatorName == xIndicator) {
                        xAxisInfo = indicators[timeUnit][entity][indicatorName][<span class="string">"info"</span>].info;
                        xAxisName = indicators[timeUnit][entity][indicatorName][<span class="string">"info"</span>].name;
                    } <span class="keyword">else</span> <span class="keyword">if</span> (indicators[timeUnit][entity].hasOwnProperty(indicatorName) &amp;&amp; indicatorName == yIndicator) {
                        yAxisInfo = indicators[timeUnit][entity][indicatorName][<span class="string">"info"</span>].info;
                        yAxisName = indicators[timeUnit][entity][indicatorName][<span class="string">"info"</span>].name;
                    }
                }
            }
        }
    };
    <span class="keyword">var</span> getDataForYear = <span class="function"><span class="keyword">function</span><span class="params">(indicator, entity, year, category)</span> {</span>
        <span class="keyword">return</span> indicators[timeUnit][category][indicator][<span class="string">"years"</span>][entity][<span class="string">"trends"</span>][year].v;
    };
    <span class="keyword">return</span> {
        validateState: validateState,
        getEntityMeta: getEntityMeta,
        getNestedData: getNestedData,
        getMaxOfXIndicator: getMaxOfXIndicator,
        getMinOfXIndicator: getMinOfXIndicator,
        getMaxOfYIndicator: getMaxOfYIndicator,
        getMinOfYIndicator: getMinOfYIndicator,
        getMinOfSizeIndicator: getMinOfSizeIndicator,
        getMaxOfSizeIndicator: getMaxOfSizeIndicator,
        getMinYear: getMinYear,
        getMaxYear: getMaxYear,
        getChartInfo: getChartInfo,
        getChartFooter: getChartFooter,
        getAxisNames: getAxisNames,
        getAxisInfo: getAxisInfo,
        getEntityLayerObject: getEntityLayerObject,
        getDataObject: getDataObject,
        getColor: getColor,
        get: get,
        getName: getName,
        getDataForYear: getDataForYear,
        initialize: initialize
    };
};

gapminder.vizBubble = <span class="function"><span class="keyword">function</span><span class="params">(callback)</span> {</span>
    <span class="keyword">var</span> svg;
    <span class="keyword">var</span> scatterContainer;
    <span class="keyword">var</span> labelLayer;
    <span class="keyword">var</span> width = <span class="number">300</span>;
    <span class="keyword">var</span> height = <span class="number">300</span>;
    <span class="keyword">var</span> countryLayers;
    <span class="keyword">var</span> linkLayer;
    <span class="keyword">var</span> xScale;
    <span class="keyword">var</span> yScale;
    <span class="keyword">var</span> bubbleSizeScale;
    <span class="keyword">var</span> fontSizeScale;
    <span class="keyword">var</span> availableWidth;
    <span class="keyword">var</span> availableHeight;
    <span class="keyword">var</span> chartRenderDiv;
    <span class="keyword">var</span> vizState;
    <span class="keyword">var</span> vizStateChangeCallback = callback;
    <span class="keyword">var</span> vizData;
    <span class="keyword">var</span> isInteractive;
    <span class="keyword">var</span> labelAngel = <span class="string">"-0.5"</span>;
    <span class="keyword">var</span> labelPositionInteractive = <span class="string">"_50"</span>;
    <span class="keyword">var</span> vizChart;
    <span class="keyword">var</span> vizBubblePrint;
    <span class="keyword">var</span> update = <span class="function"><span class="keyword">function</span><span class="params">(state)</span> {</span>
        vizState = state;
        updateLayout();
        updateEntityLayers();
        renderCurrentBubbles();
    };
    <span class="keyword">var</span> initializeLayers = <span class="function"><span class="keyword">function</span><span class="params">(root, renderDiv, state)</span> {</span>
        chartRenderDiv = renderDiv + <span class="string">"-scatterChart"</span>;
        vizState = state;
        isInteractive = state.get(<span class="string">"isInteractive"</span>);
        vizChart = <span class="keyword">new</span> gapminder.viz.chartGrid();
        vizChart.initializeLayers(root, renderDiv);
        <span class="keyword">if</span> (!isInteractive) {
            vizBubblePrint = <span class="keyword">new</span> gapminder.viz.vizBubblePrint(chartRenderDiv, vizState, vizStateChangeCallback);
            vizBubblePrint.registerClickEventListerners();
            vizBubblePrint.registerAlignButtonsEventListeners();
        }
    };
    <span class="keyword">var</span> updateLayout = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> scaleFunctions = vizChart.updateLayout(vizState);
        xScale = scaleFunctions[<span class="number">0</span>];
        yScale = scaleFunctions[<span class="number">1</span>];
        <span class="keyword">var</span> availableFrame = vizChart.getAvailableHeightAndWidth();
        availableHeight = availableFrame[<span class="number">0</span>];
        availableWidth = availableFrame[<span class="number">1</span>];
        setBubbleAndFontSizeScale();
        setUpChartInfoDivs();
    };
    <span class="keyword">var</span> setBubbleAndFontSizeScale = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">if</span> (!vizState.get(<span class="string">"minBubbleSize"</span>) &amp;&amp; !vizState.get(<span class="string">"maxBubbleSize"</span>)) {
            bubbleSizeScale = d3.scale.sqrt().domain([ vizState.getDataHelper().getMinOfSizeIndicator(), vizState.getDataHelper().getMaxOfSizeIndicator() ]).range([ <span class="number">1</span>, <span class="number">30</span> ]).exponent(<span class="number">.5</span>);
        } <span class="keyword">else</span> {
            bubbleSizeScale = d3.scale.sqrt().domain([ vizState.getDataHelper().getMinOfSizeIndicator(), vizState.getDataHelper().getMaxOfSizeIndicator() ]).range([ vizState.get(<span class="string">"minBubbleSize"</span>), vizState.get(<span class="string">"maxBubbleSize"</span>) ]).exponent(<span class="number">.5</span>);
        }
        <span class="keyword">if</span> (!vizState.get(<span class="string">"minFontSize"</span>) &amp;&amp; !vizState.get(<span class="string">"maxFontSize"</span>)) {
            fontSizeScale = d3.scale.sqrt().domain([ <span class="number">0</span>, <span class="number">1e9</span> ]).range([ <span class="number">7</span>, <span class="number">25</span> ]).exponent(<span class="number">.5</span>);
        } <span class="keyword">else</span> {
            fontSizeScale = d3.scale.sqrt().domain([ <span class="number">0</span>, <span class="number">1e9</span> ]).range([ vizState.get(<span class="string">"minFontSize"</span>), vizState.get(<span class="string">"maxFontSize"</span>) ]).exponent(<span class="number">.5</span>);
        }
    };
    <span class="keyword">var</span> updateEntityLayers = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        countryLayers = vizState.getDataHelper().getEntityLayerObject();
        <span class="keyword">var</span> entityLayers = d3.select(<span class="string">"#"</span> + chartRenderDiv + <span class="string">" .scatterContainer"</span>).selectAll(<span class="string">".entityLayer"</span>).data(countryLayers, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> d.id;
        });
        <span class="keyword">var</span> entityLayer = entityLayers.enter().append(<span class="string">"g"</span>).attr(<span class="string">"class"</span>, <span class="string">"entityLayer"</span>).attr(<span class="string">"name"</span>, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> d.id;
        }).attr(<span class="string">"id"</span>, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> d.id;
        });
        entityLayers.sort(<span class="function"><span class="keyword">function</span><span class="params">(a, b)</span> {</span>
            <span class="keyword">return</span> b.max - a.max;
        });
        entityLayers.exit().remove();
    };
    <span class="keyword">var</span> renderCurrentBubbles = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> year = vizState.get(<span class="string">"year"</span>);
        <span class="keyword">var</span> s = vizState.get(<span class="string">"s"</span>);
        <span class="keyword">var</span> opacity = vizState.get(<span class="string">"opacity"</span>);
        <span class="keyword">var</span> trails = vizState.get(<span class="string">"trails"</span>);
        <span class="keyword">var</span> category = vizState.get(<span class="string">"entity"</span>) || vizState.get(<span class="string">"category"</span>);
        <span class="keyword">var</span> currentEntities = vizState.getDataHelper().getDataObject(year);
        <span class="keyword">var</span> bubbles = d3.select(<span class="string">"#"</span> + chartRenderDiv).selectAll(<span class="string">".entityLayer"</span>).data(countryLayers, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> d.id;
        }).selectAll(<span class="string">".currentEntity"</span>).data(<span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">var</span> id = d.id;
            <span class="keyword">return</span> currentEntities[id];
        });
        bubbles.enter().append(<span class="string">"circle"</span>).attr(<span class="string">"class"</span>, <span class="string">"currentEntity"</span>).attr(<span class="string">"name"</span>, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> d.id;
        }).attr(<span class="string">"stroke-width"</span>, <span class="string">"0.8pt"</span>).attr(<span class="string">"stroke"</span>, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> vizState.getDataHelper().getColor(d.id, <span class="string">"stroke"</span>, d.category);
        }).attr(<span class="string">"fill"</span>, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> vizState.getDataHelper().getColor(d.id, <span class="string">"fill"</span>, d.category);
        }).attr(<span class="string">"pointer-events"</span>, <span class="string">"all"</span>).attr(<span class="string">"cursor"</span>, <span class="string">"pointer"</span>);
        <span class="keyword">if</span> (isInteractive) {
            bubbles.on(<span class="string">"click"</span>, bubbleClickHandler).on(<span class="string">"mouseover"</span>, bubbleOverHandler).on(<span class="string">"mouseout"</span>, bubbleOutHandler);
        } <span class="keyword">else</span> {
            bubbles.on(<span class="string">"click"</span>, vizBubblePrint.bubbleClickHandlerPrint);
        }
        bubbles.attr(<span class="string">"cx"</span>, <span class="function"><span class="keyword">function</span><span class="params">(d, i)</span> {</span>
            <span class="keyword">return</span> xScale(d.x);
        }).attr(<span class="string">"cy"</span>, <span class="function"><span class="keyword">function</span><span class="params">(d, i)</span> {</span>
            <span class="keyword">return</span> yScale(d.y);
        }).attr(<span class="string">"r"</span>, <span class="function"><span class="keyword">function</span><span class="params">(d, i)</span> {</span>
            <span class="keyword">return</span> bubbleSizeScale(d.size);
        });
        bubbles.exit().remove();
        drawTrails();
        updateSelected();
        drawLabels();
    };
    <span class="keyword">var</span> drawTrails = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> entityLayersData = [];
        <span class="keyword">var</span> entities = vizState.getDataHelper().getEntityMeta();
        <span class="keyword">for</span> (<span class="keyword">var</span> entity <span class="keyword">in</span> entities) {
            <span class="keyword">if</span> (entities.hasOwnProperty(entity)) {
                $.each(entities[entity], <span class="function"><span class="keyword">function</span><span class="params">(index, entityId)</span> {</span>
                    <span class="keyword">var</span> layerData = {
                        id: entityId.id,
                        children: []
                    };
                    entityLayersData.push(layerData);
                    <span class="keyword">var</span> selectedBubbles = vizState.get(<span class="string">"s"</span>);
                    <span class="keyword">var</span> trails = vizState.get(<span class="string">"trails"</span>);
                    <span class="keyword">var</span> id = layerData.id;
                    <span class="keyword">if</span> (id <span class="keyword">in</span> selectedBubbles &amp;&amp; trails === <span class="string">"standard"</span>) {
                        <span class="keyword">var</span> selected = selectedBubbles[id];
                        <span class="keyword">var</span> trailLayerBubble = {
                            id: <span class="string">"trailLayerBubble"</span>,
                            data: []
                        };
                        <span class="keyword">var</span> trailLayerLine = {
                            color: <span class="string">"#000"</span>,
                            id: <span class="string">"trailLayerLine"</span>,
                            data: []
                        };
                        <span class="keyword">var</span> children = layerData.children;
                        children.push(trailLayerLine, trailLayerBubble);
                        <span class="keyword">var</span> trailStart = parseInt(selected.start);
                        <span class="keyword">var</span> year = vizState.get(<span class="string">"year"</span>);
                        <span class="keyword">if</span> (year &lt; trailStart) {
                            trailStart = Math.ceil(year);
                        }
                        <span class="keyword">var</span> trailEnd = parseInt(year);
                        <span class="keyword">if</span> (<span class="string">"end"</span> <span class="keyword">in</span> selected) {
                            trailEnd = parseInt(selected.end);
                        }
                        <span class="keyword">var</span> rangeOfTrailEntities;
                        <span class="keyword">if</span> (vizState.get(<span class="string">"fraction"</span>) === <span class="number">0</span>) {
                            rangeOfTrailEntities = d3.range(trailStart, trailEnd, <span class="number">1</span>);
                        } <span class="keyword">else</span> {
                            rangeOfTrailEntities = d3.range(trailStart, trailEnd + <span class="number">1</span>, <span class="number">1</span>);
                        }
                        <span class="keyword">var</span> trailBubbleData = [];
                        <span class="keyword">var</span> trailEntities = rangeOfTrailEntities.map(<span class="function"><span class="keyword">function</span><span class="params">(year)</span> {</span>
                            <span class="keyword">var</span> o = {};
                            o.x = vizState.getDataHelper().getDataForYear(vizState.get(<span class="string">"xIndicator"</span>), id, year, entityId.parent);
                            o.y = vizState.getDataHelper().getDataForYear(vizState.get(<span class="string">"yIndicator"</span>), id, year, entityId.parent);
                            o.size = vizState.getDataHelper().getDataForYear(vizState.get(<span class="string">"sizeIndicator"</span>), id, year, entityId.parent);
                            o.color = vizState.getDataHelper().getColor(id, <span class="string">"fill"</span>);
                            o.id = id;
                            o.year = year;
                            <span class="keyword">if</span> (o.x &amp;&amp; o.y &amp;&amp; o.size) {
                                trailBubbleData.push(o);
                            }
                        });
                        trailLayerBubble.data = trailBubbleData;
                        trailLayerBubble.data = JSON.parse(JSON.stringify(trailBubbleData));
                        trailLayerLine.color = vizState.getDataHelper().getColor(id, <span class="string">"fill"</span>);
                        console.log(<span class="string">"data"</span>, trailLayerBubble.data, vizState.get(<span class="string">"fraction"</span>));
                        <span class="keyword">var</span> o = {};
                        o.x = vizState.getDataHelper().get(vizState.get(<span class="string">"xIndicator"</span>), id, year, vizState, entityId.parent);
                        o.y = vizState.getDataHelper().get(vizState.get(<span class="string">"yIndicator"</span>), id, year, vizState, entityId.parent);
                        o.size = vizState.getDataHelper().get(vizState.get(<span class="string">"sizeIndicator"</span>), id, year, vizState, entityId.parent);
                        <span class="keyword">if</span> (o.x &amp;&amp; o.y &amp;&amp; o.z) {
                            trailLayerLine.data.push(o);
                        }
                    }
                });
            }
        }
        <span class="keyword">var</span> trailContainers = d3.select(<span class="string">"#"</span> + chartRenderDiv).selectAll(<span class="string">".entityLayer"</span>).data(entityLayersData, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> d.id;
        }).selectAll(<span class="string">".trailContainer"</span>).data(<span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> d.children;
        }, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> d.id;
        });
        trailContainers.enter().insert(<span class="string">"svg:g"</span>, <span class="string">"circle"</span>).attr(<span class="string">"name"</span>, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> d.id;
        }).attr(<span class="string">"class"</span>, <span class="string">"trailContainer"</span>).each(<span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">if</span> (d.id === <span class="string">"trailLayerLine"</span>) {
                d3.select(<span class="keyword">this</span>).append(<span class="string">"svg:path"</span>).attr(<span class="string">"class"</span>, <span class="string">"trailPath"</span>).attr(<span class="string">"fill"</span>, <span class="string">"none"</span>).attr(<span class="string">"stroke-width"</span>, <span class="string">"1.5pt"</span>).attr(<span class="string">"stroke"</span>, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
                    <span class="keyword">return</span> d.color;
                });
            }
        });
        trailContainers.exit().remove();
        <span class="keyword">var</span> line = d3.svg.line().x(<span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> xScale(d.x);
        }).y(<span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> yScale(d.y);
        });
        <span class="keyword">var</span> trailPath = trailContainers.filter(<span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> d.id === <span class="string">"trailLayerLine"</span>;
        }).select(<span class="string">".trailPath"</span>);
        trailPath.attr(<span class="string">"d"</span>, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> line(d.data);
        }).attr(<span class="string">"stroke-opacity"</span>, <span class="number">.6</span>);
        <span class="keyword">var</span> trailBubbles = trailContainers.filter(<span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> d.id == <span class="string">"trailLayerBubble"</span>;
        }).selectAll(<span class="string">".trailEntity"</span>).data(<span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> d.data;
        });
        trailBubbles.enter().append(<span class="string">"svg:circle"</span>).attr(<span class="string">"class"</span>, <span class="string">"trailEntity"</span>).attr(<span class="string">"stroke-width"</span>, <span class="string">"0.5pt"</span>).attr(<span class="string">"cursor"</span>, <span class="string">"pointer"</span>).attr(<span class="string">"fill-opacity"</span>, <span class="number">.6</span>).attr(<span class="string">"stroke-opacity"</span>, <span class="number">.6</span>).on(<span class="string">"click"</span>, bubbleClickHandler).on(<span class="string">"mouseover"</span>, bubbleOverHandler).on(<span class="string">"mouseout"</span>, bubbleOutHandler);
        trailBubbles.attr(<span class="string">"stroke"</span>, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> vizState.getDataHelper().getColor(d.id, <span class="string">"stroke"</span>);
        }).attr(<span class="string">"fill"</span>, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> vizState.getDataHelper().getColor(d.id, <span class="string">"fill"</span>);
        }).attr(<span class="string">"cx"</span>, <span class="function"><span class="keyword">function</span><span class="params">(d, i)</span> {</span>
            <span class="keyword">return</span> xScale(d.x);
        }).attr(<span class="string">"cy"</span>, <span class="function"><span class="keyword">function</span><span class="params">(d, i)</span> {</span>
            <span class="keyword">return</span> yScale(d.y);
        }).attr(<span class="string">"r"</span>, <span class="function"><span class="keyword">function</span><span class="params">(d, i)</span> {</span>
            <span class="keyword">return</span> bubbleSizeScale(d.size);
        });
        trailBubbles.exit().remove();
    };
    <span class="keyword">var</span> updateSelected = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> entityMeta = vizState.getDataHelper().getEntityMeta();
        <span class="keyword">var</span> selected = vizState.get(<span class="string">"s"</span>);
        <span class="keyword">var</span> opacity = vizState.get(<span class="string">"opacity"</span>);
        <span class="keyword">var</span> circles = d3.select(<span class="string">"#"</span> + chartRenderDiv).selectAll(<span class="string">"circle.currentEntity, circle.trailEntity"</span>);
        <span class="keyword">var</span> category = vizState.get(<span class="string">"category"</span>);
        <span class="keyword">var</span> entity = vizState.get(<span class="string">"entity"</span>);
        <span class="keyword">for</span> (<span class="keyword">var</span> id <span class="keyword">in</span> selected) {
            <span class="keyword">if</span> (selected.hasOwnProperty(id)) {
                <span class="keyword">if</span> (entity &amp;&amp; entityMeta[id][<span class="number">0</span>].parent !== entity || category.length &gt; <span class="number">0</span> &amp;&amp; category.indexOf(entityMeta[id][<span class="number">0</span>].parent) === -<span class="number">1</span>) {
                    <span class="keyword">delete</span> selected[id];
                }
            }
        }
        circles.each(<span class="function"><span class="keyword">function</span><span class="params">(d, i)</span> {</span>
            <span class="keyword">if</span> ($.isEmptyObject(selected)) {
                d3.select(<span class="keyword">this</span>).attr(<span class="string">"fill-opacity"</span>, <span class="number">.9</span>);
                d3.select(<span class="keyword">this</span>).attr(<span class="string">"stroke-opacity"</span>, <span class="number">.9</span>);
            } <span class="keyword">else</span> {
                <span class="keyword">var</span> id = d.id;
                <span class="keyword">if</span> (id <span class="keyword">in</span> selected) {
                    d3.select(<span class="keyword">this</span>).attr(<span class="string">"fill-opacity"</span>, <span class="number">.9</span>);
                    d3.select(<span class="keyword">this</span>).attr(<span class="string">"stroke-opacity"</span>, <span class="number">.9</span>);
                } <span class="keyword">else</span> {
                    d3.select(<span class="keyword">this</span>).attr(<span class="string">"fill-opacity"</span>, opacity);
                    d3.select(<span class="keyword">this</span>).attr(<span class="string">"stroke-opacity"</span>, opacity);
                }
            }
        });
    };
    <span class="keyword">var</span> bubbleOverHandler = <span class="function"><span class="keyword">function</span><span class="params">(d, i)</span> {</span>
        <span class="keyword">var</span> id = d.id;
        <span class="keyword">var</span> selected = vizState.get(<span class="string">"s"</span>);
        <span class="keyword">var</span> currentEntity;
        <span class="keyword">var</span> alreadySelected;
        d.year === vizState.get(<span class="string">"year"</span>) ? currentEntity = <span class="literal">true</span> : currentEntity = <span class="literal">false</span>;
        id <span class="keyword">in</span> selected ? alreadySelected = <span class="literal">true</span> : alreadySelected = <span class="literal">false</span>;
        <span class="keyword">if</span> (currentEntity &amp;&amp; alreadySelected) {
            <span class="keyword">return</span> <span class="literal">false</span>;
        }
        <span class="keyword">this</span>.overNode = d3.select(d3.event.target).node();
        <span class="keyword">var</span> overNode = d3.select(<span class="keyword">this</span>.overNode);
        <span class="keyword">var</span> nodeX = parseInt(overNode.attr(<span class="string">"cx"</span>));
        <span class="keyword">var</span> nodeY = parseInt(overNode.attr(<span class="string">"cy"</span>));
        <span class="keyword">var</span> nodeR = parseInt(overNode.attr(<span class="string">"r"</span>));
        <span class="keyword">var</span> nodeFill = overNode.attr(<span class="string">"fill"</span>);
        <span class="keyword">this</span>.highlightNode = <span class="keyword">this</span>.overNode.cloneNode(<span class="literal">true</span>);
        <span class="keyword">var</span> highlightNode = d3.select(<span class="keyword">this</span>.highlightNode).attr(<span class="string">"pointer-events"</span>, <span class="string">"none"</span>).attr(<span class="string">"class"</span>, <span class="string">"highlightNode"</span>).attr(<span class="string">"fill"</span>, <span class="string">"none"</span>).attr(<span class="string">"r"</span>, nodeR + <span class="number">5</span>).attr(<span class="string">"fill-opacity"</span>, <span class="number">1</span>).attr(<span class="string">"stroke-opacity"</span>, <span class="number">1</span>).attr(<span class="string">"stroke-width"</span>, <span class="string">"3px"</span>).attr(<span class="string">"stroke"</span>, nodeFill);
        d3.select(<span class="keyword">this</span>.overNode.parentNode.insertBefore(<span class="keyword">this</span>.highlightNode, <span class="keyword">this</span>.overNode.nextSibling));
        <span class="keyword">this</span>.highlightLabel = d3.select(<span class="string">"#"</span> + chartRenderDiv).select(<span class="string">".labelLayer"</span>).append(<span class="string">"g"</span>).attr(<span class="string">"class"</span>, <span class="string">"highlightLabel"</span>).attr(<span class="string">"pointer-events"</span>, <span class="string">"none"</span>);
        <span class="keyword">var</span> rectNode = <span class="keyword">this</span>.highlightLabel.append(<span class="string">"rect"</span>).attr(<span class="string">"class"</span>, <span class="string">"highlightBG"</span>);
        <span class="keyword">var</span> textNode = <span class="keyword">this</span>.highlightLabel.append(<span class="string">"text"</span>).attr(<span class="string">"x"</span>, <span class="string">"0px"</span>).attr(<span class="string">"y"</span>, <span class="string">"0px"</span>).attr(<span class="string">"font-size"</span>, <span class="string">"20px"</span>).attr(<span class="string">"class"</span>, <span class="string">"entityLabel"</span>).attr(<span class="string">"text-anchor"</span>, <span class="string">"middle"</span>).text(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
            <span class="keyword">var</span> text;
            currentEntity ? text = vizState.getDataHelper().getName(d.id, d.category) : text = vizState.getDataHelper().getName(d.id) + <span class="string">", "</span> + d.year;
            <span class="keyword">return</span> text;
        });
        <span class="keyword">var</span> textNodeBbox = textNode.node().getBBox();
        <span class="keyword">var</span> textNodeBBoxWidth = textNodeBbox.width;
        <span class="keyword">var</span> textNodeBBoxHeight = textNodeBbox.height;
        <span class="keyword">var</span> paddingWidth = <span class="number">8</span>;
        <span class="keyword">var</span> paddingHeight = <span class="number">8</span>;
        rectNode.attr(<span class="string">"width"</span>, textNodeBBoxWidth + paddingWidth).attr(<span class="string">"height"</span>, textNodeBBoxHeight + paddingHeight).attr(<span class="string">"x"</span>, -textNodeBBoxWidth / <span class="number">2</span> - paddingWidth / <span class="number">2</span>).attr(<span class="string">"y"</span>, -textNodeBBoxHeight / <span class="number">2</span> - paddingWidth / <span class="number">2</span>).attr(<span class="string">"fill"</span>, <span class="string">"#fff"</span>).attr(<span class="string">"stroke"</span>, nodeFill).attr(<span class="string">"stroke-width"</span>, <span class="string">"3px"</span>).attr(<span class="string">"ry"</span>, <span class="string">"5px"</span>).attr(<span class="string">"rx"</span>, <span class="string">"5px"</span>);
        <span class="keyword">var</span> bbox = <span class="keyword">this</span>.highlightLabel.node().getBBox();
        <span class="keyword">var</span> preferredX = nodeX + bbox.width / <span class="number">2</span> + nodeR + <span class="number">5</span>;
        <span class="keyword">var</span> preferredY = nodeY - bbox.height / <span class="number">2</span> - nodeR - <span class="number">5</span>;
        <span class="keyword">var</span> coordinates = fitWithinLabelConstraints(bbox, preferredX, preferredY);
        <span class="keyword">this</span>.highlightLabel.attr(<span class="string">"transform"</span>, <span class="string">"translate("</span> + coordinates.x + <span class="string">","</span> + coordinates.y + <span class="string">")"</span>);
        <span class="keyword">this</span>.xValueLabel = d3.select(<span class="string">"#"</span> + chartRenderDiv).select(<span class="string">".labelLayer"</span>).append(<span class="string">"g"</span>).attr(<span class="string">"transform"</span>, <span class="string">"translate("</span> + nodeX + <span class="string">","</span> + (availableHeight + <span class="number">15</span>) + <span class="string">")"</span>).attr(<span class="string">"class"</span>, <span class="string">"xValueLabel"</span>).attr(<span class="string">"pointer-events"</span>, <span class="string">"none"</span>);
        <span class="keyword">var</span> rectNodeX = <span class="keyword">this</span>.xValueLabel.append(<span class="string">"rect"</span>).attr(<span class="string">"class"</span>, <span class="string">"xValueLabelBG"</span>).attr(<span class="string">"fill"</span>, <span class="string">"#fff"</span>).attr(<span class="string">"stroke-width"</span>, <span class="string">"1px"</span>).attr(<span class="string">"ry"</span>, <span class="string">"5px"</span>).attr(<span class="string">"rx"</span>, <span class="string">"5px"</span>).attr(<span class="string">"stroke"</span>, <span class="string">"#999"</span>);
        <span class="keyword">var</span> numFormat2 = d3.format(<span class="string">",g"</span>);
        <span class="keyword">var</span> numberFormat = <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> numFormat2(d.toPrecision(<span class="number">2</span>));
        };
        <span class="keyword">var</span> xValueText = <span class="keyword">this</span>.xValueLabel.append(<span class="string">"text"</span>).attr(<span class="string">"class"</span>, <span class="string">"xValueLabelText"</span>).attr(<span class="string">"text-anchor"</span>, <span class="string">"middle"</span>).attr(<span class="string">"font-weight"</span>, <span class="string">"bold"</span>).attr(<span class="string">"dominant-baseline"</span>, <span class="string">"central"</span>).text(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
            <span class="keyword">return</span> numberFormat(d.x);
        });
        <span class="keyword">var</span> xValueTextWidth = xValueText.node().getBBox().width;
        <span class="keyword">var</span> xValueTextHeight = xValueText.node().getBBox().height;
        rectNodeX.attr(<span class="string">"width"</span>, xValueTextWidth + paddingWidth).attr(<span class="string">"height"</span>, xValueTextHeight + paddingHeight).attr(<span class="string">"x"</span>, -xValueTextWidth / <span class="number">2</span> - paddingWidth / <span class="number">2</span>).attr(<span class="string">"y"</span>, -xValueTextHeight / <span class="number">2</span> - paddingWidth / <span class="number">2</span>);
        <span class="keyword">this</span>.yValueLabel = d3.select(<span class="string">"#"</span> + chartRenderDiv).select(<span class="string">".labelLayer"</span>).append(<span class="string">"g"</span>).attr(<span class="string">"transform"</span>, <span class="string">"translate("</span> + -<span class="number">6</span> + <span class="string">","</span> + nodeY + <span class="string">")"</span>).attr(<span class="string">"class"</span>, <span class="string">"yValueLabel"</span>).attr(<span class="string">"pointer-events"</span>, <span class="string">"none"</span>);
        <span class="keyword">var</span> rectNodeY = <span class="keyword">this</span>.yValueLabel.append(<span class="string">"rect"</span>).attr(<span class="string">"class"</span>, <span class="string">"yValueLabelBG"</span>).attr(<span class="string">"fill"</span>, <span class="string">"#fff"</span>).attr(<span class="string">"stroke-width"</span>, <span class="string">"1px"</span>).attr(<span class="string">"ry"</span>, <span class="string">"5px"</span>).attr(<span class="string">"rx"</span>, <span class="string">"5px"</span>).attr(<span class="string">"stroke"</span>, <span class="string">"#999"</span>);
        <span class="keyword">var</span> yValueText = <span class="keyword">this</span>.yValueLabel.append(<span class="string">"text"</span>).attr(<span class="string">"class"</span>, <span class="string">"yValueLabelTex"</span>).attr(<span class="string">"text-anchor"</span>, <span class="string">"end"</span>).attr(<span class="string">"font-weight"</span>, <span class="string">"bold"</span>).attr(<span class="string">"dominant-baseline"</span>, <span class="string">"central"</span>).text(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
            <span class="keyword">return</span> numberFormat(d.y);
        });
        <span class="keyword">var</span> yValueTextWidth = yValueText.node().getBBox().width;
        <span class="keyword">var</span> yValueTextHeight = yValueText.node().getBBox().height;
        rectNodeY.attr(<span class="string">"width"</span>, yValueTextWidth + paddingWidth).attr(<span class="string">"height"</span>, yValueTextHeight + paddingHeight).attr(<span class="string">"x"</span>, -yValueTextWidth - paddingWidth / <span class="number">2</span>).attr(<span class="string">"y"</span>, -yValueTextHeight / <span class="number">2</span> - paddingWidth / <span class="number">2</span>);
    };
    <span class="keyword">var</span> bubbleOutHandler = <span class="function"><span class="keyword">function</span><span class="params">(name, i)</span> {</span>
        d3.select(<span class="string">"#"</span> + chartRenderDiv).selectAll(<span class="string">".highlightNode"</span>).remove();
        d3.select(<span class="string">"#"</span> + chartRenderDiv).selectAll(<span class="string">".highlightLabel"</span>).remove();
        d3.select(<span class="string">"#"</span> + chartRenderDiv).selectAll(<span class="string">".xValueLabel"</span>).remove();
        d3.select(<span class="string">"#"</span> + chartRenderDiv).selectAll(<span class="string">".yValueLabel"</span>).remove();
    };
    <span class="keyword">var</span> fitWithinLabelConstraints = <span class="function"><span class="keyword">function</span><span class="params">(bbox, x, y)</span> {</span>
        <span class="keyword">var</span> coordinates = {
            x: x,
            y: y
        };
        <span class="keyword">var</span> layerWidth = availableWidth;
        <span class="keyword">var</span> layerHeight = availableHeight;
        <span class="keyword">var</span> padding = <span class="number">5</span>;
        <span class="keyword">var</span> minX = bbox.width / <span class="number">2</span> + padding;
        <span class="keyword">var</span> maxX = layerWidth - bbox.width / <span class="number">2</span> - padding;
        <span class="keyword">var</span> minY = bbox.height / <span class="number">2</span> + padding;
        <span class="keyword">var</span> maxY = layerHeight - bbox.height / <span class="number">2</span> - padding;
        <span class="keyword">if</span> (x &lt; minX) {
            coordinates.x = minX;
        }
        <span class="keyword">if</span> (x &gt; maxX) {
            coordinates.x = maxX;
        }
        <span class="keyword">if</span> (y &lt; minY) {
            coordinates.y = minY;
        }
        <span class="keyword">if</span> (y &gt; maxY) {
            coordinates.y = maxY;
        }
        <span class="keyword">return</span> coordinates;
    };
    <span class="keyword">var</span> dragMove = <span class="function"><span class="keyword">function</span><span class="params">(d, i)</span> {</span>
        <span class="keyword">var</span> preferredX = d3.event.x;
        <span class="keyword">var</span> preferredY = d3.event.y;
        <span class="keyword">var</span> bbox = d3.select(<span class="keyword">this</span>).node().getBBox();
        <span class="keyword">var</span> labelCoordinates = fitWithinLabelConstraints(bbox, preferredX, preferredY);
        <span class="keyword">var</span> radius = bubbleSizeScale(d.size);
        <span class="keyword">var</span> bubbleX = xScale(d.x);
        <span class="keyword">var</span> bubbleY = yScale(d.y);
        <span class="keyword">var</span> x = labelCoordinates.x - bubbleX;
        <span class="keyword">var</span> y = labelCoordinates.y - bubbleY;
        <span class="keyword">var</span> angle = Math.atan2(y, x);
        <span class="keyword">var</span> distance = Math.sqrt(Math.pow(x, <span class="number">2</span>) + Math.pow(y, <span class="number">2</span>));
        <span class="keyword">var</span> perimeterX = bubbleX + radius * Math.cos(angle);
        <span class="keyword">var</span> perimeterY = bubbleY + radius * Math.sin(angle);
        d.labelPos = angle + <span class="string">"_"</span> + (distance - radius);
        <span class="keyword">var</span> labelLink = d3.selectAll(<span class="string">".labelLink"</span>).filter(<span class="function"><span class="keyword">function</span><span class="params">(a)</span> {</span>
            <span class="keyword">return</span> a.id === d.id;
        }).attr(<span class="string">"x1"</span>, perimeterX).attr(<span class="string">"y1"</span>, perimeterY).attr(<span class="string">"x2"</span>, labelCoordinates.x).attr(<span class="string">"y2"</span>, labelCoordinates.y);
        d3.select(<span class="keyword">this</span>).attr(<span class="string">"transform"</span>, <span class="string">"translate("</span> + labelCoordinates.x + <span class="string">","</span> + labelCoordinates.y + <span class="string">")"</span>);
    };
    <span class="keyword">var</span> dragEnd = <span class="function"><span class="keyword">function</span><span class="params">(d, i)</span> {</span>
        <span class="keyword">var</span> selected = vizState.get(<span class="string">"s"</span>);
        selected[d.id].labelPos = d.labelPos;
        vizStateChangeCallback({
            s: selected
        }, vizData);
    };
    <span class="keyword">var</span> addLabelsToSelectedBubbles = <span class="function"><span class="keyword">function</span><span class="params">(selected, year)</span> {</span>
        <span class="keyword">var</span> labelsData = [];
        <span class="keyword">var</span> entityCategory = vizState.get(<span class="string">"entity"</span>) || vizState.get(<span class="string">"category"</span>);
        $.each(selected, <span class="function"><span class="keyword">function</span><span class="params">(key, object)</span> {</span>
            <span class="keyword">var</span> id = key;
            <span class="keyword">var</span> o = {};
            <span class="keyword">var</span> category = object.category;
            o.id = id;
            o.name = vizState.getDataHelper().getName(id, category);
            o.x = vizState.getDataHelper().get(vizState.get(<span class="string">"xIndicator"</span>), id, year, vizState, category);
            o.y = vizState.getDataHelper().get(vizState.get(<span class="string">"yIndicator"</span>), id, year, vizState, category);
            o.size = vizState.getDataHelper().get(vizState.get(<span class="string">"sizeIndicator"</span>), id, year, vizState, category);
            <span class="keyword">if</span> (<span class="string">"labelPos"</span> <span class="keyword">in</span> object) {
                o.labelPos = object.labelPos;
            } <span class="keyword">else</span> {
                o.labelPos = labelAngel + labelPositionInteractive;
            }
            <span class="keyword">if</span> (o.x &amp;&amp; o.y &amp;&amp; o.size) {
                labelsData.push(o);
            }
        });
        <span class="keyword">return</span> labelsData;
    };
    <span class="keyword">var</span> bubbleClickHandler = <span class="function"><span class="keyword">function</span><span class="params">(d, i)</span> {</span>
        <span class="keyword">var</span> nodeX = parseInt(d3.select(<span class="keyword">this</span>.overNode).attr(<span class="string">"cx"</span>));
        <span class="keyword">var</span> nodeY = parseInt(d3.select(<span class="keyword">this</span>.overNode).attr(<span class="string">"cy"</span>));
        <span class="keyword">var</span> nodeR = parseInt(d3.select(<span class="keyword">this</span>.overNode).attr(<span class="string">"r"</span>));
        <span class="keyword">var</span> currentYear = vizState.get(<span class="string">"year"</span>);
        <span class="keyword">var</span> selected = vizState.get(<span class="string">"s"</span>);
        <span class="keyword">var</span> id = d.id;
        <span class="keyword">if</span> (id <span class="keyword">in</span> selected) {
            <span class="keyword">delete</span> selected[id];
        } <span class="keyword">else</span> {
            selected[id] = {
                start: currentYear,
                category: d.category
            };
        }
        vizStateChangeCallback({
            s: selected
        });
        bubbleOutHandler();
    };
    <span class="keyword">var</span> drawLabels = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">if</span> (isInteractive) {
            drawLabelsInInteractiveMode();
        } <span class="keyword">else</span> {
            vizBubblePrint.drawLabels(fontSizeScale, fontSizeScale, xScale, yScale);
        }
    };
    <span class="keyword">var</span> drawLabelsInInteractiveMode = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> year = vizState.get(<span class="string">"year"</span>);
        <span class="keyword">var</span> trails = vizState.get(<span class="string">"trails"</span>);
        <span class="keyword">var</span> selected = vizState.get(<span class="string">"s"</span>);
        <span class="keyword">var</span> labelsData = addLabelsToSelectedBubbles(selected, year);
        <span class="keyword">var</span> labels = d3.select(<span class="string">"#"</span> + chartRenderDiv).select(<span class="string">".labelLayer"</span>).selectAll(<span class="string">".labelNode"</span>).data(labelsData, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> d.id;
        });
        <span class="keyword">var</span> dragInteractive = d3.behavior.drag().on(<span class="string">"drag"</span>, dragMove).on(<span class="string">"dragend"</span>, dragEnd);
        <span class="keyword">var</span> labelContainer = labels.enter().append(<span class="string">"g"</span>).attr(<span class="string">"class"</span>, <span class="string">"labelNode"</span>).attr(<span class="string">"cursor"</span>, <span class="string">"pointer"</span>).call(dragInteractive);
        labelContainer.append(<span class="string">"rect"</span>).attr(<span class="string">"cursor"</span>, <span class="string">"pointer"</span>).attr(<span class="string">"class"</span>, <span class="string">"labelBG"</span>);
        <span class="keyword">var</span> labelText = labelContainer.append(<span class="string">"text"</span>).attr(<span class="string">"class"</span>, <span class="string">"labelText"</span>).attr(<span class="string">"text-anchor"</span>, <span class="string">"middle"</span>).attr(<span class="string">"dominant-baseline"</span>, <span class="string">"central"</span>).attr(<span class="string">"font-family"</span>, <span class="string">"'Helvetica', sans-serif"</span>).attr(<span class="string">"x"</span>, <span class="string">"0"</span>).attr(<span class="string">"y"</span>, <span class="string">"0"</span>).attr(<span class="string">"font-size"</span>, <span class="string">"23px"</span>).attr(<span class="string">"pointer-events"</span>, <span class="string">"none"</span>).text(<span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> d.name;
        });
        labels.each(<span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">var</span> bbox = d3.select(<span class="keyword">this</span>).select(<span class="string">".labelText"</span>).node().getBBox();
            <span class="keyword">var</span> width = bbox.width;
            <span class="keyword">var</span> height = bbox.height;
            <span class="keyword">var</span> paddingWidth = <span class="number">8</span>;
            <span class="keyword">var</span> paddingHeight = <span class="number">8</span>;
            d3.select(<span class="keyword">this</span>).select(<span class="string">".labelBG"</span>).attr(<span class="string">"width"</span>, width + paddingWidth).attr(<span class="string">"height"</span>, height + paddingHeight).attr(<span class="string">"x"</span>, -width / <span class="number">2</span> - paddingWidth / <span class="number">2</span>).attr(<span class="string">"y"</span>, -height / <span class="number">2</span> - paddingWidth / <span class="number">2</span>).attr(<span class="string">"fill"</span>, <span class="string">"#fff"</span>).attr(<span class="string">"stroke"</span>, <span class="string">"#999"</span>).attr(<span class="string">"stroke-width"</span>, <span class="string">"2px"</span>).attr(<span class="string">"ry"</span>, <span class="string">"5px"</span>).attr(<span class="string">"rx"</span>, <span class="string">"5px"</span>);
            <span class="keyword">var</span> angle = -<span class="number">1</span> / <span class="number">4</span> * Math.PI;
            <span class="keyword">var</span> distanceFromPerimeter = <span class="number">50</span>;
            <span class="keyword">var</span> labelPos = d.labelPos;
            angle = parseFloat(labelPos.split(<span class="string">"_"</span>)[<span class="number">0</span>]);
            distanceFromPerimeter = parseFloat(labelPos.split(<span class="string">"_"</span>)[<span class="number">1</span>]);
            <span class="keyword">var</span> radius = bubbleSizeScale(d.size);
            <span class="keyword">var</span> bubbleX = xScale(d.x);
            <span class="keyword">var</span> bubbleY = yScale(d.y);
            <span class="keyword">var</span> perimeterX = bubbleX + radius * Math.cos(angle);
            <span class="keyword">var</span> perimeterY = bubbleY + radius * Math.sin(angle);
            <span class="keyword">var</span> labelCoordinates = {};
            labelCoordinates.x = bubbleX + (distanceFromPerimeter + radius) * Math.cos(angle);
            labelCoordinates.y = bubbleY + (distanceFromPerimeter + radius) * Math.sin(angle);
            <span class="keyword">var</span> preferredX = labelCoordinates.x;
            <span class="keyword">var</span> preferredY = labelCoordinates.y;
            labelCoordinates = fitWithinLabelConstraints(bbox, preferredX, preferredY);
            d.linkStartX = perimeterX;
            d.linkStartY = perimeterY;
            d.linkEndX = labelCoordinates.x;
            d.linkEndY = labelCoordinates.y;
            d3.select(<span class="keyword">this</span>).attr(<span class="string">"transform"</span>, <span class="string">"translate("</span> + labelCoordinates.x + <span class="string">","</span> + labelCoordinates.y + <span class="string">")"</span>);
        });
        labels.exit().remove();
        <span class="keyword">var</span> labelLinks = d3.select(<span class="string">"#"</span> + chartRenderDiv).select(<span class="string">".linkLayer"</span>).selectAll(<span class="string">".labelLink"</span>).data(labelsData, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> d.id;
        });
        labelLinks.enter().append(<span class="string">"svg:line"</span>).attr(<span class="string">"class"</span>, <span class="string">"labelLink"</span>).attr(<span class="string">"stroke"</span>, <span class="string">"#333"</span>).attr(<span class="string">"stroke-width"</span>, <span class="string">"1px"</span>);
        labelLinks.attr(<span class="string">"x1"</span>, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> d.linkStartX;
        }).attr(<span class="string">"y1"</span>, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> d.linkStartY;
        }).attr(<span class="string">"x2"</span>, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> d.linkEndX;
        }).attr(<span class="string">"y2"</span>, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> d.linkEndY;
        });
        labelLinks.exit().remove();
    };
    <span class="keyword">var</span> setUpChartInfoDivs = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        $(<span class="string">"#chartInfo"</span>).html(vizState.getDataHelper().getChartInfo()).css({
            <span class="string">"font-size"</span>: <span class="number">13</span>
        });
        $(<span class="string">"#chartFooter"</span>).html(<span class="string">"&lt;b&gt;Source&lt;/b&gt;:"</span> + vizState.getDataHelper().getChartFooter()).css({
            <span class="string">"font-size"</span>: <span class="number">13</span>
        });
    };
    <span class="keyword">return</span> {
        initialize: initializeLayers,
        updateLayout: updateLayout,
        update: update
    };
};

gapminder.viz.vizBubblePrint = <span class="function"><span class="keyword">function</span><span class="params">(chartRenderDiv, vizState, vizStateChangeCallback)</span> {</span>
    <span class="keyword">var</span> labelPosition = <span class="string">"top-right"</span>;
    <span class="keyword">var</span> positions = {};
    <span class="keyword">var</span> isDrag;
    <span class="keyword">var</span> defaultFontColor = <span class="string">"black"</span>;
    <span class="keyword">var</span> selectedLabel = <span class="string">""</span>;
    <span class="keyword">var</span> initOffset = {
        dx: <span class="number">0</span>,
        dy: <span class="number">0</span>,
        set: <span class="literal">false</span>
    };
    <span class="keyword">var</span> xScale;
    <span class="keyword">var</span> yScale;
    <span class="keyword">var</span> bubbleSizeScale;
    <span class="keyword">var</span> fontSizeScale;
    <span class="keyword">var</span> addLabels = <span class="function"><span class="keyword">function</span><span class="params">(year)</span> {</span>
        <span class="keyword">var</span> labelsData = [];
        <span class="keyword">var</span> entitiesMeta = vizState.getDataHelper().getEntityMeta();
        $.each(entitiesMeta, <span class="function"><span class="keyword">function</span><span class="params">(index, geoName)</span> {</span>
            <span class="keyword">var</span> entityCategory = geoName[<span class="number">0</span>].parent;
            <span class="keyword">var</span> o = {};
            o.id = index;
            o.x = vizState.getDataHelper().get(vizState.get(<span class="string">"xIndicator"</span>), index, year, vizState, entityCategory);
            o.y = vizState.getDataHelper().get(vizState.get(<span class="string">"yIndicator"</span>), index, year, vizState, entityCategory);
            o.size = vizState.getDataHelper().get(vizState.get(<span class="string">"sizeIndicator"</span>), index, year, vizState, entityCategory);
            o.labelPosition = labelPosition;
            o.labelPos = setLabelPos(o);
            o.name = vizState.getDataHelper().getName(index);
            <span class="keyword">if</span> (o.x &amp;&amp; o.y &amp;&amp; o.size) {
                labelsData.push(o);
            }
        });
        <span class="keyword">return</span> labelsData;
    };
    <span class="keyword">var</span> dragEndPrint = <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
        <span class="keyword">var</span> label;
        <span class="keyword">if</span> (isDrag) {
            <span class="keyword">var</span> dragId = d3.select(<span class="string">"#"</span> + d.id + <span class="string">"label"</span>).attr(<span class="string">"id"</span>);
            label = d3.select(<span class="string">"#"</span> + d.id + <span class="string">"label"</span>);
            positions[d.id] = {
                x: parseFloat(d3.select(<span class="string">"#"</span> + d.id + <span class="string">"label"</span>).attr(<span class="string">"x"</span>)).toFixed(<span class="number">2</span>),
                y: parseFloat(d3.select(<span class="string">"#"</span> + d.id + <span class="string">"label"</span>).attr(<span class="string">"y"</span>)).toFixed(<span class="number">2</span>),
                anchor: d3.select(<span class="string">"#"</span> + d.id + <span class="string">"label"</span>).attr(<span class="string">"text-anchor"</span>)
            };
            vizStateChangeCallback({
                positions: positions
            });
            d3.select(<span class="string">"#"</span> + dragId).attr(<span class="string">"fill"</span>, defaultFontColor);
            d3.select(<span class="string">"#"</span> + chartRenderDiv).selectAll(<span class="string">".highlightNode"</span>).remove();
            isDrag = <span class="literal">false</span>;
        } <span class="keyword">else</span> {
            <span class="keyword">if</span> (selectedLabel === <span class="string">""</span>) {
                labelClicked(d.id + <span class="string">"label"</span>);
            } <span class="keyword">else</span> {
                $(<span class="string">"#alignButtons"</span>).hide();
                d3.select(<span class="string">"#"</span> + selectedLabel).attr(<span class="string">"fill"</span>, defaultFontColor);
                label = d3.select(<span class="string">"#"</span> + selectedLabel);
                positions[selectedLabel.substring(<span class="number">0</span>, selectedLabel.indexOf(<span class="string">"label"</span>))] = {
                    x: parseFloat(label.attr(<span class="string">"x"</span>)).toFixed(<span class="number">2</span>),
                    y: parseFloat(label.attr(<span class="string">"y"</span>)).toFixed(<span class="number">2</span>),
                    anchor: label.attr(<span class="string">"text-anchor"</span>)
                };
                vizStateChangeCallback({
                    positions: positions
                });
                d3.select(<span class="string">"#"</span> + chartRenderDiv).selectAll(<span class="string">".highlightNode"</span>).remove();
                labelClicked(d.id + <span class="string">"label"</span>);
            }
        }
    };
    <span class="keyword">var</span> dragMovePrint = <span class="function"><span class="keyword">function</span><span class="params">(d, i)</span> {</span>
        isDrag = <span class="literal">true</span>;
        <span class="keyword">var</span> dragId = d3.select(<span class="keyword">this</span>).attr(<span class="string">"id"</span>);
        d3.select(<span class="string">"#"</span> + dragId).attr(<span class="string">"fill"</span>, <span class="string">"red"</span>);
        <span class="keyword">var</span> textElem = d3.select(<span class="keyword">this</span>);
        <span class="keyword">if</span> (!initOffset.set) {
            initOffset.dx = textElem.attr(<span class="string">"x"</span>) - d3.event.x;
            initOffset.dy = textElem.attr(<span class="string">"y"</span>) - d3.event.y;
            initOffset.set = <span class="literal">true</span>;
        }
        textElem.attr(<span class="string">"x"</span>, d3.event.x + initOffset.dx).attr(<span class="string">"y"</span>, d3.event.y + initOffset.dy);
        <span class="keyword">var</span> overNode = d3.select(<span class="string">"#"</span> + dragId.substring(<span class="number">0</span>, dragId.indexOf(<span class="string">"label"</span>))).select(<span class="string">"circle"</span>);
        <span class="keyword">var</span> nodeX = parseInt(overNode.attr(<span class="string">"cx"</span>));
        <span class="keyword">var</span> nodeY = parseInt(overNode.attr(<span class="string">"cy"</span>));
        <span class="keyword">var</span> nodeR = parseInt(overNode.attr(<span class="string">"r"</span>));
        <span class="keyword">var</span> nodeFill = overNode.attr(<span class="string">"fill"</span>);
        <span class="keyword">var</span> highlight = overNode.node().cloneNode(<span class="literal">true</span>);
        <span class="keyword">var</span> highlightNode = d3.select(highlight).attr(<span class="string">"pointer-events"</span>, <span class="string">"none"</span>).attr(<span class="string">"class"</span>, <span class="string">"highlightNode"</span>).attr(<span class="string">"fill"</span>, <span class="string">"none"</span>).attr(<span class="string">"r"</span>, nodeR + <span class="number">5</span>).attr(<span class="string">"fill-opacity"</span>, <span class="number">1</span>).attr(<span class="string">"stroke-opacity"</span>, <span class="number">1</span>).attr(<span class="string">"stroke-width"</span>, <span class="string">"1px"</span>).attr(<span class="string">"stroke"</span>, nodeFill);
        overNode.node().parentNode.insertBefore(highlightNode.node(), overNode.node().nextSibling);
        positions[d.id] = {
            x: parseFloat(d3.select(<span class="string">"#"</span> + d.id + <span class="string">"label"</span>).attr(<span class="string">"x"</span>)).toFixed(<span class="number">2</span>),
            y: parseFloat(d3.select(<span class="string">"#"</span> + d.id + <span class="string">"label"</span>).attr(<span class="string">"y"</span>)).toFixed(<span class="number">2</span>),
            anchor: d3.select(<span class="string">"#"</span> + d.id + <span class="string">"label"</span>).attr(<span class="string">"text-anchor"</span>)
        };
    };
    <span class="keyword">var</span> dragStartPrint = <span class="function"><span class="keyword">function</span><span class="params">(d, i)</span> {</span>
        initOffset.set = <span class="literal">false</span>;
    };
    <span class="keyword">var</span> drawLabels = <span class="function"><span class="keyword">function</span><span class="params">(bubbleSizeScaleObj, fontSizeScaleObj, xScaleObj, yScaleObj)</span> {</span>
        <span class="keyword">var</span> year = vizState.get(<span class="string">"year"</span>);
        <span class="keyword">var</span> trails = vizState.get(<span class="string">"trails"</span>);
        bubbleSizeScale = bubbleSizeScaleObj;
        fontSizeScale = fontSizeScaleObj;
        xScale = xScaleObj;
        yScale = yScaleObj;
        <span class="keyword">var</span> labelsData = addLabels(year);
        <span class="keyword">if</span> (labelsData.length === <span class="number">0</span>) {
            <span class="keyword">return</span>;
        }
        <span class="keyword">var</span> labels = d3.select(<span class="string">"#"</span> + chartRenderDiv).select(<span class="string">".labelLayer"</span>).selectAll(<span class="string">".labelNode"</span>).data(labelsData, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> d.id;
        });
        <span class="keyword">var</span> labelContainer = labels.enter().append(<span class="string">"g"</span>).attr(<span class="string">"class"</span>, <span class="string">"labelNode"</span>).attr(<span class="string">"cursor"</span>, <span class="string">"pointer"</span>);
        <span class="keyword">var</span> positions = vizState.get(<span class="string">"positions"</span>);
        <span class="keyword">var</span> labelText = labelContainer.append(<span class="string">"text"</span>).attr(<span class="string">"class"</span>, <span class="string">"labelText"</span>).attr(<span class="string">"text-anchor"</span>, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">if</span> (<span class="keyword">typeof</span> positions[d.id] === <span class="string">"undefined"</span>) {
                <span class="keyword">if</span> (labelPosition.indexOf(<span class="string">"right"</span>) !== -<span class="number">1</span>) {
                    <span class="keyword">return</span> <span class="string">"end"</span>;
                } <span class="keyword">else</span> <span class="keyword">if</span> (labelPosition.indexOf(<span class="string">"left"</span>) !== -<span class="number">1</span>) {
                    <span class="keyword">return</span> <span class="string">"start"</span>;
                } <span class="keyword">else</span> {
                    <span class="keyword">return</span> <span class="string">"middle"</span>;
                }
            } <span class="keyword">else</span> {
                <span class="keyword">return</span> positions[d.id].anchor;
            }
        }).attr(<span class="string">"dominant-baseline"</span>, <span class="string">"central"</span>).attr(<span class="string">"font-family"</span>, <span class="string">"'Helvetica', sans-serif"</span>).attr(<span class="string">"id"</span>, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> d.id + <span class="string">"label"</span>;
        });
        d3.selectAll(<span class="string">".labelNode"</span>).selectAll(<span class="string">".labelText"</span>).attr(<span class="string">"text-anchor"</span>, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">if</span> (<span class="keyword">typeof</span> positions[d.id] === <span class="string">"undefined"</span>) {
                <span class="keyword">if</span> (labelPosition.indexOf(<span class="string">"right"</span>) !== -<span class="number">1</span>) {
                    <span class="keyword">return</span> <span class="string">"start"</span>;
                } <span class="keyword">else</span> <span class="keyword">if</span> (labelPosition.indexOf(<span class="string">"left"</span>) !== -<span class="number">1</span>) {
                    <span class="keyword">return</span> <span class="string">"end"</span>;
                } <span class="keyword">else</span> {
                    <span class="keyword">return</span> <span class="string">"middle"</span>;
                }
            } <span class="keyword">else</span> <span class="keyword">if</span> (positions[d.id]) {
                <span class="keyword">return</span> positions[d.id].anchor;
            }
        }).style(<span class="string">"font-size"</span>, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> Math.floor(fontSizeScale(d.size)) + <span class="string">"px"</span>;
        });
        <span class="keyword">if</span> (vizState.get(<span class="string">"editMode"</span>)) {
            <span class="keyword">var</span> dragPrint = d3.behavior.drag().on(<span class="string">"dragstart"</span>, dragStartPrint).on(<span class="string">"drag"</span>, dragMovePrint).on(<span class="string">"dragend"</span>, dragEndPrint);
            d3.selectAll(<span class="string">".labelNode"</span>).selectAll(<span class="string">".labelText"</span>).call(dragPrint);
        } <span class="keyword">else</span> {
            d3.selectAll(<span class="string">".labelNode"</span>).selectAll(<span class="string">".labelText"</span>).on(<span class="string">"mousedown.drag"</span>, <span class="literal">null</span>);
            <span class="keyword">if</span> (selectedLabel) {
                d3.select(<span class="string">"#"</span> + selectedLabel).attr(<span class="string">"fill"</span>, defaultFontColor);
                $(<span class="string">"#alignButtons"</span>).hide();
                selectedLabel = <span class="string">""</span>;
            }
        }
        labels.each(<span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            d3.select(<span class="keyword">this</span>).select(<span class="string">".labelText"</span>).attr(<span class="string">"x"</span>, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
                <span class="keyword">if</span> (positions[d.id]) {
                    <span class="keyword">return</span> positions[d.id].x;
                } <span class="keyword">else</span> {
                    <span class="keyword">return</span> d.labelPos[<span class="number">0</span>];
                }
            }).attr(<span class="string">"y"</span>, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
                <span class="keyword">if</span> (positions[d.id]) {
                    <span class="keyword">return</span> positions[d.id].y;
                } <span class="keyword">else</span> {
                    <span class="keyword">return</span> d.labelPos[<span class="number">1</span>];
                }
            }).text(<span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
                <span class="keyword">return</span> d.name;
            });
            <span class="keyword">var</span> bbox = d3.select(<span class="keyword">this</span>).select(<span class="string">".labelText"</span>).node().getBBox();
            <span class="keyword">var</span> a = {};
            a.x1 = bbox.x;
            a.y1 = bbox.y;
            a.x2 = a.x1 + bbox.width;
            a.y2 = a.y1;
            a.x3 = a.x1;
            a.y3 = a.y1 - bbox.height;
            a.x4 = a.x1 + bbox.width;
            a.y4 = a.y2 - bbox.height;
            d.neighbourhood = {
                x1: a.x1,
                y1: a.y1,
                x2: a.x2,
                y2: a.y2,
                x3: a.x3,
                y3: a.y3,
                x4: a.x4,
                y4: a.y4
            };
        });
        labels.exit().remove();
    };
    <span class="keyword">var</span> setLabelPos = <span class="function"><span class="keyword">function</span><span class="params">(entityObj)</span> {</span>
        <span class="keyword">var</span> labelPos;
        <span class="keyword">if</span> (entityObj.labelPosition === <span class="string">"top"</span>) {
            labelPos = [ xScale(entityObj.x), yScale(entityObj.y) - bubbleSizeScale(entityObj.size) - fontSizeScale(entityObj.size) / <span class="number">2</span> ];
        } <span class="keyword">else</span> <span class="keyword">if</span> (entityObj.labelPosition === <span class="string">"bottom"</span>) {
            labelPos = [ xScale(entityObj.x), yScale(entityObj.y) + bubbleSizeScale(entityObj.size) + fontSizeScale(entityObj.size) / <span class="number">2</span> ];
        } <span class="keyword">else</span> <span class="keyword">if</span> (entityObj.labelPosition === <span class="string">"left"</span>) {
            labelPos = [ xScale(entityObj.x) - bubbleSizeScale(entityObj.size), yScale(entityObj.y) ];
        } <span class="keyword">else</span> <span class="keyword">if</span> (entityObj.labelPosition === <span class="string">"right"</span>) {
            labelPos = [ xScale(entityObj.x) + bubbleSizeScale(entityObj.size), yScale(entityObj.y) ];
        }
        <span class="keyword">if</span> (entityObj.labelPosition === <span class="string">"top-right"</span>) {
            labelPos = [ xScale(entityObj.x) + bubbleSizeScale(entityObj.size), yScale(entityObj.y) - bubbleSizeScale(entityObj.size) ];
        } <span class="keyword">else</span> <span class="keyword">if</span> (entityObj.labelPosition === <span class="string">"top-left"</span>) {
            labelPos = [ xScale(entityObj.x) - bubbleSizeScale(entityObj.size), yScale(entityObj.y) - bubbleSizeScale(entityObj.size) ];
        } <span class="keyword">else</span> <span class="keyword">if</span> (entityObj.labelPosition === <span class="string">"bottom-left"</span>) {
            labelPos = [ xScale(entityObj.x) - bubbleSizeScale(entityObj.size), yScale(entityObj.y) + bubbleSizeScale(entityObj.size) ];
        } <span class="keyword">else</span> <span class="keyword">if</span> (entityObj.labelPosition === <span class="string">"bottom-right"</span>) {
            labelPos = [ xScale(entityObj.x) + bubbleSizeScale(entityObj.size), yScale(entityObj.y) + bubbleSizeScale(entityObj.size) ];
        }
        <span class="keyword">return</span> labelPos;
    };
    <span class="keyword">var</span> labelClicked = <span class="function"><span class="keyword">function</span><span class="params">(id)</span> {</span>
        <span class="keyword">if</span> (vizState.get(<span class="string">"editMode"</span>)) {
            selectedLabel = id;
            d3.select(<span class="string">"#"</span> + id).attr(<span class="string">"fill"</span>, <span class="string">"red"</span>);
            <span class="keyword">var</span> alignButton;
            <span class="keyword">if</span> (d3.select(<span class="string">"#"</span> + id).attr(<span class="string">"text-anchor"</span>) === <span class="string">"end"</span>) {
                alignButton = $(<span class="string">"#rightAlign"</span>);
                alignButton[<span class="number">0</span>].checked = <span class="literal">true</span>;
                alignButton.button(<span class="string">"refresh"</span>);
            } <span class="keyword">else</span> <span class="keyword">if</span> (d3.select(<span class="string">"#"</span> + id).attr(<span class="string">"text-anchor"</span>) === <span class="string">"middle"</span>) {
                alignButton = $(<span class="string">"#midAlign"</span>);
                alignButton[<span class="number">0</span>].checked = <span class="literal">true</span>;
                alignButton.button(<span class="string">"refresh"</span>);
            } <span class="keyword">else</span> <span class="keyword">if</span> (d3.select(<span class="string">"#"</span> + id).attr(<span class="string">"text-anchor"</span>) === <span class="string">"start"</span>) {
                alignButton = $(<span class="string">"#leftAlign"</span>);
                alignButton[<span class="number">0</span>].checked = <span class="literal">true</span>;
                alignButton.button(<span class="string">"refresh"</span>);
            }
            <span class="keyword">var</span> textPos = $(<span class="string">"#"</span> + id).offset();
            <span class="keyword">var</span> width = d3.select(<span class="string">"#"</span> + id).node().getBBox();
            <span class="keyword">var</span> overNode = d3.select(<span class="string">"#"</span> + id.substring(<span class="number">0</span>, id.indexOf(<span class="string">"label"</span>))).select(<span class="string">"circle"</span>);
            <span class="keyword">var</span> nodeX = parseInt(overNode.attr(<span class="string">"cx"</span>));
            <span class="keyword">var</span> nodeY = parseInt(overNode.attr(<span class="string">"cy"</span>));
            <span class="keyword">var</span> nodeR = parseInt(overNode.attr(<span class="string">"r"</span>));
            <span class="keyword">var</span> nodeFill = overNode.attr(<span class="string">"fill"</span>);
            <span class="keyword">var</span> highlight = overNode.node().cloneNode(<span class="literal">true</span>);
            <span class="keyword">var</span> highlightNode = d3.select(highlight).attr(<span class="string">"pointer-events"</span>, <span class="string">"none"</span>).attr(<span class="string">"class"</span>, <span class="string">"highlightNode"</span>).attr(<span class="string">"fill"</span>, <span class="string">"none"</span>).attr(<span class="string">"r"</span>, nodeR + <span class="number">4</span>).attr(<span class="string">"fill-opacity"</span>, <span class="number">1</span>).attr(<span class="string">"stroke-opacity"</span>, <span class="number">1</span>).attr(<span class="string">"stroke-width"</span>, <span class="string">"3px"</span>).attr(<span class="string">"stroke"</span>, nodeFill);
            overNode.node().parentNode.insertBefore(highlightNode.node(), overNode.node().nextSibling);
            $(<span class="string">"#alignButtons"</span>).css({
                position: <span class="string">"relative"</span>,
                top: textPos.top - <span class="number">170</span>,
                left: textPos.left - <span class="number">120</span>
            });
            $(<span class="string">"#languageSelect"</span>).css({
                position: <span class="string">"relative"</span>,
                top: -<span class="number">20</span>,
                left: -<span class="number">90</span>
            }).appendTo($(<span class="string">"#alignButtons"</span>));
            $(<span class="string">"#alignButtons"</span>).show();
        }
    };
    <span class="keyword">var</span> registerClickEventListerners = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        d3.select(<span class="string">"body"</span>).on(<span class="string">"mousedown"</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
            <span class="keyword">var</span> target = d3.select(d3.event.target);
            <span class="keyword">if</span> (target.attr(<span class="string">"class"</span>) === <span class="string">"chart scatter"</span> &amp;&amp; selectedLabel !== <span class="string">""</span>) {
                <span class="keyword">var</span> label = d3.select(<span class="string">"#"</span> + selectedLabel);
                <span class="keyword">var</span> selected = selectedLabel.substring(<span class="number">0</span>, selectedLabel.indexOf(<span class="string">"label"</span>));
                positions[selectedLabel.substring(<span class="number">0</span>, selectedLabel.indexOf(<span class="string">"label"</span>))] = {
                    x: parseFloat(label.attr(<span class="string">"x"</span>)).toFixed(<span class="number">2</span>),
                    y: parseFloat(label.attr(<span class="string">"y"</span>)).toFixed(<span class="number">2</span>),
                    anchor: label.attr(<span class="string">"text-anchor"</span>)
                };
                vizStateChangeCallback({
                    positions: positions
                });
                d3.select(<span class="string">"#"</span> + chartRenderDiv).selectAll(<span class="string">".highlightNode"</span>).remove();
                label.attr(<span class="string">"fill"</span>, defaultFontColor);
                $(<span class="string">"#alignButtons"</span>).hide();
                $(<span class="string">"#languageSelect"</span>).css({
                    position: <span class="string">"relative"</span>,
                    top: <span class="string">"20px"</span>,
                    left: <span class="string">"30px"</span>
                }).appendTo(<span class="string">"#selectBox"</span>);
                selectedLabel = <span class="string">""</span>;
            }
        }).on(<span class="string">"keydown"</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
            <span class="keyword">if</span> (selectedLabel !== <span class="string">""</span> &amp;&amp; vizState.get(<span class="string">"editMode"</span>)) {
                <span class="keyword">var</span> label = d3.select(<span class="string">"#"</span> + selectedLabel);
                <span class="keyword">var</span> textPos = $(<span class="string">"#"</span> + selectedLabel).offset();
                <span class="keyword">if</span> (d3.event.keyCode === <span class="number">65</span>) {
                    label.attr(<span class="string">"x"</span>, parseFloat(label.attr(<span class="string">"x"</span>)) - <span class="number">2</span>);
                    $(<span class="string">"#alignButtons"</span>).css({
                        position: <span class="string">"relative"</span>,
                        top: textPos.top - <span class="number">170</span>,
                        left: textPos.left - <span class="number">122</span>
                    });
                } <span class="keyword">else</span> <span class="keyword">if</span> (d3.event.keyCode === <span class="number">87</span>) {
                    label.attr(<span class="string">"y"</span>, parseFloat(label.attr(<span class="string">"y"</span>)) - <span class="number">2</span>);
                    $(<span class="string">"#alignButtons"</span>).css({
                        position: <span class="string">"relative"</span>,
                        top: textPos.top - <span class="number">172</span>,
                        left: textPos.left - <span class="number">120</span>
                    });
                } <span class="keyword">else</span> <span class="keyword">if</span> (d3.event.keyCode === <span class="number">68</span>) {
                    label.attr(<span class="string">"x"</span>, parseFloat(label.attr(<span class="string">"x"</span>)) + <span class="number">2</span>);
                    $(<span class="string">"#alignButtons"</span>).css({
                        position: <span class="string">"relative"</span>,
                        top: textPos.top - <span class="number">170</span>,
                        left: textPos.left - <span class="number">118</span>
                    });
                } <span class="keyword">else</span> <span class="keyword">if</span> (d3.event.keyCode === <span class="number">83</span>) {
                    label.attr(<span class="string">"y"</span>, parseFloat(label.attr(<span class="string">"y"</span>)) + <span class="number">2</span>);
                    $(<span class="string">"#alignButtons"</span>).css({
                        position: <span class="string">"relative"</span>,
                        top: textPos.top - <span class="number">170</span>,
                        left: textPos.left - <span class="number">118</span>
                    });
                }
            }
        });
    };
    <span class="keyword">var</span> registerAlignButtonsEventListeners = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        $(<span class="string">"input:radio[name=setting]"</span>).change(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
            <span class="keyword">if</span> ($(<span class="string">'input:radio[name="setting"]:checked'</span>).val() === <span class="string">"leftAlign"</span>) {
                d3.select(<span class="string">"#"</span> + selectedLabel).attr(<span class="string">"text-anchor"</span>, <span class="string">"start"</span>);
            } <span class="keyword">else</span> <span class="keyword">if</span> ($(<span class="string">'input:radio[name="setting"]:checked'</span>).val() === <span class="string">"rightAlign"</span>) {
                d3.select(<span class="string">"#"</span> + selectedLabel).attr(<span class="string">"text-anchor"</span>, <span class="string">"end"</span>);
            } <span class="keyword">else</span> <span class="keyword">if</span> ($(<span class="string">'input:radio[name="setting"]:checked'</span>).val() === <span class="string">"midAlign"</span>) {
                d3.select(<span class="string">"#"</span> + selectedLabel).attr(<span class="string">"text-anchor"</span>, <span class="string">"middle"</span>);
            }
        });
    };
    <span class="keyword">var</span> bubbleClickHandlerPrint = <span class="function"><span class="keyword">function</span><span class="params">(d, i)</span> {</span>
        <span class="keyword">var</span> overNode = d3.select(<span class="string">"#"</span> + d.id).select(<span class="string">"circle"</span>);
        <span class="keyword">var</span> nodeX = parseInt(overNode.attr(<span class="string">"cx"</span>));
        <span class="keyword">var</span> nodeY = parseInt(overNode.attr(<span class="string">"cy"</span>));
        <span class="keyword">var</span> nodeR = parseInt(overNode.attr(<span class="string">"r"</span>));
        <span class="keyword">var</span> nodeFill = overNode.attr(<span class="string">"fill"</span>);
        <span class="keyword">var</span> highlight = overNode.node().cloneNode(<span class="literal">true</span>);
        <span class="keyword">var</span> highlightNode = d3.select(highlight).attr(<span class="string">"pointer-events"</span>, <span class="string">"none"</span>).attr(<span class="string">"class"</span>, <span class="string">"highlightNode"</span>).attr(<span class="string">"fill"</span>, <span class="string">"none"</span>).attr(<span class="string">"r"</span>, nodeR + <span class="number">4</span>).attr(<span class="string">"fill-opacity"</span>, <span class="number">1</span>).attr(<span class="string">"stroke-opacity"</span>, <span class="number">1</span>).attr(<span class="string">"stroke-width"</span>, <span class="string">"3px"</span>).attr(<span class="string">"stroke"</span>, nodeFill);
        overNode.node().parentNode.insertBefore(highlightNode.node(), overNode.node().nextSibling);
        labelClicked(d.id + <span class="string">"label"</span>);
    };
    <span class="keyword">return</span> {
        drawLabels: drawLabels,
        registerClickEventListerners: registerClickEventListerners,
        bubbleClickHandlerPrint: bubbleClickHandlerPrint,
        registerAlignButtonsEventListeners: registerAlignButtonsEventListeners,
        addLabels: addLabels
    };
};

gapminder.viz.chartGrid = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
    <span class="keyword">var</span> svg;
    <span class="keyword">var</span> chartRenderDiv;
    <span class="keyword">var</span> isInteractive;
    <span class="keyword">var</span> xAxisContainer;
    <span class="keyword">var</span> yAxisContainer;
    <span class="keyword">var</span> grid;
    <span class="keyword">var</span> scatterContainer;
    <span class="keyword">var</span> xLabel;
    <span class="keyword">var</span> yLabel;
    <span class="keyword">var</span> linkLayer;
    <span class="keyword">var</span> labelLayer;
    <span class="keyword">var</span> xDomain;
    <span class="keyword">var</span> yDomain;
    <span class="keyword">var</span> xScale;
    <span class="keyword">var</span> yScale;
    <span class="keyword">var</span> margin = {
        top: <span class="number">20</span>,
        right: <span class="number">20</span>,
        bottom: <span class="number">80</span>,
        left: <span class="number">100</span>
    };
    <span class="keyword">var</span> availableWidth;
    <span class="keyword">var</span> availableHeight;
    <span class="keyword">var</span> vizState;
    <span class="keyword">var</span> initializeChartLayers = <span class="function"><span class="keyword">function</span><span class="params">(root, renderDiv)</span> {</span>
        svg = root;
        chartRenderDiv = renderDiv + <span class="string">"-scatterChart"</span>;
        svg.attr(<span class="string">"id"</span>, chartRenderDiv).attr(<span class="string">"xmlns"</span>, <span class="string">"http://www.w3.org/2000/svg"</span>).attr(<span class="string">"version"</span>, <span class="string">"1.1"</span>).classed(<span class="string">"chart"</span>, <span class="literal">true</span>).classed(<span class="string">"scatter"</span>, <span class="literal">true</span>);
        <span class="keyword">var</span> g = svg.append(<span class="string">"g"</span>).attr(<span class="string">"transform"</span>, <span class="string">"translate("</span> + margin.left + <span class="string">","</span> + margin.top + <span class="string">")"</span>);
        xAxisContainer = g.append(<span class="string">"g"</span>).classed(<span class="string">"axis"</span>, <span class="literal">true</span>);
        yAxisContainer = g.append(<span class="string">"g"</span>).attr(<span class="string">"class"</span>, <span class="string">"axis"</span>);
        grid = g.append(<span class="string">"g"</span>).attr(<span class="string">"class"</span>, <span class="string">"grid"</span>);
        scatterContainer = g.append(<span class="string">"g"</span>).attr(<span class="string">"class"</span>, <span class="string">"scatterContainer"</span>);
        xLabel = g.append(<span class="string">"svg:text"</span>).attr(<span class="string">"class"</span>, <span class="string">"axisLabel"</span>);
        yLabel = g.append(<span class="string">"svg:text"</span>).attr(<span class="string">"class"</span>, <span class="string">"axisLabel"</span>);
        linkLayer = g.append(<span class="string">"g"</span>).attr(<span class="string">"class"</span>, <span class="string">"linkLayer"</span>);
        labelLayer = g.append(<span class="string">"g"</span>).attr(<span class="string">"class"</span>, <span class="string">"labelLayer"</span>);
    };
    <span class="keyword">var</span> updateLayout = <span class="function"><span class="keyword">function</span><span class="params">(vizStateObj)</span> {</span>
        vizState = vizStateObj;
        <span class="keyword">var</span> isInteractive = vizState.get(<span class="string">"isInteractive"</span>);
        <span class="keyword">if</span> (isInteractive) {
            availableWidth = $(window).width() - margin.left - margin.right;
            availableHeight = $(window).height() - margin.top - margin.bottom;
            svg.attr(<span class="string">"viewBox"</span>, <span class="string">"70 0"</span> + <span class="string">" "</span> + availableWidth + <span class="string">" "</span> + availableHeight * <span class="number">1.14</span>);
        } <span class="keyword">else</span> {
            availableWidth = <span class="number">1061.102362205</span>;
            availableHeight = <span class="number">772.755905512</span>;
            svg.attr(<span class="string">"viewBox"</span>, <span class="string">"70 0"</span> + <span class="string">" "</span> + availableWidth + <span class="string">" "</span> + availableHeight * <span class="number">1.12</span>);
        }
        console.log(<span class="string">"Update Layout"</span>, svg.style(<span class="string">"width"</span>), parseInt(svg.style(<span class="string">"width"</span>)), <span class="string">"width"</span>);
        createXAxis();
        createYAxis();
        d3.selectAll(<span class="string">"text"</span>).attr(<span class="string">"stroke-width"</span>, <span class="string">"0px"</span>).attr(<span class="string">"stroke"</span>, <span class="string">"black"</span>).attr(<span class="string">"font-size"</span>, <span class="string">"20px"</span>);
        <span class="keyword">return</span> [ xScale, yScale ];
    };
    <span class="keyword">var</span> createXAxis = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> xLabelText = vizState.getDataHelper().getAxisNames()[<span class="number">0</span>];
        <span class="keyword">if</span> (!xLabelText) {
            xLabelText = vizState.get(<span class="string">"xIndicator"</span>);
        }
        xLabel.attr(<span class="string">"text-anchor"</span>, <span class="string">"middle"</span>).attr(<span class="string">"transform"</span>, <span class="string">"translate("</span> + availableWidth / <span class="number">2</span> + <span class="string">","</span> + (availableHeight + margin.bottom * <span class="number">.6</span>) + <span class="string">")"</span>).attr(<span class="string">"font-size"</span>, <span class="string">"30px"</span>).text(xLabelText).append(<span class="string">"svg:title"</span>).text(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
            <span class="keyword">return</span> vizState.getDataHelper().getAxisInfo()[<span class="number">0</span>];
        });
        <span class="keyword">if</span> (vizState.get(<span class="string">"minXValue"</span>) !== <span class="literal">undefined</span> &amp;&amp; vizState.get(<span class="string">"maxXValue"</span>) !== <span class="literal">undefined</span>) {
            xDomain = [ vizState.get(<span class="string">"minXValue"</span>), vizState.get(<span class="string">"maxXValue"</span>) ];
        } <span class="keyword">else</span> {
            xDomain = [ vizState.getDataHelper().getMinOfXIndicator(), vizState.getDataHelper().getMaxOfXIndicator() ];
        }
        <span class="keyword">if</span> (vizState.get(<span class="string">"xAxisScale"</span>) === <span class="string">"log"</span>) {
            xScale = d3.scale.log().domain(xDomain).range([ <span class="number">0</span>, availableWidth ]);
        } <span class="keyword">else</span> {
            xScale = d3.scale.linear().domain(xDomain).range([ <span class="number">0</span>, availableWidth ]);
        }
        <span class="keyword">var</span> formatX = d3.format(<span class="string">"  0"</span>);
        <span class="keyword">var</span> xAxis = d3.svg.axis().scale(xScale).tickFormat(formatX).ticks(<span class="number">10</span>).tickSize(-availableHeight, <span class="number">0</span>, <span class="number">0</span>).tickPadding(<span class="number">5</span>).orient(<span class="string">"bottom"</span>);
        <span class="keyword">if</span> (vizState.get(<span class="string">"xAxisTickValues"</span>)) {
            xAxis.tickValues(vizState.get(<span class="string">"xAxisTickValues"</span>));
        }
        xAxisContainer.attr(<span class="string">"transform"</span>, <span class="string">"translate(0,"</span> + availableHeight + <span class="string">")"</span>).attr(<span class="string">"stroke"</span>, <span class="string">"lightgrey"</span>).classed(<span class="string">"print"</span>, !vizState.get(<span class="string">"isInteractive"</span>)).call(xAxis);
        d3.selectAll(<span class="string">"text"</span>).attr(<span class="string">"stroke-width"</span>, <span class="string">"0px"</span>).attr(<span class="string">"stroke"</span>, <span class="string">"black"</span>).attr(<span class="string">"font-size"</span>, <span class="string">"20px"</span>);
        <span class="keyword">return</span> xScale;
    };
    <span class="keyword">var</span> createYAxis = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> yLabelText = vizState.getDataHelper().getAxisNames()[<span class="number">1</span>];
        <span class="keyword">if</span> (!yLabelText) {
            yLabelText = vizState.get(<span class="string">"yIndicator"</span>);
        }
        yLabel.attr(<span class="string">"text-anchor"</span>, <span class="string">"middle"</span>).attr(<span class="string">"transform"</span>, <span class="string">"translate("</span> + -margin.left * <span class="number">.6</span> + <span class="string">","</span> + availableHeight / <span class="number">2</span> + <span class="string">"),rotate(-90)"</span>).attr(<span class="string">"font-size"</span>, <span class="string">"30px"</span>).text(yLabelText).append(<span class="string">"svg:title"</span>).text(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
            <span class="keyword">return</span> vizState.getDataHelper().getAxisInfo()[<span class="number">1</span>];
        });
        <span class="keyword">if</span> (vizState.get(<span class="string">"minYValue"</span>) !== <span class="literal">undefined</span> &amp;&amp; vizState.get(<span class="string">"maxYValue"</span>) !== <span class="literal">undefined</span>) {
            yDomain = [ vizState.get(<span class="string">"minYValue"</span>), vizState.get(<span class="string">"maxYValue"</span>) ];
        } <span class="keyword">else</span> {
            yDomain = [ vizState.getDataHelper().getMinOfYIndicator(), vizState.getDataHelper().getMaxOfYIndicator() ];
        }
        <span class="keyword">if</span> (vizState.get(<span class="string">"yAxisScale"</span>) === <span class="string">"log"</span>) {
            yScale = d3.scale.log().domain(yDomain).range([ availableHeight, <span class="number">0</span> ]);
        } <span class="keyword">else</span> {
            yScale = d3.scale.linear().domain(yDomain).range([ availableHeight, <span class="number">0</span> ]);
        }
        <span class="keyword">var</span> yAxis = d3.svg.axis().scale(yScale).orient(<span class="string">"left"</span>).ticks(<span class="number">10</span>).tickSize(-availableWidth, <span class="number">0</span>, <span class="number">0</span>).tickPadding(<span class="number">5</span>);
        <span class="keyword">if</span> (vizState.get(<span class="string">"yAxisTickValues"</span>)) {
            yAxis.tickValues(vizState.get(<span class="string">"yAxisTickValues"</span>));
        }
        yAxisContainer.attr(<span class="string">"stroke"</span>, <span class="string">"lightgrey"</span>).classed(<span class="string">"print"</span>, !vizState.get(<span class="string">"isInteractive"</span>)).call(yAxis);
        <span class="keyword">return</span> yScale;
    };
    <span class="keyword">var</span> getAvailableHeightAndWidth = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">return</span> [ availableHeight, availableWidth ];
    };
    <span class="keyword">var</span> getXAxisContainer = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">return</span> xAxisContainer;
    };
    <span class="keyword">var</span> getXLabel = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">return</span> xLabel;
    };
    <span class="keyword">var</span> getMargin = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">return</span> margin;
    };
    <span class="keyword">return</span> {
        initializeLayers: initializeChartLayers,
        updateLayout: updateLayout,
        getAvailableHeightAndWidth: getAvailableHeightAndWidth,
        getXAxisContainer: getXAxisContainer,
        getXLabel: getXLabel,
        getMargin: getMargin
    };
};

gapminder.lineChart = <span class="function"><span class="keyword">function</span><span class="params">(renderDiv, state)</span> {</span>
    <span class="keyword">var</span> isInteractive;
    <span class="keyword">var</span> chartLabelDiv;
    <span class="keyword">var</span> lineChart;
    <span class="keyword">var</span> model;
    <span class="keyword">var</span> appSVG;
    <span class="keyword">var</span> timeSlider;
    <span class="keyword">var</span> modelBindCallback;
    <span class="keyword">var</span> setInitialState = <span class="function"><span class="keyword">function</span><span class="params">(state)</span> {</span>
        model = <span class="keyword">new</span> gapminder.lineChartModel();
        model.setInit(state, <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
            isInteractive = model.get(<span class="string">"isInteractive"</span>);
            setUpSubviews();
            setUpModelAndUpdate();
            <span class="keyword">if</span> (modelBindCallback) {
                modelBindCallback(model.getAttributes());
            }
        });
    };
    <span class="keyword">var</span> setState = <span class="function"><span class="keyword">function</span><span class="params">(state)</span> {</span>
        model.set(state, <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
            isInteractive = model.get(<span class="string">"isInteractive"</span>);
            setUpModelAndUpdate();
            <span class="keyword">if</span> (modelBindCallback) {
                modelBindCallback(model.getAttributes());
            }
        });
    };
    <span class="keyword">var</span> setUpModelAndUpdate = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> year = model.get(<span class="string">"year"</span>);
        <span class="keyword">var</span> trails = model.get(<span class="string">"trails"</span>);
        $(<span class="string">"#"</span> + chartLabelDiv).html(Math.round(year));
        <span class="keyword">if</span> (isInteractive) {
            timeSlider.update(model);
        }
        lineChart.update(model);
    };
    <span class="keyword">var</span> setUpSubviews = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        $(document).ready(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
            initializeGuiElements(renderDiv);
            initializeTimeSlider(isInteractive, renderDiv);
            initializeLineChart(appSVG, renderDiv);
            setTrailsCheckBoxBinding();
        });
    };
    <span class="keyword">var</span> initializeGuiElements = <span class="function"><span class="keyword">function</span><span class="params">(renderDiv)</span> {</span>
        gapminder.guiUtils.initializeLayers(renderDiv, scatterChartModelUpdate, model);
        <span class="keyword">if</span> (isInteractive) {
            gapminder.guiUtils.createTrails(renderDiv);
        }
        chartLabelDiv = gapminder.guiUtils.get(<span class="string">"labelForYear"</span>);
        <span class="keyword">var</span> appDIV = <span class="string">"#"</span> + renderDiv;
        appSVG = d3.select(appDIV).append(<span class="string">"svg"</span>).style({
            display: <span class="string">"block"</span>
        });
    };
    <span class="keyword">var</span> initializeLineChart = <span class="function"><span class="keyword">function</span><span class="params">(svg, renderDiv)</span> {</span>
        lineChart = <span class="keyword">new</span> gapminder.vizLine();
        lineChart.initialize(svg, renderDiv, model);
    };
    <span class="keyword">var</span> initializeTimeSlider = <span class="function"><span class="keyword">function</span><span class="params">(isInteractive, renderDiv)</span> {</span>
        <span class="keyword">if</span> (isInteractive) {
            gapminder.guiUtils.createTimeSlider(renderDiv);
            timeSlider = <span class="keyword">new</span> gapminder.timeSlider(timeSliderModelUpdate);
            timeSlider.initialize(model);
            timeSlider.setupListeners();
        }
    };
    <span class="keyword">var</span> scatterChartModelUpdate = <span class="function"><span class="keyword">function</span><span class="params">(state)</span> {</span>
        model.set(state, <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
            lineChart.update(model);
            <span class="keyword">if</span> (modelBindCallback) {
                modelBindCallback(model.getAttributes());
            }
        });
    };
    <span class="keyword">var</span> timeSliderModelUpdate = <span class="function"><span class="keyword">function</span><span class="params">(state)</span> {</span>
        model.set(state, <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
            $(<span class="string">"#"</span> + chartLabelDiv).html(Math.round(model.get(<span class="string">"year"</span>)));
            timeSlider.update(model);
            lineChart.update(model);
            <span class="keyword">if</span> (modelBindCallback) {
                modelBindCallback(model.getAttributes());
            }
        });
    };
    <span class="keyword">var</span> setTrailsCheckBoxBinding = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        $(document).on(<span class="string">"change"</span>, <span class="string">".ui-trails"</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
            <span class="keyword">if</span> ($(<span class="keyword">this</span>).is(<span class="string">":checked"</span>)) {
                model.set({
                    trails: <span class="string">"standard"</span>
                }, setUpModelAndUpdate);
                <span class="keyword">if</span> (modelBindCallback) {
                    modelBindCallback(model.getAttributes());
                }
            } <span class="keyword">else</span> {
                model.set({
                    trails: <span class="string">"none"</span>
                }, setUpModelAndUpdate);
                <span class="keyword">if</span> (modelBindCallback) {
                    modelBindCallback(model.getAttributes());
                }
            }
        });
    };
    <span class="keyword">var</span> registerModelBindCallback = <span class="function"><span class="keyword">function</span><span class="params">(callback)</span> {</span>
        modelBindCallback = callback;
    };
    setInitialState(state);
    <span class="keyword">return</span> {
        setVizabiState: setInitialState,
        setState: setState,
        setInitialState: setInitialState,
        registerStateBindCallback: registerModelBindCallback
    };
};

gapminder.data.lineChartDataHelper = <span class="function"><span class="keyword">function</span><span class="params">(fileFormat, entityName, fileName, dataPathUri)</span> {</span>
    <span class="keyword">var</span> dataCube;
    <span class="keyword">var</span> indicators;
    <span class="keyword">var</span> entityMeta;
    <span class="keyword">var</span> yAxisName;
    <span class="keyword">var</span> xAxisName;
    <span class="keyword">var</span> yAxisInfo;
    <span class="keyword">var</span> xAxisInfo;
    <span class="keyword">var</span> dataHelperModel;
    <span class="keyword">var</span> dataSetInfo;
    <span class="keyword">var</span> renderCallback;
    <span class="keyword">var</span> chartFooter;
    <span class="keyword">var</span> regionsList;
    <span class="keyword">var</span> timeUnit;
    <span class="keyword">var</span> skeleton;
    <span class="keyword">var</span> colorScale = d3.scale.category20();
    <span class="keyword">var</span> colors = {
        America: {
            fill: <span class="string">"#80EC00"</span>,
            stroke: <span class="string">"#038000"</span>
        },
        Europe: {
            fill: <span class="string">"#FFE800"</span>,
            stroke: <span class="string">"#CF6112"</span>
        },
        Africa: {
            fill: <span class="string">"#00D6EA"</span>,
            stroke: <span class="string">"#07579C"</span>
        },
        Asia: {
            fill: <span class="string">"#FF5973"</span>,
            stroke: <span class="string">"#960570"</span>
        },
        bra: {
            fill: <span class="string">"#80EC00"</span>,
            stroke: <span class="string">"#038000"</span>
        },
        ind: {
            fill: <span class="string">"#FF5973"</span>,
            stroke: <span class="string">"#960570"</span>
        },
        ind_kind: {
            fill: <span class="string">"#FF5973"</span>,
            stroke: <span class="string">"#960570"</span>
        },
        bra_kind: {
            fill: <span class="string">"#80EC00"</span>,
            stroke: <span class="string">"#038000"</span>
        },
        rest: {
            fill: <span class="string">"#D6CBBA"</span>,
            stroke: <span class="string">"#D6CBBA"</span>
        },
        IND: {
            fill: <span class="string">"#FF5973"</span>,
            stroke: <span class="string">"#960570"</span>
        },
        BRA: {
            fill: <span class="string">"#FFFF00"</span>,
            stroke: <span class="string">"#000000"</span>
        },
        AME: {
            fill: <span class="string">"#80EC00"</span>,
            stroke: <span class="string">"#038000"</span>
        },
        EUR: {
            fill: <span class="string">"#FFE800"</span>,
            stroke: <span class="string">"#CF6112"</span>
        },
        AFR: {
            fill: <span class="string">"#00D6EA"</span>,
            stroke: <span class="string">"#07579C"</span>
        },
        ASI: {
            fill: <span class="string">"#FF5973"</span>,
            stroke: <span class="string">"#960570"</span>
        }
    };
    <span class="keyword">var</span> initialize = <span class="function"><span class="keyword">function</span><span class="params">(callback, args)</span> {</span>
        <span class="keyword">var</span> options = {
            dataFormat: fileFormat,
            entity: entityName,
            fileName: fileName,
            dataPath: dataPathUri
        };
        dataCube = <span class="keyword">new</span> gapminder.dataCube();
        dataCube.initialize(options, <span class="function"><span class="keyword">function</span><span class="params">(skeletonObj)</span> {</span>
            skeleton = skeletonObj;
            callback(args[<span class="number">0</span>], args[<span class="number">1</span>], args[<span class="number">2</span>], args[<span class="number">3</span>]);
        });
    };
    <span class="keyword">var</span> get = <span class="function"><span class="keyword">function</span><span class="params">(indicator, entity, year, appModel, category)</span> {</span>
        <span class="keyword">var</span> prevYear = Math.floor(year);
        <span class="keyword">var</span> nextYear = Math.round(year);
        <span class="keyword">var</span> fraction = year - Math.floor(year);
        <span class="keyword">var</span> entityIndicator = indicators[timeUnit][category][indicator][<span class="string">"years"</span>][entity];
        <span class="keyword">if</span> (entityIndicator &amp;&amp; entityIndicator[<span class="string">"trends"</span>][prevYear] &amp;&amp; entityIndicator[<span class="string">"trends"</span>][nextYear]) {
            <span class="keyword">return</span> interpolateValueBetweenYears(entityIndicator[<span class="string">"trends"</span>][prevYear].v, entityIndicator[<span class="string">"trends"</span>][nextYear].v, fraction);
        }
    };
    <span class="keyword">var</span> validateState = <span class="function"><span class="keyword">function</span><span class="params">(model, changedState, callback, isValid)</span> {</span>
        dataHelperModel = model;
        renderCallback = callback;
        <span class="keyword">var</span> fileName = model.get(<span class="string">"fileName"</span>);
        <span class="keyword">var</span> entity = model.get(<span class="string">"entity"</span>);
        <span class="keyword">var</span> dataPath = model.get(<span class="string">"dataPath"</span>);
        <span class="keyword">if</span> (!isValid) {
            setValidStateParams(model, changedState, loadNestedData);
        } <span class="keyword">else</span> {
            loadNestedData(model, changedState);
        }
    };
    <span class="keyword">var</span> loadNestedData = <span class="function"><span class="keyword">function</span><span class="params">(model, changedState)</span> {</span>
        <span class="keyword">var</span> dataPath = model.get(<span class="string">"dataPath"</span>);
        <span class="keyword">var</span> indicatorsToLoad = getIndicatorsToLoad(model, dataPath, changedState);
        dataCube.loadNestedData(model, changedState, dataIsReady, indicatorsToLoad);
    };
    <span class="keyword">var</span> getEntityLayerObject = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> entities = [];
        $.each(entityMeta, <span class="function"><span class="keyword">function</span><span class="params">(index, geoName)</span> {</span>
            <span class="keyword">var</span> entity = {
                id: index,
                max: get(dataHelperModel.get(<span class="string">"yIndicator"</span>), index, getMaxYear(), dataHelperModel, geoName[<span class="number">0</span>].parent)
            };
            entities.push(entity);
        });
        <span class="keyword">return</span> entities;
    };
    <span class="keyword">var</span> dataIsReady = <span class="function"><span class="keyword">function</span><span class="params">(entityObj, indicatorsObj, chartInfo, regions)</span> {</span>
        indicators = $.extend(<span class="literal">true</span>, indicators, indicatorsObj);
        setTimeUnit();
        entityMeta = $.extend(<span class="literal">true</span>, entityMeta, entityObj);
        <span class="keyword">if</span> (regions) {
            regionsList = regions;
        }
        setDatasetAndChartInfo(chartInfo);
        setAxesNameAndInfo();
        renderCallback();
    };
    <span class="keyword">var</span> setTimeUnit = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">for</span> (<span class="keyword">var</span> unit <span class="keyword">in</span> indicators) {
            <span class="keyword">if</span> (indicators.hasOwnProperty(unit)) {
                timeUnit = unit;
            }
        }
    };
    <span class="keyword">var</span> setValidStateParams = <span class="function"><span class="keyword">function</span><span class="params">(model, changedState, setValidModelCallback)</span> {</span>
        <span class="keyword">var</span> dataFormat = model.get(<span class="string">"fileFormat"</span>);
        <span class="keyword">var</span> dataPath = model.get(<span class="string">"dataPath"</span>);
        console.warn(<span class="string">"State is invalid. Loading indicators from "</span> + dataPath + <span class="string">"indicators.csv"</span>);
        changedState = $.extend(<span class="literal">true</span>, changedState, model.setIndicatorForInvalidState(changedState, skeleton.indicators[<span class="number">0</span>].id, skeleton.indicators[<span class="number">1</span>].id, skeleton.indicators[<span class="number">2</span>].id));
        loadNestedData(model, changedState);
    };
    <span class="keyword">var</span> getRangeOfIndicators = <span class="function"><span class="keyword">function</span><span class="params">(indicator, isMax)</span> {</span>
        <span class="keyword">var</span> index = <span class="number">0</span>;
        <span class="keyword">var</span> indicatorName = dataHelperModel.get(indicator);
        <span class="keyword">var</span> rangeOfIndicators = [];
        <span class="keyword">if</span> (isMax) {
            index = <span class="number">1</span>;
        }
        <span class="keyword">for</span> (<span class="keyword">var</span> entity <span class="keyword">in</span> indicators[timeUnit]) {
            <span class="keyword">if</span> (indicators[timeUnit].hasOwnProperty(entity)) {
                <span class="keyword">for</span> (<span class="keyword">var</span> ind <span class="keyword">in</span> indicators[timeUnit][entity]) {
                    <span class="keyword">if</span> (ind === indicatorName) {
                        rangeOfIndicators.push(indicators[timeUnit][entity][ind][<span class="string">"scope"</span>][<span class="string">"value"</span>][index]);
                    }
                }
            }
        }
        <span class="keyword">var</span> rangeValue;
        <span class="keyword">if</span> (isMax) {
            rangeValue = Math.max.apply(Math, rangeOfIndicators);
        } <span class="keyword">else</span> {
            rangeValue = Math.min.apply(Math, rangeOfIndicators);
        }
        <span class="keyword">return</span> rangeValue;
    };
    <span class="keyword">var</span> getTimeRange = <span class="function"><span class="keyword">function</span><span class="params">(isMax)</span> {</span>
        <span class="keyword">var</span> index = <span class="number">0</span>;
        <span class="keyword">var</span> rangeOfIndicators = [];
        <span class="keyword">if</span> (isMax) {
            index = <span class="number">1</span>;
        }
        <span class="keyword">for</span> (<span class="keyword">var</span> entity <span class="keyword">in</span> indicators[timeUnit]) {
            <span class="keyword">if</span> (indicators[timeUnit].hasOwnProperty(entity)) {
                <span class="keyword">for</span> (<span class="keyword">var</span> indicatorName <span class="keyword">in</span> indicators[timeUnit][entity]) {
                    <span class="keyword">if</span> (indicators[timeUnit][entity].hasOwnProperty(indicatorName)) {
                        rangeOfIndicators.push(indicators[timeUnit][entity][indicatorName][<span class="string">"scope"</span>][<span class="string">"time"</span>][index]);
                    }
                }
            }
        }
        <span class="keyword">return</span> Math.max.apply(Math, rangeOfIndicators);
    };
    <span class="keyword">var</span> getDataObject = <span class="function"><span class="keyword">function</span><span class="params">(indicator, year)</span> {</span>
        <span class="keyword">var</span> currentEntities = {};
        <span class="keyword">var</span> category = dataHelperModel.get(<span class="string">"entity"</span>) || dataHelperModel.get(<span class="string">"category"</span>);
        $.each(entityMeta, <span class="function"><span class="keyword">function</span><span class="params">(index, geoName)</span> {</span>
            <span class="keyword">var</span> entityCategory = geoName[<span class="number">0</span>].parent;
            <span class="keyword">var</span> minYear = getMinTimeForEntity(indicator, category, index);
            currentEntities[index] = [];
            <span class="keyword">for</span> (<span class="keyword">var</span> i = minYear; i &lt; year; i++) {
                <span class="keyword">if</span> (category.indexOf(entityCategory) &gt;= <span class="number">0</span>) {
                    <span class="keyword">var</span> o = {};
                    o.id = index;
                    o.y = get(dataHelperModel.get(<span class="string">"yIndicator"</span>), index, i, dataHelperModel, entityCategory);
                    o.x = i;
                    o.color = getColor(index, <span class="string">"fill"</span>, entityCategory);
                    o.year = i;
                    o.category = entityCategory;
                    <span class="keyword">if</span> (o.x &amp;&amp; o.y) {
                        currentEntities[index].push(o);
                    }
                }
            }
        });
        <span class="keyword">return</span> currentEntities;
    };
    <span class="keyword">var</span> getEntityMeta = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">return</span> entityMeta;
    };
    <span class="keyword">var</span> getNestedData = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">return</span> indicators;
    };
    <span class="keyword">var</span> getMaxOfXIndicator = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">return</span> getRangeOfIndicators(<span class="string">"xIndicator"</span>, <span class="literal">true</span>);
    };
    <span class="keyword">var</span> getMinOfXIndicator = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">return</span> getRangeOfIndicators(<span class="string">"xIndicator"</span>, <span class="literal">false</span>);
    };
    <span class="keyword">var</span> getMaxOfYIndicator = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">return</span> getRangeOfIndicators(<span class="string">"yIndicator"</span>, <span class="literal">true</span>);
    };
    <span class="keyword">var</span> getMinOfYIndicator = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">return</span> getRangeOfIndicators(<span class="string">"yIndicator"</span>, <span class="literal">false</span>);
    };
    <span class="keyword">var</span> getMinOfSizeIndicator = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">return</span> getRangeOfIndicators(<span class="string">"sizeIndicator"</span>, <span class="literal">false</span>);
    };
    <span class="keyword">var</span> getMaxOfSizeIndicator = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">return</span> getRangeOfIndicators(<span class="string">"sizeIndicator"</span>, <span class="literal">true</span>);
    };
    <span class="keyword">var</span> getMinYear = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">return</span> getTimeRange(<span class="literal">false</span>);
    };
    <span class="keyword">var</span> getMaxYear = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">return</span> getTimeRange(<span class="literal">true</span>);
    };
    <span class="keyword">var</span> getChartInfo = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">return</span> dataSetInfo;
    };
    <span class="keyword">var</span> getChartFooter = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">return</span> chartFooter;
    };
    <span class="keyword">var</span> getAxisNames = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">return</span> [ xAxisName, yAxisName ];
    };
    <span class="keyword">var</span> getAxisInfo = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">return</span> [ xAxisInfo, yAxisInfo ];
    };
    <span class="keyword">var</span> getColor = <span class="function"><span class="keyword">function</span><span class="params">(id, type, category)</span> {</span>
        <span class="keyword">var</span> region = entityMeta[id][<span class="number">0</span>].region;
        <span class="keyword">if</span> (colors[region]) {
            <span class="keyword">return</span> colors[region][type];
        } <span class="keyword">else</span> <span class="keyword">if</span> (regionsList.length &gt; <span class="number">0</span>) {
            <span class="keyword">return</span> colorScale(regionsList.indexOf(region));
        } <span class="keyword">else</span> {
            <span class="keyword">return</span> <span class="string">"#FF5973"</span>;
        }
    };
    <span class="keyword">var</span> interpolateValueBetweenYears = <span class="function"><span class="keyword">function</span><span class="params">(prevNumber, nextNumber, fraction)</span> {</span>
        <span class="keyword">return</span> prevNumber + (nextNumber - prevNumber) * fraction;
    };
    <span class="keyword">var</span> getName = <span class="function"><span class="keyword">function</span><span class="params">(id, category)</span> {</span>
        <span class="keyword">return</span> entityMeta[id][<span class="number">0</span>].name;
    };
    <span class="keyword">var</span> setDatasetAndChartInfo = <span class="function"><span class="keyword">function</span><span class="params">(chartInfo)</span> {</span>
        <span class="keyword">if</span> (chartInfo) {
            dataSetInfo = chartInfo[<span class="number">0</span>];
            chartFooter = chartInfo[<span class="number">1</span>];
        }
    };
    <span class="keyword">var</span> setAxesNameAndInfo = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> xIndicator = dataHelperModel.get(<span class="string">"xIndicator"</span>);
        <span class="keyword">var</span> yIndicator = dataHelperModel.get(<span class="string">"yIndicator"</span>);
        <span class="keyword">for</span> (<span class="keyword">var</span> entity <span class="keyword">in</span> indicators[timeUnit]) {
            <span class="keyword">if</span> (indicators[timeUnit].hasOwnProperty(entity)) {
                <span class="keyword">for</span> (<span class="keyword">var</span> indicatorName <span class="keyword">in</span> indicators[timeUnit][entity]) {
                    <span class="keyword">if</span> (indicators[timeUnit][entity].hasOwnProperty(indicatorName) &amp;&amp; indicatorName == xIndicator) {
                        xAxisInfo = indicators[timeUnit][entity][indicatorName][<span class="string">"info"</span>].info;
                        xAxisName = indicators[timeUnit][entity][indicatorName][<span class="string">"info"</span>].name;
                    } <span class="keyword">else</span> <span class="keyword">if</span> (indicators[timeUnit][entity].hasOwnProperty(indicatorName) &amp;&amp; indicatorName == yIndicator) {
                        yAxisInfo = indicators[timeUnit][entity][indicatorName][<span class="string">"info"</span>].info;
                        yAxisName = indicators[timeUnit][entity][indicatorName][<span class="string">"info"</span>].name;
                    }
                }
            }
        }
    };
    <span class="keyword">var</span> getDataForYear = <span class="function"><span class="keyword">function</span><span class="params">(indicator, entity, year, category)</span> {</span>
        <span class="keyword">return</span> indicators[timeUnit][category][indicator][<span class="string">"years"</span>][entity][<span class="string">"trends"</span>][year].v;
    };
    <span class="keyword">var</span> getIndicatorsToLoad = <span class="function"><span class="keyword">function</span><span class="params">(model)</span> {</span>
        <span class="keyword">var</span> dataPath = model.get(<span class="string">"dataPath"</span>);
        <span class="keyword">var</span> entity = model.get(<span class="string">"entity"</span>);
        <span class="keyword">var</span> indicatorsToLoad = {};
        <span class="keyword">var</span> categories = model.get(<span class="string">"category"</span>);
        <span class="keyword">var</span> indicators = [ model.get(<span class="string">"yIndicator"</span>) ];
        <span class="keyword">var</span> skeletonCategories = skeleton.categories;
        <span class="keyword">if</span> (categories.length === <span class="number">0</span>) {
            categories.push(entity);
        }
        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; categories.length; i++) {
            indicatorsToLoad[categories[i]] = [];
            <span class="keyword">if</span> (skeletonCategories &amp;&amp; skeletonCategories.length &gt; <span class="number">0</span>) {
                <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; skeletonCategories.length; j++) {
                    <span class="keyword">if</span> (categories[i] === skeletonCategories[j].id) {
                        <span class="keyword">var</span> loadedIndicators = skeletonCategories[j].things;
                        <span class="keyword">if</span> (loadedIndicators.length &gt; <span class="number">0</span>) {
                            <span class="keyword">for</span> (k = <span class="number">0</span>; k &lt; indicators.length; k++) {
                                <span class="keyword">var</span> indicatorLoaded = <span class="literal">false</span>;
                                <span class="keyword">for</span> (<span class="keyword">var</span> m = <span class="number">0</span>; m &lt; loadedIndicators.length; m++) {
                                    <span class="keyword">if</span> (loadedIndicators[m] === indicators[k]) {
                                        indicatorLoaded = <span class="literal">true</span>;
                                    }
                                }
                                <span class="keyword">if</span> (!indicatorLoaded) {
                                    indicatorsToLoad[categories[i]].push(indicators[k]);
                                }
                            }
                        } <span class="keyword">else</span> {
                            <span class="keyword">for</span> (<span class="keyword">var</span> k = <span class="number">0</span>; k &lt; indicators.length; k++) {
                                indicatorsToLoad[categories[i]].push(indicators[k]);
                            }
                        }
                    }
                }
            } <span class="keyword">else</span> {
                <span class="keyword">for</span> (<span class="keyword">var</span> k = <span class="number">0</span>; k &lt; indicators.length; k++) {
                    indicatorsToLoad[categories[i]].push(indicators[k]);
                }
            }
        }
        <span class="keyword">for</span> (<span class="keyword">var</span> category <span class="keyword">in</span> indicatorsToLoad) {
            <span class="keyword">if</span> (indicatorsToLoad.hasOwnProperty(category)) {
                <span class="keyword">if</span> (indicatorsToLoad[category].length === <span class="number">0</span>) {
                    <span class="keyword">delete</span> indicatorsToLoad[category];
                }
            }
        }
        <span class="keyword">return</span> indicatorsToLoad;
    };
    <span class="keyword">var</span> getMinValueForEntity = <span class="function"><span class="keyword">function</span><span class="params">(indicator, category, entity)</span> {</span>
        <span class="keyword">if</span> (indicators[<span class="string">"yearly"</span>][category][indicator][<span class="string">"years"</span>][entity][<span class="string">"scope"</span>]) {
            <span class="keyword">return</span> indicators[<span class="string">"yearly"</span>][category][indicator][<span class="string">"years"</span>][entity][<span class="string">"scope"</span>][<span class="string">"value"</span>][<span class="number">0</span>];
        }
    };
    <span class="keyword">var</span> getMinTimeForEntity = <span class="function"><span class="keyword">function</span><span class="params">(indicator, category, entity)</span> {</span>
        <span class="keyword">if</span> (indicators[<span class="string">"yearly"</span>][category][indicator][<span class="string">"years"</span>][entity][<span class="string">"scope"</span>]) {
            <span class="keyword">return</span> indicators[<span class="string">"yearly"</span>][category][indicator][<span class="string">"years"</span>][entity][<span class="string">"scope"</span>][<span class="string">"time"</span>][<span class="number">0</span>];
        }
    };
    <span class="keyword">var</span> getMaxValueForEntity = <span class="function"><span class="keyword">function</span><span class="params">(indicator, category, entity)</span> {</span>
        <span class="keyword">if</span> (indicators[<span class="string">"yearly"</span>][category][indicator][<span class="string">"years"</span>][entity][<span class="string">"scope"</span>]) {
            <span class="keyword">return</span> indicators[<span class="string">"yearly"</span>][category][indicator][<span class="string">"years"</span>][entity][<span class="string">"scope"</span>][<span class="string">"value"</span>][<span class="number">1</span>];
        }
    };
    <span class="keyword">var</span> getMaxTimeForEntity = <span class="function"><span class="keyword">function</span><span class="params">(indicator, category, entity)</span> {</span>
        <span class="keyword">if</span> (indicators[<span class="string">"yearly"</span>][category][indicator][<span class="string">"years"</span>][entity][<span class="string">"scope"</span>]) {
            <span class="keyword">return</span> indicators[<span class="string">"yearly"</span>][category][indicator][<span class="string">"years"</span>][entity][<span class="string">"scope"</span>][<span class="string">"time"</span>][<span class="number">1</span>];
        }
    };
    <span class="keyword">return</span> {
        initialize: initialize,
        get: get,
        getEntityMeta: getEntityMeta,
        getNestedData: getNestedData,
        getMaxOfXIndicator: getMaxOfXIndicator,
        getMinOfXIndicator: getMinOfXIndicator,
        getMaxOfYIndicator: getMaxOfYIndicator,
        getMinOfYIndicator: getMinOfYIndicator,
        getMinOfSizeIndicator: getMinOfSizeIndicator,
        getMaxOfSizeIndicator: getMaxOfSizeIndicator,
        getMinYear: getMinYear,
        getMaxYear: getMaxYear,
        getChartInfo: getChartInfo,
        getChartFooter: getChartFooter,
        getAxisNames: getAxisNames,
        getAxisInfo: getAxisInfo,
        getEntityLayerObject: getEntityLayerObject,
        getDataObject: getDataObject,
        getColor: getColor,
        getName: getName,
        getDataForYear: getDataForYear,
        getMinValueForEntity: getMinValueForEntity,
        getMinTimeForEntity: getMinTimeForEntity,
        getMaxValueForEntity: getMaxValueForEntity,
        getMaxTimeForEntity: getMaxTimeForEntity,
        validateState: validateState
    };
};

gapminder.lineChartModel = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
    <span class="keyword">var</span> dataHelper;
    <span class="keyword">var</span> stateAttributes = {
        s: {},
        opacity: <span class="number">.5</span>,
        speed: <span class="number">.1</span>,
        zoom: {},
        trails: <span class="string">"none"</span>,
        tSpeed: <span class="number">300</span>,
        action: <span class="string">"multi"</span>,
        enableHistory: <span class="literal">true</span>,
        year: <span class="literal">undefined</span>,
        xIndicator: <span class="literal">undefined</span>,
        yIndicator: <span class="literal">undefined</span>,
        entity: <span class="literal">undefined</span>,
        fraction: <span class="literal">undefined</span>,
        prevYear: <span class="literal">undefined</span>,
        nextYear: <span class="literal">undefined</span>,
        dataPath: <span class="literal">undefined</span>,
        fileFormat: <span class="literal">undefined</span>,
        fileName: <span class="literal">undefined</span>,
        minXValue: <span class="literal">undefined</span>,
        maxXValue: <span class="literal">undefined</span>,
        minYValue: <span class="literal">undefined</span>,
        maxYValue: <span class="literal">undefined</span>,
        xAxisScale: <span class="string">"linear"</span>,
        yAxisScale: <span class="string">"linear"</span>,
        isInteractive: <span class="literal">false</span>,
        xAxisTickValues: <span class="literal">undefined</span>,
        yAxisTickValues: <span class="literal">undefined</span>,
        language: <span class="literal">undefined</span>,
        positions: {},
        editMode: <span class="literal">false</span>,
        category: []
    };
    <span class="keyword">var</span> initialize = <span class="function"><span class="keyword">function</span><span class="params">(callback, args)</span> {</span>
        dataHelper = <span class="keyword">new</span> gapminder.data.lineChartDataHelper(get(<span class="string">"fileFormat"</span>), get(<span class="string">"entity"</span>), get(<span class="string">"fileName"</span>), get(<span class="string">"dataPath"</span>));
        dataHelper.initialize(callback, args);
    };
    <span class="keyword">var</span> setInit = <span class="function"><span class="keyword">function</span><span class="params">(changedState, modelAndDataReadyCallback)</span> {</span>
        console.log(<span class="string">"BUBBLE MODEL SET STATE: "</span>, changedState);
        <span class="keyword">var</span> changedStateAttr = {};
        <span class="keyword">var</span> dataNeedsToBeLoaded = <span class="literal">false</span>;
        <span class="keyword">for</span> (<span class="keyword">var</span> attr <span class="keyword">in</span> changedState) {
            <span class="keyword">if</span> (changedState.hasOwnProperty(attr) &amp;&amp; stateAttributes[attr] !== changedState[attr]) {
                stateAttributes[attr] = changedState[attr];
                changedStateAttr[attr] = changedState[attr];
                <span class="keyword">if</span> (attr.indexOf(<span class="string">"Indicator"</span>) &gt;= <span class="number">0</span> || attr.indexOf(<span class="string">"language"</span>) || attr.indexOf(<span class="string">"dataPath"</span>) || attr.indexOf(<span class="string">"entity"</span>) || attr.indexOf(<span class="string">"category"</span>)) {
                    dataNeedsToBeLoaded = <span class="literal">true</span>;
                }
                <span class="keyword">if</span> (attr === <span class="string">"year"</span>) {
                    updateFraction();
                }
            }
        }
        console.log(<span class="string">"What changed: "</span>, changedStateAttr);
        initialize(processWithCallback, [ <span class="keyword">this</span>, dataNeedsToBeLoaded, changedStateAttr, modelAndDataReadyCallback ]);
    };
    <span class="keyword">var</span> set = <span class="function"><span class="keyword">function</span><span class="params">(changedState, modelAndDataReadyCallback)</span> {</span>
        console.log(<span class="string">"BUBBLE MODEL SET STATE: "</span>, changedState);
        <span class="keyword">var</span> changedStateAttr = {};
        <span class="keyword">var</span> dataNeedsToBeLoaded = <span class="literal">false</span>;
        <span class="keyword">for</span> (<span class="keyword">var</span> attr <span class="keyword">in</span> changedState) {
            <span class="keyword">if</span> (changedState.hasOwnProperty(attr) &amp;&amp; stateAttributes[attr] !== changedState[attr]) {
                stateAttributes[attr] = changedState[attr];
                changedStateAttr[attr] = changedState[attr];
                <span class="keyword">if</span> (attr.indexOf(<span class="string">"Indicator"</span>) &gt;= <span class="number">0</span> || attr.indexOf(<span class="string">"language"</span>) || attr.indexOf(<span class="string">"dataPath"</span>) || attr.indexOf(<span class="string">"entity"</span>) || attr.indexOf(<span class="string">"category"</span>)) {
                    dataNeedsToBeLoaded = <span class="literal">true</span>;
                }
                <span class="keyword">if</span> (attr === <span class="string">"year"</span>) {
                    updateFraction();
                }
            }
        }
        console.log(<span class="string">"What changed: "</span>, changedStateAttr);
        processWithCallback(<span class="keyword">this</span>, dataNeedsToBeLoaded, changedStateAttr, modelAndDataReadyCallback);
    };
    <span class="keyword">var</span> processWithCallback = <span class="function"><span class="keyword">function</span><span class="params">(model, dataNeedsToBeLoaded, changedStateAttributes, modelAndDataIsReadyCallback)</span> {</span>
        <span class="keyword">var</span> isStateValid = isValidState();
        <span class="keyword">if</span> (dataNeedsToBeLoaded &amp;&amp; <span class="keyword">typeof</span> modelAndDataIsReadyCallback === <span class="string">"function"</span>) {
            dataHelper.validateState(model, changedStateAttributes, modelAndDataIsReadyCallback, isStateValid);
        } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> modelAndDataIsReadyCallback === <span class="string">"function"</span>) {
            modelAndDataIsReadyCallback();
        }
    };
    <span class="keyword">var</span> get = <span class="function"><span class="keyword">function</span><span class="params">(state)</span> {</span>
        <span class="keyword">return</span> stateAttributes[state];
    };
    <span class="keyword">var</span> updateFraction = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> year = stateAttributes.year;
        stateAttributes.fraction = year - Math.floor(year);
        stateAttributes.prevYear = Math.floor(year);
        stateAttributes.nextYear = Math.ceil(year);
    };
    <span class="keyword">var</span> getDataHelper = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">return</span> dataHelper;
    };
    <span class="keyword">var</span> getAttributes = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">return</span> stateAttributes;
    };
    <span class="keyword">var</span> isValidState = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> xIndicator = get(<span class="string">"xIndicator"</span>);
        <span class="keyword">var</span> yIndicator = get(<span class="string">"yIndicator"</span>);
        <span class="keyword">var</span> dataPath = get(<span class="string">"dataPath"</span>);
        <span class="keyword">if</span> ((xIndicator || yIndicator) &amp;&amp; dataPath) {
            <span class="keyword">return</span> <span class="literal">true</span>;
        } <span class="keyword">else</span> {
            <span class="keyword">return</span> <span class="literal">false</span>;
        }
    };
    <span class="keyword">var</span> setIndicatorForInvalidState = <span class="function"><span class="keyword">function</span><span class="params">(changedState, x, y, size)</span> {</span>
        stateAttributes.xIndicator = x;
        stateAttributes.yIndicator = y;
        stateAttributes.sizeIndicator = size;
        <span class="keyword">return</span> {
            xIndicator: x,
            yIndicator: y,
            sizeIndicator: size
        };
    };
    <span class="keyword">return</span> {
        set: set,
        get: get,
        getDataHelper: getDataHelper,
        getAttributes: getAttributes,
        setIndicatorForInvalidState: setIndicatorForInvalidState,
        initialize: initialize,
        setInit: setInit
    };
};

gapminder.vizLine = <span class="function"><span class="keyword">function</span><span class="params">(callback)</span> {</span>
    <span class="keyword">var</span> scatterContainer;
    <span class="keyword">var</span> labelLayer;
    <span class="keyword">var</span> countryLayers;
    <span class="keyword">var</span> xScale;
    <span class="keyword">var</span> yScale;
    <span class="keyword">var</span> availableWidth;
    <span class="keyword">var</span> availableHeight;
    <span class="keyword">var</span> chartRenderDiv;
    <span class="keyword">var</span> vizState;
    <span class="keyword">var</span> isInteractive;
    <span class="keyword">var</span> labelAngel = <span class="string">"-0.5"</span>;
    <span class="keyword">var</span> labelPositionInteractive = <span class="string">"_50"</span>;
    <span class="keyword">var</span> vizChart;
    <span class="keyword">var</span> update = <span class="function"><span class="keyword">function</span><span class="params">(state)</span> {</span>
        vizState = state;
        updateLayout();
        createEntityLayers();
        renderLines();
        drawLabels();
    };
    <span class="keyword">var</span> initializeLayers = <span class="function"><span class="keyword">function</span><span class="params">(root, renderDiv, state)</span> {</span>
        chartRenderDiv = renderDiv + <span class="string">"-scatterChart"</span>;
        vizState = state;
        isInteractive = state.get(<span class="string">"isInteractive"</span>);
        vizChart = <span class="keyword">new</span> gapminder.viz.chartGrid();
        vizChart.initializeLayers(root, renderDiv);
    };
    <span class="keyword">var</span> updateLayout = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> scaleFunctions = vizChart.updateLayout(vizState);
        yScale = scaleFunctions[<span class="number">1</span>];
        <span class="keyword">var</span> availableFrame = vizChart.getAvailableHeightAndWidth();
        availableHeight = availableFrame[<span class="number">0</span>];
        availableWidth = availableFrame[<span class="number">1</span>];
        createXAxis();
        setUpChartInfoDivs();
    };
    <span class="keyword">var</span> createXAxis = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> xDomain = [ vizState.getDataHelper().getMinYear(), vizState.getDataHelper().getMaxYear() ];
        xScale = d3.scale.linear().domain(xDomain).range([ <span class="number">0</span>, availableWidth ]);
        <span class="keyword">var</span> xLabelText = <span class="string">"Time"</span>;
        <span class="keyword">var</span> xLabel = vizChart.getXLabel();
        <span class="keyword">var</span> margin = vizChart.getMargin();
        xLabel.attr(<span class="string">"text-anchor"</span>, <span class="string">"middle"</span>).attr(<span class="string">"transform"</span>, <span class="string">"translate("</span> + availableWidth / <span class="number">2</span> + <span class="string">","</span> + (availableHeight + margin.bottom * <span class="number">.6</span>) + <span class="string">")"</span>).attr(<span class="string">"font-size"</span>, <span class="string">"30px"</span>).text(xLabelText).append(<span class="string">"svg:title"</span>).text(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
            <span class="keyword">return</span> vizState.getDataHelper().getAxisInfo()[<span class="number">0</span>];
        });
        <span class="keyword">var</span> formatX = d3.format(<span class="string">"  0"</span>);
        <span class="keyword">var</span> xAxis = d3.svg.axis().scale(xScale).tickFormat(formatX).ticks(<span class="number">10</span>).tickSize(-availableHeight, <span class="number">0</span>, <span class="number">0</span>).tickPadding(<span class="number">5</span>).orient(<span class="string">"bottom"</span>);
        <span class="keyword">var</span> xAxisContainer = vizChart.getXAxisContainer();
        xAxisContainer.attr(<span class="string">"transform"</span>, <span class="string">"translate(0,"</span> + availableHeight + <span class="string">")"</span>).attr(<span class="string">"stroke"</span>, <span class="string">"lightgrey"</span>).classed(<span class="string">"print"</span>, !vizState.get(<span class="string">"isInteractive"</span>)).call(xAxis);
        d3.selectAll(<span class="string">"text"</span>).attr(<span class="string">"stroke-width"</span>, <span class="string">"0px"</span>).attr(<span class="string">"stroke"</span>, <span class="string">"black"</span>).attr(<span class="string">"font-size"</span>, <span class="string">"20px"</span>);
    };
    <span class="keyword">var</span> createEntityLayers = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        countryLayers = vizState.getDataHelper().getEntityLayerObject();
        <span class="keyword">var</span> entityLayers = d3.select(<span class="string">"#"</span> + chartRenderDiv + <span class="string">" .scatterContainer"</span>).selectAll(<span class="string">".entityLayer"</span>).data(countryLayers, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> d.id;
        });
        <span class="keyword">var</span> entityLayer = entityLayers.enter().append(<span class="string">"g"</span>).attr(<span class="string">"class"</span>, <span class="string">"entityLayer"</span>).attr(<span class="string">"name"</span>, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> d.id;
        }).attr(<span class="string">"id"</span>, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> d.id;
        });
        entityLayers.sort(<span class="function"><span class="keyword">function</span><span class="params">(a, b)</span> {</span>
            <span class="keyword">return</span> b.max - a.max;
        });
        entityLayers.exit().remove();
    };
    <span class="keyword">var</span> renderLines = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> year = vizState.get(<span class="string">"year"</span>);
        <span class="keyword">var</span> s = vizState.get(<span class="string">"s"</span>);
        <span class="keyword">var</span> opacity = vizState.get(<span class="string">"opacity"</span>);
        <span class="keyword">var</span> trails = vizState.get(<span class="string">"trails"</span>);
        <span class="keyword">var</span> category = vizState.get(<span class="string">"entity"</span>) || vizState.get(<span class="string">"category"</span>);
        <span class="keyword">var</span> yIndicator = vizState.get(<span class="string">"yIndicator"</span>);
        <span class="keyword">var</span> currentEntities = vizState.getDataHelper().getDataObject(yIndicator, year);
        <span class="keyword">var</span> line = d3.svg.line().x(<span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> xScale(d.x);
        }).y(<span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> yScale(d.y);
        }).interpolate(<span class="string">"linear"</span>);
        <span class="keyword">var</span> lines = d3.selectAll(<span class="string">".entityLayer"</span>).data(countryLayers, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> d &amp;&amp; d.id || d3.select(<span class="keyword">this</span>).attr(<span class="string">"id"</span>);
        }).selectAll(<span class="string">".currentEntity"</span>).data(<span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> [ currentEntities[d.id] ];
        });
        lines.enter().append(<span class="string">"svg:path"</span>).attr(<span class="string">"d"</span>, line).attr(<span class="string">"stroke"</span>, <span class="string">"black"</span>);
        lines.filter(<span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> d.length &gt; <span class="number">0</span>;
        }).attr(<span class="string">"stroke"</span>, <span class="string">"black"</span>).attr(<span class="string">"name"</span>, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> d.id;
        }).attr(<span class="string">"stroke-width"</span>, <span class="string">"0.8pt"</span>).attr(<span class="string">"stroke"</span>, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> vizState.getDataHelper().getColor(d[<span class="number">0</span>].id, <span class="string">"stroke"</span>, d[<span class="number">0</span>].category);
        }).attr(<span class="string">"fill"</span>, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> vizState.getDataHelper().getColor(d[<span class="number">0</span>].id, <span class="string">"fill"</span>, d[<span class="number">0</span>].category);
        }).attr(<span class="string">"pointer-events"</span>, <span class="string">"all"</span>).attr(<span class="string">"cursor"</span>, <span class="string">"pointer"</span>);
        lines.on(<span class="string">"mouseover"</span>, LineOverHandler).on(<span class="string">"mouseout"</span>, lineOutHandler);
        lines.exit().remove();
    };
    <span class="keyword">var</span> drawLabels = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> year = vizState.get(<span class="string">"year"</span>);
        <span class="keyword">var</span> trails = vizState.get(<span class="string">"trails"</span>);
        <span class="keyword">var</span> selected = vizState.get(<span class="string">"s"</span>);
        <span class="keyword">var</span> labelsData = addLabelsToSelectedBubbles(selected, year);
        <span class="keyword">var</span> labels = d3.select(<span class="string">"#"</span> + chartRenderDiv).select(<span class="string">".labelLayer"</span>).selectAll(<span class="string">".labelNode"</span>).data(labelsData, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> d.id;
        });
        <span class="keyword">var</span> labelContainer = labels.enter().append(<span class="string">"g"</span>).attr(<span class="string">"class"</span>, <span class="string">"labelNode"</span>).attr(<span class="string">"cursor"</span>, <span class="string">"pointer"</span>);
        labelContainer.append(<span class="string">"rect"</span>).attr(<span class="string">"cursor"</span>, <span class="string">"pointer"</span>).attr(<span class="string">"class"</span>, <span class="string">"labelBG"</span>);
        <span class="keyword">var</span> labelText = labelContainer.append(<span class="string">"text"</span>).attr(<span class="string">"class"</span>, <span class="string">"labelText"</span>).attr(<span class="string">"text-anchor"</span>, <span class="string">"middle"</span>).attr(<span class="string">"dominant-baseline"</span>, <span class="string">"central"</span>).attr(<span class="string">"font-family"</span>, <span class="string">"'Helvetica', sans-serif"</span>).attr(<span class="string">"x"</span>, <span class="string">"0"</span>).attr(<span class="string">"y"</span>, <span class="string">"0"</span>).attr(<span class="string">"font-size"</span>, <span class="string">"23px"</span>).attr(<span class="string">"pointer-events"</span>, <span class="string">"none"</span>).text(<span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> d.name;
        });
        labels.each(<span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">var</span> bbox = d3.select(<span class="keyword">this</span>).select(<span class="string">".labelText"</span>).node().getBBox();
            <span class="keyword">var</span> width = bbox.width;
            <span class="keyword">var</span> height = bbox.height;
            <span class="keyword">var</span> paddingWidth = <span class="number">8</span>;
            <span class="keyword">var</span> paddingHeight = <span class="number">8</span>;
            d3.select(<span class="keyword">this</span>).select(<span class="string">".labelBG"</span>).attr(<span class="string">"width"</span>, width + paddingWidth).attr(<span class="string">"height"</span>, height + paddingHeight).attr(<span class="string">"x"</span>, -width / <span class="number">2</span> - paddingWidth / <span class="number">2</span>).attr(<span class="string">"y"</span>, -height / <span class="number">2</span> - paddingWidth / <span class="number">2</span>).attr(<span class="string">"fill"</span>, <span class="string">"#fff"</span>).attr(<span class="string">"stroke"</span>, <span class="string">"#999"</span>).attr(<span class="string">"stroke-width"</span>, <span class="string">"2px"</span>).attr(<span class="string">"ry"</span>, <span class="string">"5px"</span>).attr(<span class="string">"rx"</span>, <span class="string">"5px"</span>);
            <span class="keyword">var</span> angle = -<span class="number">1</span> / <span class="number">4</span> * Math.PI;
            <span class="keyword">var</span> distanceFromPerimeter = <span class="number">50</span>;
            <span class="keyword">var</span> labelPos = d.labelPos;
            angle = parseFloat(labelPos.split(<span class="string">"_"</span>)[<span class="number">0</span>]);
            distanceFromPerimeter = parseFloat(labelPos.split(<span class="string">"_"</span>)[<span class="number">1</span>]);
            <span class="keyword">var</span> radius = bubbleSizeScale(d.size);
            <span class="keyword">var</span> bubbleX = xScale(d.x);
            <span class="keyword">var</span> bubbleY = yScale(d.y);
            <span class="keyword">var</span> perimeterX = bubbleX + radius * Math.cos(angle);
            <span class="keyword">var</span> perimeterY = bubbleY + radius * Math.sin(angle);
            <span class="keyword">var</span> labelCoordinates = {};
            labelCoordinates.x = bubbleX + (distanceFromPerimeter + radius) * Math.cos(angle);
            labelCoordinates.y = bubbleY + (distanceFromPerimeter + radius) * Math.sin(angle);
            <span class="keyword">var</span> preferredX = labelCoordinates.x;
            <span class="keyword">var</span> preferredY = labelCoordinates.y;
            labelCoordinates = fitWithinLabelConstraints(bbox, preferredX, preferredY);
            d.linkStartX = perimeterX;
            d.linkStartY = perimeterY;
            d.linkEndX = labelCoordinates.x;
            d.linkEndY = labelCoordinates.y;
            d3.select(<span class="keyword">this</span>).attr(<span class="string">"transform"</span>, <span class="string">"translate("</span> + labelCoordinates.x + <span class="string">","</span> + labelCoordinates.y + <span class="string">")"</span>);
        });
        labels.exit().remove();
        <span class="keyword">var</span> labelLinks = d3.select(<span class="string">"#"</span> + chartRenderDiv).select(<span class="string">".linkLayer"</span>).selectAll(<span class="string">".labelLink"</span>).data(labelsData, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> d.id;
        });
        labelLinks.enter().append(<span class="string">"svg:line"</span>).attr(<span class="string">"class"</span>, <span class="string">"labelLink"</span>).attr(<span class="string">"stroke"</span>, <span class="string">"#333"</span>).attr(<span class="string">"stroke-width"</span>, <span class="string">"1px"</span>);
        labelLinks.attr(<span class="string">"x1"</span>, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> d.linkStartX;
        }).attr(<span class="string">"y1"</span>, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> d.linkStartY;
        }).attr(<span class="string">"x2"</span>, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> d.linkEndX;
        }).attr(<span class="string">"y2"</span>, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span>
            <span class="keyword">return</span> d.linkEndY;
        });
        labelLinks.exit().remove();
    };
    <span class="keyword">var</span> LineOverHandler = <span class="function"><span class="keyword">function</span><span class="params">(d, i)</span> {</span>
        <span class="keyword">var</span> id = d.id;
        <span class="keyword">var</span> selected = vizState.get(<span class="string">"s"</span>);
        <span class="keyword">var</span> currentEntity;
        <span class="keyword">var</span> alreadySelected;
        d.year === vizState.get(<span class="string">"year"</span>) ? currentEntity = <span class="literal">true</span> : currentEntity = <span class="literal">false</span>;
        id <span class="keyword">in</span> selected ? alreadySelected = <span class="literal">true</span> : alreadySelected = <span class="literal">false</span>;
        <span class="keyword">if</span> (currentEntity &amp;&amp; alreadySelected) {
            <span class="keyword">return</span> <span class="literal">false</span>;
        }
        <span class="keyword">this</span>.overNode = d3.select(d3.event.target).node();
        <span class="keyword">var</span> overNode = d3.select(<span class="keyword">this</span>.overNode);
        <span class="keyword">var</span> nodeX = parseInt(overNode.attr(<span class="string">"cx"</span>));
        <span class="keyword">var</span> nodeY = parseInt(overNode.attr(<span class="string">"cy"</span>));
        <span class="keyword">var</span> nodeR = parseInt(overNode.attr(<span class="string">"r"</span>));
        <span class="keyword">var</span> nodeFill = overNode.attr(<span class="string">"fill"</span>);
        <span class="keyword">this</span>.highlightNode = <span class="keyword">this</span>.overNode.cloneNode(<span class="literal">true</span>);
        <span class="keyword">var</span> highlightNode = d3.select(<span class="keyword">this</span>.highlightNode).attr(<span class="string">"pointer-events"</span>, <span class="string">"none"</span>).attr(<span class="string">"class"</span>, <span class="string">"highlightNode"</span>).attr(<span class="string">"fill"</span>, <span class="string">"none"</span>).attr(<span class="string">"r"</span>, nodeR + <span class="number">5</span>).attr(<span class="string">"fill-opacity"</span>, <span class="number">1</span>).attr(<span class="string">"stroke-opacity"</span>, <span class="number">1</span>).attr(<span class="string">"stroke-width"</span>, <span class="string">"3px"</span>).attr(<span class="string">"stroke"</span>, nodeFill);
        d3.select(<span class="keyword">this</span>.overNode.parentNode.insertBefore(<span class="keyword">this</span>.highlightNode, <span class="keyword">this</span>.overNode.nextSibling));
        <span class="keyword">this</span>.highlightLabel = d3.select(<span class="string">"#"</span> + chartRenderDiv).select(<span class="string">".labelLayer"</span>).append(<span class="string">"g"</span>).attr(<span class="string">"class"</span>, <span class="string">"highlightLabel"</span>).attr(<span class="string">"pointer-events"</span>, <span class="string">"none"</span>);
        <span class="keyword">var</span> rectNode = <span class="keyword">this</span>.highlightLabel.append(<span class="string">"rect"</span>).attr(<span class="string">"class"</span>, <span class="string">"highlightBG"</span>);
        <span class="keyword">var</span> textNode = <span class="keyword">this</span>.highlightLabel.append(<span class="string">"text"</span>).attr(<span class="string">"x"</span>, <span class="string">"0px"</span>).attr(<span class="string">"y"</span>, <span class="string">"0px"</span>).attr(<span class="string">"font-size"</span>, <span class="string">"20px"</span>).attr(<span class="string">"class"</span>, <span class="string">"entityLabel"</span>).attr(<span class="string">"text-anchor"</span>, <span class="string">"middle"</span>).text(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
            <span class="keyword">var</span> text;
            currentEntity ? text = vizState.getDataHelper().getName(d[<span class="number">0</span>].id, d[<span class="number">0</span>].category) : text = vizState.getDataHelper().getName(d[<span class="number">0</span>].id);
            <span class="keyword">return</span> text;
        });
        <span class="keyword">var</span> textNodeBbox = textNode.node().getBBox();
        <span class="keyword">var</span> textNodeBBoxWidth = textNodeBbox.width;
        <span class="keyword">var</span> textNodeBBoxHeight = textNodeBbox.height;
        <span class="keyword">var</span> paddingWidth = <span class="number">8</span>;
        <span class="keyword">var</span> paddingHeight = <span class="number">8</span>;
        rectNode.attr(<span class="string">"width"</span>, textNodeBBoxWidth + paddingWidth).attr(<span class="string">"height"</span>, textNodeBBoxHeight + paddingHeight).attr(<span class="string">"x"</span>, -textNodeBBoxWidth / <span class="number">2</span> - paddingWidth / <span class="number">2</span>).attr(<span class="string">"y"</span>, -textNodeBBoxHeight / <span class="number">2</span> - paddingWidth / <span class="number">2</span>).attr(<span class="string">"fill"</span>, <span class="string">"#fff"</span>).attr(<span class="string">"stroke"</span>, nodeFill).attr(<span class="string">"stroke-width"</span>, <span class="string">"3px"</span>).attr(<span class="string">"ry"</span>, <span class="string">"5px"</span>).attr(<span class="string">"rx"</span>, <span class="string">"5px"</span>);
    };
    <span class="keyword">var</span> addLabelsToSelectedBubbles = <span class="function"><span class="keyword">function</span><span class="params">(selected, year)</span> {</span>
        <span class="keyword">var</span> labelsData = [];
        $.each(selected, <span class="function"><span class="keyword">function</span><span class="params">(key, object)</span> {</span>
            <span class="keyword">var</span> id = key;
            <span class="keyword">var</span> o = {};
            <span class="keyword">var</span> category = object.category;
            o.id = id;
            o.name = vizState.getDataHelper().getName(id, category);
            o.x = year;
            o.y = vizState.getDataHelper().get(vizState.get(<span class="string">"yIndicator"</span>), id, year, vizState, category);
            <span class="keyword">if</span> (<span class="string">"labelPos"</span> <span class="keyword">in</span> object) {
                o.labelPos = object.labelPos;
            } <span class="keyword">else</span> {
                o.labelPos = labelAngel + labelPositionInteractive;
            }
            <span class="keyword">if</span> (o.x &amp;&amp; o.y) {
                labelsData.push(o);
            }
        });
        <span class="keyword">return</span> labelsData;
    };
    <span class="keyword">var</span> lineOutHandler = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        d3.select(<span class="string">"#"</span> + chartRenderDiv).selectAll(<span class="string">".highlightNode"</span>).remove();
        d3.select(<span class="string">"#"</span> + chartRenderDiv).selectAll(<span class="string">".highlightLabel"</span>).remove();
    };
    <span class="keyword">var</span> setUpChartInfoDivs = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        $(<span class="string">"#chartInfo"</span>).html(vizState.getDataHelper().getChartInfo()).css({
            <span class="string">"font-size"</span>: <span class="number">13</span>
        });
        $(<span class="string">"#chartFooter"</span>).html(<span class="string">"&lt;b&gt;Source&lt;/b&gt;:"</span> + vizState.getDataHelper().getChartFooter()).css({
            <span class="string">"font-size"</span>: <span class="number">13</span>
        });
    };
    <span class="keyword">return</span> {
        initialize: initializeLayers,
        updateLayout: updateLayout,
        update: update
    };
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
